
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="http://www.jieyu.ai/zillionare/diveintozillionare/developer_guide/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-8.5.10">
    
    
      
        <title>Developer guide - 大富翁量化</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.2505c338.min.css">
        
          
          
          <meta name="theme-color" content="#02a6f2">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="light-blue" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#大富翁产品矩阵" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="大富翁量化" class="md-header__button md-logo" aria-label="大富翁量化" data-md-component="logo">
      
  <img src="../../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            大富翁量化
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Developer guide
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/zillionare/zillionare" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    zillionare
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      首页
    </a>
  </li>

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../coursea/cheese/intro/" class="md-tabs__link">
        课程
      </a>
    </li>
  

  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../products/" class="md-tabs__link">
      产品
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../jupyter/" class="md-tabs__link">
      在线量化环境
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../contact/" class="md-tabs__link">
      联系我们
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="https://www.zhihu.com/people/hbaaron" class="md-tabs__link">
      知乎
    </a>
  </li>

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="大富翁量化" class="md-nav__button md-logo" aria-label="大富翁量化" data-md-component="logo">
      
  <img src="../../../assets/logo.png" alt="logo">

    </a>
    大富翁量化
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/zillionare/zillionare" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    zillionare
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        首页
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          课程
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="课程" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          课程
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2_1">
          大富翁量化金融实战
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="大富翁量化金融实战" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          大富翁量化金融实战
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../coursea/cheese/intro/" class="md-nav__link">
        简介
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../coursea/cheese/outline/" class="md-nav__link">
        大纲
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://zillionare.github.io/best-practice-python/" class="md-nav__link">
        Python能做大项目
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../products/" class="md-nav__link">
        产品
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../jupyter/" class="md-nav__link">
        在线量化环境
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../contact/" class="md-nav__link">
        联系我们
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://www.zhihu.com/people/hbaaron" class="md-nav__link">
        知乎
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#大富翁产品矩阵" class="md-nav__link">
    大富翁产品矩阵
  </a>
  
    <nav class="md-nav" aria-label="大富翁产品矩阵">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zillionare" class="md-nav__link">
    Zillionare
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omega" class="md-nav__link">
    Omega
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omicron" class="md-nav__link">
    Omicron
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#11-操作系统和ide" class="md-nav__link">
    1.1 操作系统和IDE
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-虚拟运行环境" class="md-nav__link">
    1.2 虚拟运行环境
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-工程模板" class="md-nav__link">
    1.3 工程模板
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-文档构建" class="md-nav__link">
    1.4 文档构建
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#21-代码风格" class="md-nav__link">
    2.1 代码风格
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-linting" class="md-nav__link">
    2.2 linting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#31-unittest" class="md-nav__link">
    3.1 unittest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-pytest" class="md-nav__link">
    3.2 pytest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-coverage" class="md-nav__link">
    3.3 coverage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-tox" class="md-nav__link">
    3.4 tox
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-开发流程" class="md-nav__link">
    4. 开发流程
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/zillionare/zillionare/edit/master/docs/zillionare/diveintozillionare/developer_guide.md" title="编辑此页" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


  <h1>Developer guide</h1>

<h2 id="大富翁产品矩阵">大富翁产品矩阵<a class="headerlink" href="#大富翁产品矩阵" title="Permanent link">&para;</a></h2>
<h3 id="zillionare">Zillionare<a class="headerlink" href="#zillionare" title="Permanent link">&para;</a></h3>
<p>统领大富翁各个子项目。Zillionare的一些功能往往是多个组件服务共同完成的，这些组件都有自己的版本编号，我们通过统一发布容器化部署版本的方式，将功能发布以一个完整、单一的视图呈现给用户。</p>
<p>除了容器化部署版本之外，您还可以在这里找到帮助文档和教程。</p>
<h3 id="omega">Omega<a class="headerlink" href="#omega" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/zillionare/omega&gt;">Omega</a> 是基于Sanic构建的微服务，它通过行情适配器来收发数据，通过Omicron来将这些数据存储到本地。Omega也是行情同步任务的管理者。</p>
<p>通过前置Nginx，就可以负载均衡的方式提供分布式行情数据服务。此外，Omega还通过消息服务实现多进程之间的任务协作。这些进程可以运行在局域网内的不同的机器上。</p>
<p><a href="https://zillionare-omega.readthedocs.io/zh_CN/latest">使用文档</a> <a href="https://github.com/zillionare/omega">项目地址</a></p>
<h3 id="omicron">Omicron<a class="headerlink" href="#omicron" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/zillionare/omicron&gt;">Omicron</a> 提供了数据的本地存储读写和其它基础功能，比如交易日历和时间，Triggers，类型定义等。它是zillionare各子项目依赖的数据访问sdk。在您安装了Omega服务器之后，就通过Omicron这个sdk来使用行情数据。</p>
<p><a href="https://zillionare-omicron.readthedocs.io/zh_CN/latest/&gt;">使用文档</a> <a href="https://github.com/zillionare/omicron">项目地址</a></p>
<p>=========
开发指南
=========</p>
<p>本文档适用于Zillionare系列项目的协同开发者。</p>
<p>这一章详细讲解了大富翁的开发工具链，多数情况下，我们还讲述了选择这些工具的理由。</p>
<p>如果您参与开发大富翁相关项目，您很可能不需要从头配置这些工具链，因为相关的配置文件都会随代码clone时下载到本地，您只需要运行 <code>pip install -r requirements_dev.txt</code> , 绝大多数工具就完成了配置，只有两个例外：</p>
<ol>
<li>您需要运行 <code>pre-commit install</code> 来完成pre-commit hooks的安装</li>
<li>您需要设置IDE，使之在代码保存时，自动运行lint工具。</li>
</ol>
<p>尽管如此，理解我们为何选择这些工具，各项配置又如何起作用，在多人协作项目中，仍然是十分重要的。所以，我们推荐大富翁的协同开发者在进入开发之前，认真阅读这一章。Zillionare项目尽可能遵循Python工程最佳实践。我们通过采用社区内广泛认可的各种工具来保证实现最佳实践。因此，熟悉了本章的内容，也可以认为就熟练掌握了Python工程最佳实践。</p>
<p>.. hint::</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code>Poetry已经是官方推荐的构建工具。但大富翁项目中并未使用Poetry。
原因有二：

1. Poetry目前（2020年11月）还有较严重的性能 `bug &lt;https://github.com/python-poetry/poetry/issues/2094&gt;`_，在进行依赖解析时，一次运行可以长达半小时或者更久。这个问题可能由多重原因引起，也包括部分问题只出现在中国大陆；所以预期这个问题难以在短时间内完全解决。为避免降低开发效率，目前我们不推荐使用Poetry。

2. 整个社区还没有准备好。Poetry的目标是成为all-in-one的配置工具，但整个社区还需要一定的时间，使得各种依赖包、代码检查工具、测试工具等都准备好。
</code></pre></div></td></tr></table></div>
<ol>
<li>开发环境和工具
`````````````````</li>
</ol>
<p>关于开发环境和工具的使用，可以参考解语科技的博客文章 <code>windows下如何构建Python开发环境 &lt;http://blog.jieyu.ai/blog_2020/%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BAPython%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/&gt;</code>_。</p>
<h3 id="11-操作系统和ide">1.1 操作系统和IDE<a class="headerlink" href="#11-操作系统和ide" title="Permanent link">&para;</a></h3>
<p>项目中使用的库和测试用例，均只保证在Linux下正确和高效运行。因此，推荐使用Windows + Linux的混合式开发环境，或者您可以使用Win10 + WSL的方式进行开发。不推荐使用纯粹的Windows进行开发。</p>
<p>.. csv-table:: 软件清单
    :header: "软件类别","软件","版本","说明"
    :widths: 20, 15, 15, 15</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code>操作系统,Ubuntu/WSL,18.04,
IDE,vscode/pycharm,,pycharm专业版，以便远程调试
运行时,Python,3.8,
内存数据库,Redis,&gt;4.0,
数据库,Postgres,&gt;10,存放市值数据
负载均衡,Nginx,,选装
行情服务,jqdatasdk,&gt;1.8,
日志服务,rsyslog,,在生产环境下使用
容器,docker,,用于模拟生产环境部署
</code></pre></div></td></tr></table></div>
<h3 id="12-虚拟运行环境">1.2 虚拟运行环境<a class="headerlink" href="#12-虚拟运行环境" title="Permanent link">&para;</a></h3>
<p>每一个子项目，都应该在其对应的虚拟环境下运行。比如，开发Omega时，需要新建一个Omega的开发环境，将所有的依赖库均只安装到这个虚拟环境中（并且根据需要添加到setup.py中）。</p>
<p>推荐使用miniconda来构建虚拟环境。但项目中使用tox，所以virtual env也在使用之中。</p>
<h3 id="13-工程模板">1.3 工程模板<a class="headerlink" href="#13-工程模板" title="Permanent link">&para;</a></h3>
<p>创建新的工程时，我们往往有一堆繁琐的搭架子的工作。一些IDE或者应用框架为此提供了相应的开发模板。在大富翁开发中，我们使用 Cookiecutter_ 库来创建新应用的基本框架。Cookiecutter_会为我们生成文档框架(Shpinx构建系统，各种文档模板）、多版本测试（Tox）、CI集成（Travis, code coverage)、版本发布（Twine，pypi等）。要完全从头开始手工配置所有这些工具，并使之协同工作是需要花较多时间的。</p>
<p>Omega, Omicron, Omega-jqadaptor等子项目都是通过 Cookiecutter_ 来创建的。如果需要创建新的子项目，推荐仍使用 Cookiecutter_ 来创建，以保证新的项目有同样的开发发布流程和质量标准。</p>
<p>在Cookiecutter创建模板时，还会指定是否创建Console script，并且推荐使用Click作为命令行工具的开发框架。在大富翁项目中，我们不使用Click，而是使用google出品的fire框架。Fire上手更容易，代码量更少。</p>
<h3 id="14-文档构建">1.4 文档构建<a class="headerlink" href="#14-文档构建" title="Permanent link">&para;</a></h3>
<p>使用reStructuredTxt文档格式，并使用Sphinx来构建。构建的文档发布到 <code>readthedocs &lt;https://readthedocs.org/&gt;</code>_。</p>
<p>对于docstring，约定统一使用 <code>google style &lt;https://sphinxcontrib-napoleon.readthedocs.io/en/latest/example_google.html&gt;</code>_。</p>
<p>我们使用doc8来对文档时行测试。在tox中进行配置，详见本章中tox一节。</p>
<ol>
<li>代码质量
```````````````
大富翁通过约定代码风格、强制代码检查、集成测试、测试覆盖率等手段来保证代码质量。</li>
</ol>
<h3 id="21-代码风格">2.1 代码风格<a class="headerlink" href="#21-代码风格" title="Permanent link">&para;</a></h3>
<ol>
<li>使用空格而不是制表键来实现缩进</li>
<li>缩进大小为4</li>
<li>换行符始终为lf</li>
<li>每行长度最大不超88个字符</li>
</ol>
<p>在大富翁的每一个子项目的根目录里，都有一个.editorconfig文件，用以约定上述规范:</p>
<p>.. code::</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code># .editorconfig

# http://editorconfig.org

root = true

[*]
indent_style = space
indent_size = 4
trim_trailing_whitespace = true
insert_final_newline = true
charset = utf-8
end_of_line = lf

[*.bat]
indent_style = tab
end_of_line = crlf

[LICENSE]
insert_final_newline = false

[Makefile]
indent_style = tab
</code></pre></div></td></tr></table></div>
<p>对于Python文件，我们使用<code>black &lt;https://github.com/psf/black&gt;</code>_ 来强制代码风格。</p>
<h3 id="22-linting">2.2 linting<a class="headerlink" href="#22-linting" title="Permanent link">&para;</a></h3>
<p>大富翁在开发过程中，要求开发者在三个时机都进行代码检查。</p>
<p>第一个时机是保存代码时。需要设置您的IDE在保存代码时自动进行代码检查和格式化。如果您使用vscode，则应该按如下方式设置：</p>
<p>.. code::</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code># settings.json
&quot;editor.codeActionsOnSave&quot;: {
    &quot;source.fixAll&quot;: true,
    &quot;source.sortImports&quot;: true
},
&quot;editor.formatOnPaste&quot;: true,
&quot;editor.formatOnSave&quot;: true,
</code></pre></div></td></tr></table></div>
<p>第二个时机是在提交代码时。大富翁的每一个子项目，都要求设置pre-commit hook：</p>
<p>pre-commit是一个Python库，安装后，您需要运行 <code>pre-commit install</code> 命令，并在工程根目录下放置如下配置文件：</p>
<p>.. code::</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div><pre><span></span><code># .pre-commit-config.yaml
repos:
-   repo: https://github.com/pre-commit/mirrors-isort
    rev: v4.3.21
    hooks:
    - id: isort
    exclude: docs/conf.py
-   repo: https://github.com/ambv/black
    rev: stable
    hooks:
    - id: black
-   repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v2.3.0
    hooks:
    - id: flake8
</code></pre></div></td></tr></table></div>
<p>根据上述配置，每次您在提交代码前，git将自动运行isort, black和flake8。</p>
<p>2.2.1 isort
::::::::::::</p>
<p>isort是一个Python imports整理工具。它执行Python imports段的格式化、以及import的排序。它不能移虽导入、但未使用的import库。</p>
<p>如果您使用vscode，flake8会报告未使用的导入错误，然后您需要手动移除它（不要使用autoflake)_。
如果您使用Pycharm，Pycharm会提示并自动移除import错误。</p>
<p>我们使用工程根目录下的.isort.cfg来配置：</p>
<p>..code::</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code># .isort.cfg
[settings]
    multi_line_output = 3
    include_trailing_comma = True
    force_grid_wrap = 0
    use_parentheses = True
    ensure_newline_before_comments = True
    line_length = 88

    # 不检查docs/下的conf.py，这个文件中有一个不规范的导入，是必须的
    skip_glob = docs/conf.py
</code></pre></div></td></tr></table></div>
<p>2.2.2 black
::::::::::::</p>
<p>black是一个Python代码格式化工具，相比其它代码格式化工具，以其代码风格强制统一、毫不妥协著称。它惟一能配置的选项就是每行最大字符数。在大富翁项目中，我们也使用其默认的88个字符。因此，对于black，无须任何配置即可使用。</p>
<p>2.2.3 flake8
:::::::::::::</p>
<p>大富翁选择flake8作为lint工具，而不使用pylint。在某些方面，pylint甚至表现比flake8更好。但在vscode中进行开发时，如果启用了pylance（推荐使用），pylance也会报一些lint相关的错误，pylint也会在同样位置报告lint错误。如果该错误经确认需要supress，则需要在同一行同时使用两种不同的语法来supress这个错误。而Pylint的语法比较繁琐（虽然更清晰），很容易导致行超长。</p>
<p>另外，pylint报告的错误信息过多，也会一定程度上使程序员陷入各种“纠错”中，但这些错误不见得真的就成为问题，因此影响了开发的效率，收获并不大。</p>
<p>我们通过在工程根目录下放置.flake8文件来进行配置，内容如下（注意有一部分是为了解决与black的兼容性问题）：</p>
<p>.. code::</p>
<p>[flake8]
    # required by black, https://github.com/psf/black/blob/master/.flake8
    max-line-length = 88
    max-complexity = 18
    extend-ignore = E203, E266, E501
    select = B,C,E,F,W,T4,B9
    per-file-ignores =
        <strong>init</strong>.py:F401
    exclude =
        .git,
        <strong>pycache</strong>,
        setup.py,
        build,
        dist,
        releases,
        .venv,
        .tox,
        .mypy_cache,
        .pytest_cache,
        .vscode,
        .github,
        docs/conf.py,
        tests</p>
<p>第三个时机则是在使用tox进行测试时，其配置我们留到tox这一节再讲。</p>
<ol>
<li>测试
````````````
在大富翁中，我们使用这些工具来进行单元测试：</li>
</ol>
<h3 id="31-unittest">3.1 unittest<a class="headerlink" href="#31-unittest" title="Permanent link">&para;</a></h3>
<p>unittest、pytest和nose是Python中常用的单元测试框架。因为unittest是标准库的一部分，所以大富翁使用unittest来写单元测试用例。如果有必要，未来也可能更改为pytest。使用pytest作为测试工具现在更为流行。</p>
<h3 id="32-pytest">3.2 pytest<a class="headerlink" href="#32-pytest" title="Permanent link">&para;</a></h3>
<p>大富翁使用pytest作为单元测试的运行工具。我们一般不单独运行pytest，而是通过tox来调用。</p>
<h3 id="33-coverage">3.3 coverage<a class="headerlink" href="#33-coverage" title="Permanent link">&para;</a></h3>
<p>大富翁使用coverage和py-cov来衡量单元测试的覆盖率。通过在工程根目录下放置.coveragerc文件来实现对其配置：</p>
<p>.. code::</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code># .coveragerc
[run]
omit =
    */config/schema.py
[report]
exclude_lines =
    pragma: no cover
    def __repr__
    if self.debug:
    if settings.DEBUG
    raise AssertionError
    raise NotImplementedError
    if 0:
    if __name__ == .__main__.:
</code></pre></div></td></tr></table></div>
<p>上述配置是大富翁推荐的默认配置。其中config/schema.py是配置的schema文件，由cfg4py自动生成，无须测试。</p>
<h3 id="34-tox">3.4 tox<a class="headerlink" href="#34-tox" title="Permanent link">&para;</a></h3>
<p>大富翁使用 <code>tox &lt;https://tox.readthedocs.io/en/latest/&gt;</code>_ 来管理集成测试。大富翁中使用tox.ini来配置：</p>
<p>.. code::</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td><td class="code"><div><pre><span></span><code># tox.ini
[tox]
envlist = py38, lint

[travis]
python =
    3.8: py38

[testenv:lint]
basepython = python
deps =
    flake8
    doc8
    black
commands =
    black omega tests
    flake8 omega tests
    doc8 docs

[testenv]
basepython = python
deps =
    pytest
    pytest-cov

setenv =
    PYTHONPATH = {toxinidir}
    PYTHONWARNINGS = ignore
passenv = *

commands =
    pip install -r requirements_dev.txt
    pytest --cov=omega --cov-append --cov-report=term-missing --cov-config \
    .coveragerc tests
</code></pre></div></td></tr></table></div>
<p>上述配置要求在运行tox时，对代码再进行一次检查（见lint一节）。这里请注意我们使用了doc8来对文档进行检查。</p>
<p>配置还要求在使用pytest运行测试时，对代码进行覆盖率检查。通过--cov-conig=.coveragerc来传入配置。</p>
<h3 id="4-开发流程">4. 开发流程<a class="headerlink" href="#4-开发流程" title="Permanent link">&para;</a></h3>
<p>如果您有意愿参与大富翁项目的开发，请从主分支上fork为自己的分支，完成功能开发、单元测试之后，发出merge requst，项目的owner经评估之后，将会及时merge回主分支。</p>
<p>.. _Cookiecutter: https://github.com/audreyr/cookiecutter
.. _Cookiecutter-pypackage: https://github.com/audreyr/cookiecutter-pypackage</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    <a href="https://www.zhihu.com/people/hbaaron" target="_blank" rel="noopener" title="知乎" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M170.54 148.13v217.54l23.43.01 7.71 26.37 42.01-26.37h49.53V148.13H170.54zm97.75 193.93h-27.94l-27.9 17.51-5.08-17.47-11.9-.04V171.75h72.82v170.31zm-118.46-94.39H97.5c1.74-27.1 2.2-51.59 2.2-73.46h51.16s1.97-22.56-8.58-22.31h-88.5c3.49-13.12 7.87-26.66 13.12-40.67 0 0-24.07 0-32.27 21.57-3.39 8.9-13.21 43.14-30.7 78.12 5.89-.64 25.37-1.18 36.84-22.21 2.11-5.89 2.51-6.66 5.14-14.53h28.87c0 10.5-1.2 66.88-1.68 73.44H20.83c-11.74 0-15.56 23.62-15.56 23.62h65.58C66.45 321.1 42.83 363.12 0 396.34c20.49 5.85 40.91-.93 51-9.9 0 0 22.98-20.9 35.59-69.25l53.96 64.94s7.91-26.89-1.24-39.99c-7.58-8.92-28.06-33.06-36.79-41.81L87.9 311.95c4.36-13.98 6.99-27.55 7.87-40.67h61.65s-.09-23.62-7.59-23.62v.01zm412.02-1.6c20.83-25.64 44.98-58.57 44.98-58.57s-18.65-14.8-27.38-4.06c-6 8.15-36.83 48.2-36.83 48.2l19.23 14.43zm-150.09-59.09c-9.01-8.25-25.91 2.13-25.91 2.13s39.52 55.04 41.12 57.45l19.46-13.73s-25.67-37.61-34.66-45.86h-.01zM640 258.35c-19.78 0-130.91.93-131.06.93v-101c4.81 0 12.42-.4 22.85-1.2 40.88-2.41 70.13-4 87.77-4.81 0 0 12.22-27.19-.59-33.44-3.07-1.18-23.17 4.58-23.17 4.58s-165.22 16.49-232.36 18.05c1.6 8.82 7.62 17.08 15.78 19.55 13.31 3.48 22.69 1.7 49.15.89 24.83-1.6 43.68-2.43 56.51-2.43v99.81H351.41s2.82 22.31 25.51 22.85h107.94v70.92c0 13.97-11.19 21.99-24.48 21.12-14.08.11-26.08-1.15-41.69-1.81 1.99 3.97 6.33 14.39 19.31 21.84 9.88 4.81 16.17 6.57 26.02 6.57 29.56 0 45.67-17.28 44.89-45.31v-73.32h122.36c9.68 0 8.7-23.78 8.7-23.78l.03-.01z"/></svg>
    </a>
  
    
    
    <a href="https://github.com/zillionare" target="_blank" rel="noopener" title="Github" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    <a href="mailto: aaron_yang@jieyu.ai" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m20 8-8 5-8-5V6l8 5 8-5m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2Z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.indexes", "navigation.tabs", "navigation.instant", "navigation.tabs.sticky"], "search": "../../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\s\\-\uff0c\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
    
    
  </body>
</html>