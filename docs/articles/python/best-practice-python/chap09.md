---
title: 09 æŒç»­é›†æˆ
---

å½“ä¸€ç»„å¼€å‘è€…å…±åŒå¼€å‘ä¸€ä¸ªé¡¹ç›®æ—¶ï¼Œå„ç§å†²çªä¼¼ä¹ä¸å¯é¿å…ã€‚æˆ‘ä»¬åœ¨ç¬¬ 8 ç« ä»‹ç»äº†åˆ†æ”¯å’Œ gitflow å·¥ä½œæµæ¨¡å‹ï¼Œä»è€Œè§£å†³äº†ä»£ç å†²çªçš„é—®é¢˜ã€‚ä½†æ˜¯ï¼Œä»£ç åˆå¹¶åªèƒ½è¾¾åˆ°è¡¨é¢ä¸Šçš„å’Œè°ã€‚ä¸åŒçš„äººå¼€å‘çš„ä»£ç èƒ½å¦ååŒå·¥ä½œï¼Œæœ€ç»ˆè¿˜å¾—é€šè¿‡æµ‹è¯•æ¥æ£€éªŒã€‚

åœ¨å·²ç»ä»‹ç»è¿‡çš„å¼€å‘æµç¨‹ä¸­ï¼Œå¼€å‘è€…åœ¨ç­¾å…¥ä»£ç å¹¶æ¨é€åˆ°è¿œç¨‹æœåŠ¡å™¨ä¹‹å‰ï¼Œåº”è¯¥é€šè¿‡ tox æ‰§è¡Œçš„å•å…ƒæµ‹è¯•å’Œä»£ç æ£€æŸ¥ã€‚ä½†æ˜¯ï¼Œå¦‚æœå¼€å‘è€…æœ‰æ„å¿½ç•¥è¿™äº›æ­¥éª¤ï¼Œä¸è‰¯ä»£ç ä»ç„¶èƒ½æºœè¿›ä»“åº“ã€‚æ­¤å¤–ï¼Œå°½ç®¡æˆ‘ä»¬è™šæ‹ŸåŒ–äº†æµ‹è¯•ç¯å¢ƒï¼Œä½†ä»ç„¶æœ‰å¯èƒ½åœ¨ä¸€åå¼€å‘è€…æœºå™¨ä¸Šé€šè¿‡çš„æµ‹è¯•ï¼Œä¸èƒ½åœ¨å¦ä¸€ä¸ªç¯å¢ƒé‡Œè¿è¡Œã€‚æ¯”å¦‚ï¼Œå¯èƒ½å¼•å…¥äº†æ–°çš„é…ç½®é¡¹ï¼Œè¿™äº›é…ç½®é¡¹å­˜åœ¨äºæœ¬åœ°ç¯å¢ƒï¼Œä½†å…¶å®ƒäººå¹¶ä¸çŸ¥é“ï¼›æˆ–è€…æ›´æ”¹äº†æœ¬åœ°æ•°æ®åº“ï¼Œä½†ç›¸åº”çš„å˜æ›´è„šæœ¬å¹¶æ²¡æœ‰é›†æˆè¿›æ¥ï¼Œç­‰ç­‰ã€‚å¦‚æœåªè¦æœ‰æ–°çš„ä»£ç ç­¾å…¥ï¼Œå°±èƒ½åœ¨ä¸€å°å…¬å…±æœºå™¨ä¸Šè‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰æµ‹è¯•ä»¥ç¡®ä¿ä»£ç æ­£ç¡®æ€§ï¼Œæ˜¾ç„¶å¯ä»¥æ›´æ—©åœ°å‘ç°é—®é¢˜ï¼Œé™ä½åæœŸç»´æŠ¤æˆæœ¬ã€‚è¿™å°±æ˜¯æŒç»­é›†æˆçš„æ„ä¹‰æ‰€åœ¨ã€‚

æŒç»­é›†æˆæ˜¯ä¸€ç§ DevOps è½¯ä»¶å¼€å‘å®è·µã€‚é‡‡ç”¨æŒç»­é›†æˆæ—¶ï¼Œå¼€å‘äººå‘˜ä¼šå®šæœŸå°†ä»£ç å˜æ›´åˆå¹¶åˆ°ä¸€ä¸ªä¸­å¤®å­˜å‚¨åº“ä¸­ï¼Œä¹‹åç³»ç»Ÿä¼šè‡ªåŠ¨è¿è¡Œæ„å»ºå’Œæµ‹è¯•æ“ä½œã€‚æŒç»­é›†æˆé€šå¸¸æ˜¯æŒ‡è½¯ä»¶å‘å¸ƒæµç¨‹çš„æ„å»ºæˆ–é›†æˆé˜¶æ®µï¼Œéœ€è¦ç”¨åˆ°è‡ªåŠ¨åŒ–ç»„ä»¶ï¼ˆä¾‹å¦‚ CI æˆ–æ„å»ºæœåŠ¡ï¼‰å’Œæ–‡åŒ–ç»„ä»¶ï¼ˆæŒ‡ç»„ç»‡çš„æµç¨‹å’Œè§„èŒƒç­‰ï¼Œä¾‹å¦‚å­¦ä¹ é¢‘ç¹åœ°é›†æˆï¼‰ã€‚æŒç»­é›†æˆçš„ä¸»è¦ç›®æ ‡æ˜¯æ›´å¿«å‘ç°å¹¶è§£å†³ç¼ºé™·ï¼Œæé«˜è½¯ä»¶è´¨é‡ï¼Œå¹¶å‡å°‘éªŒè¯å’Œå‘å¸ƒæ–°è½¯ä»¶æ›´æ–°æ‰€éœ€çš„æ—¶é—´ã€‚

!!! Info
    æŒç»­é›†æˆå¼ºè°ƒçš„æ–‡åŒ–æ˜¯ï¼šFail fast, fail oftenã€‚ä½†å®é™…ä¸Šï¼Œä¸€æ—¦æ„å»ºèµ·è‰¯å¥½çš„ CI/CD æµæ°´çº¿å’Œæ–‡åŒ–ï¼Œæœ€ç»ˆæˆ‘ä»¬å¾—åˆ°çš„å°†æ˜¯ Move fast and don't break thingsã€‚

## 1. ç›˜ç‚¹ CI è½¯ä»¶å’Œåœ¨çº¿æœåŠ¡
æˆ‘ä»¬å…ˆæ¥è®¤è¯†ä¸€ä¸‹æŒç»­é›†æˆé¢†åŸŸçš„å¤´éƒ¨ç©å®¶ã€‚Jekins æ˜¯æŒç»­é›†æˆé¢†åŸŸçš„è€å¤§å“¥ï¼ŒJenkins è‡ªè¯ç”Ÿä¹‹æ—¥èµ·ï¼Œè‡³ä»Šå·²å‘å±•äº†è¿‘ 20 å¹´ï¼Œç¤¾åŒºã€ç”Ÿæ€æœ€ä¸ºå®Œå–„ã€‚Gitlab æœ€åˆæ˜¯åŸºäº Git çš„ä»£ç æ‰˜ç®¡å¹³å°ï¼Œè‡ªç‰ˆæœ¬ 8.0 èµ·ï¼Œå¼€å§‹æä¾›æŒç»­é›†æˆåŠŸèƒ½ã€‚å…¶ä¼˜ç‚¹æ˜¯ä¸ä»£ç ä»“åº“æ— ç¼é›†æˆï¼ŒåŸç”Ÿåœ°æ”¯æŒä»£ç ä»“åº“å„ç±»äº‹ä»¶è§¦å‘æµæ°´çº¿ã€‚ä¸è¶³ä¹‹å¤„æ˜¯ï¼Œæ— è®º Jekins è¿˜æ˜¯ Gitlabï¼Œéƒ½éœ€è¦è‡ªå·±æ­å»ºæœåŠ¡å™¨ï¼Œè¿™å¯¹äºå¼€æºé¡¹ç›®å’Œä¸ªäººå¼€å‘è€…æ¥è¯´ï¼Œæˆæœ¬å¤ªé«˜äº†ã€‚

æ„å»º CI æœåŠ¡å™¨çš„æˆæœ¬æ˜¯æ˜‚è´µçš„ã€‚åœ¨è™šæ‹Ÿæœºæ²¡æœ‰å¹¿æ³›åº”ç”¨ä¹‹å‰ï¼Œè¿™ä¸ªæˆæœ¬å°±æ›´ä¸ºæ˜‚è´µã€‚ä½ éœ€è¦ä¸ºä½ çš„åº”ç”¨å°†è¦éƒ¨ç½²åˆ°çš„æ¯ä¸€ç§æ“ä½œç³»ç»Ÿè‡³å°‘å‡†å¤‡ä¸€å°æœºå™¨ã€‚å¦‚æœä½ çš„åº”ç”¨éœ€è¦éƒ¨ç½²åˆ°ä» windows åˆ° Linux åˆ° Macos ä¸Šçš„å„ä¸ªç‰ˆæœ¬ï¼Œä½ å¯èƒ½å°±éœ€è¦å‡†å¤‡è‡³å°‘åå°ä»¥ä¸Šçš„æœºå™¨ç¡¬ä»¶ã€‚è™šæ‹ŸåŒ–çš„å‡ºç°å¤§å¤§é™ä½äº† CI çš„æˆæœ¬ï¼Œéšåæ˜¯å®¹å™¨åŒ–çš„å‡ºç°ï¼Œè¿›ä¸€æ­¥é™ä½äº† CI çš„æˆæœ¬ã€‚ä½†æ˜¯ï¼Œå³ä¾¿æ˜¯è¿™æ ·ï¼Œå¯¹å¼€æºé¡¹ç›®ï¼Œè‡ªè¡Œæ­å»ºå’Œç»´æŠ¤ CI æœåŠ¡å™¨çš„æˆæœ¬ä»ç„¶æ˜¯æ˜‚è´µçš„ã€‚æ¯”å¦‚ï¼Œå¦‚æœä½ çš„åº”ç”¨éœ€è¦éƒ¨ç½²åˆ° MacOs ä¸Šï¼Œä½ å¿…é¡»è‡³å°‘æœ‰ä¸€åˆ°å¤šå°è‹¹æœçš„æœåŠ¡å™¨ï¼Œå› ä¸ºå…¶å®ƒæœºå™¨ä¸Šéƒ½æ— æ³•è™šæ‹ŸåŒ–å‡ºæ¥ macos çš„å®¹å™¨ã€‚

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬æ¨èä½¿ç”¨åœ¨çº¿ CI æœåŠ¡çš„åŸå› ã€‚å¥½æ¶ˆæ¯æ˜¯ï¼Œå¯¹å¼€æºé¡¹ç›®ï¼Œæœ‰ç›¸å½“å¤šçš„åœ¨çº¿ CI æœåŠ¡æ˜¯å…è´¹çš„ã€‚è¿™é‡Œæˆ‘ä»¬ä»…ä»…ä»‹ç» Travis CI å’Œ Github Actionsã€‚

Travis CI æ˜¯ä¸€ä¸ªåŸºäºäº‘çš„æŒç»­é›†æˆæœåŠ¡ï¼Œå®ƒå¯ä»¥å¸®åŠ©å¼€å‘è€…åœ¨ Github ä¸Šæ„å»ºå’Œæµ‹è¯•ä»£ç ï¼Œä»è€Œå‡å°‘å‘å¸ƒè½¯ä»¶çš„æ—¶é—´ã€‚Travis CI ä¸ºå¼€æºé¡¹ç›®æä¾›äº†ä¸€å®šé‡çš„æœåŠ¡æ—¶é—´ï¼Œå¯¹äºç§æœ‰é¡¹ç›®ï¼Œåˆ™éœ€è¦ä»˜è´¹--èµ·ä»·æ˜¯æ¯æœˆ 69 ç¾å…ƒã€‚è¿™ä¸ªå®šä»·æœ¬èº«ä¹Ÿè¯´æ˜äº†æŒç»­é›†æˆçš„ä»·å€¼ï¼Œä»¥åŠè¦å®ç°æŒç»­é›†æˆï¼Œæ‰€éœ€è¦æ¶ˆè€—çš„èµ„æºã€‚

Github Actions æ˜¯ Github åœ¨ 2020 å¹´å‰åæ¨å‡ºçš„æŒç»­é›†æˆæœåŠ¡ï¼Œå®ƒçš„ä¼˜ç‚¹åŒ gitlab CI ä¸€æ ·ï¼Œä¹Ÿåœ¨äºä¸ä»£ç æ‰˜ç®¡æœåŠ¡æ— ç¼é›†æˆã€‚åœ¨ä»·æ ¼æ–¹é¢ï¼ŒGithub Actions å¯¹å¼€æºé¡¹ç›®ä¹Ÿæ˜¯å…è´¹ä½¿ç”¨çš„ï¼Œä¸ Travis CI ç›¸æ¯”ï¼Œç»™å‡ºçš„å…è´¹ quota æ›´å¤šï¼Œè¶³å ªä½¿ç”¨ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æœ¬ç« å°±ç•¥è¿‡ Travis CIï¼Œç›´æ¥ä»‹ç» Github Actionsã€‚
# 2. GITHUB ACTIONS
Github Actions æ˜¯ä¸€ä¸ªæŒç»­é›†æˆä¸äº¤ä»˜çš„å¹³å°ï¼Œå®ƒä½¿å¾—æˆ‘ä»¬å¯ä»¥å°†æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²åƒæµæ°´çº¿ä¸€æ ·è‡ªåŠ¨åŒ–ã€‚æ‚¨å¯ä»¥åˆ›å»ºå·¥ä½œæµç¨‹æ¥æ„å»ºå’Œæµ‹è¯•å­˜å‚¨åº“çš„æ¯ä¸ªæ‹‰å–è¯·æ±‚ï¼Œæˆ–å°†åˆå¹¶çš„æ‹‰å–è¯·æ±‚éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚

GitHub é€šè¿‡äº‘æœåŠ¡æ¥æä¾› Linuxã€Windows å’Œ macOS è¿™äº›åŸºç¡€è®¾æ–½ï¼Œä½†ä¹Ÿå…è®¸æˆ‘ä»¬åœ¨è‡ªå·±çš„ç§æœ‰äº‘ä¸Šè¿›è¡Œæœ¬åœ°åŒ–éƒ¨ç½²ã€‚

## 2. Github Actions çš„æ¶æ„å’Œæ¦‚å¿µ

Github Actions ç”±å·¥ä½œæµ (workflow)ã€äº‹ä»¶ (Event)ã€ä½œä¸š (job)ã€æ“ä½œ (Action) å’Œæ‰§è¡Œè€… (runner) ç­‰ç»„ä»¶æ„æˆã€‚

å·¥ä½œæµç”±ä¸€ä¸ª yaml æ–‡ä»¶æ¥å®šä¹‰ï¼Œå®ƒä½äºé¡¹ç›®æ ¹ç›®å½•ä¸‹çš„.github/workflowsã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥ç®€å•åœ°å°†è¯¥æ–‡ä»¶å½“æˆè„šæœ¬æ¥ç†è§£ã€‚è¯¥æ–‡ä»¶å®šä¹‰äº†å“ªäº›äº‹ä»¶å¯ä»¥è§¦å‘å·¥ä½œæµï¼Œå·¥ä½œæµä¸­åº”è¯¥åŒ…å«å“ªäº›ä½œä¸šï¼Œä»¥åŠä½œä¸šåº”è¯¥åœ¨ä»€ä¹ˆæ ·çš„æ‰§è¡Œè€…ï¼ˆå®¹å™¨ï¼‰ä¸­è¿è¡Œã€‚ä¸€ä¸ªå­˜å‚¨åº“ä¸­å¯ä»¥æœ‰å¤šä¸ªå·¥ä½œæµï¼Œåˆ†åˆ«æ‰§è¡Œä¸åŒçš„ä»»åŠ¡é›†ã€‚

äº‹ä»¶æ˜¯èƒ½å¼•å‘å·¥ä½œæµè¿è¡Œçš„ç‰¹å®šäº‹ä»¶ï¼Œæ¯”å¦‚å½“æœ‰äººåˆ›å»ºæ‹‰å–è¯·æ±‚ã€æˆ–è€…å°†æäº¤ (commit) æ¨é€åˆ°å­˜å‚¨åº“æ—¶ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªèƒ½è§¦å‘å·¥ä½œæµçš„äº‹ä»¶ã€‚

ä½œä¸š (job) æ˜¯å·¥ä½œæµä¸­åœ¨åŒä¸€è¿è¡Œå™¨ä¸Šæ‰§è¡Œçš„ä¸€ç»„æ­¥éª¤ï¼ˆsteps)ã€‚ æ¯ä¸ªæ­¥éª¤ (step) è¦ä¹ˆæ˜¯ä¸€ä¸ªå°†è¦æ‰§è¡Œçš„ shell è„šæœ¬ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ªå°†è¦è¿è¡Œçš„æ“ä½œ (Actionï¼‰ã€‚ æ­¥éª¤æŒ‰é¡ºåºæ‰§è¡Œï¼Œå¹¶ä¸”ç›¸äº’ä¾èµ–ã€‚ ç”±äºæ¯ä¸ªæ­¥éª¤éƒ½åœ¨åŒä¸€è¿è¡Œå™¨ä¸Šæ‰§è¡Œï¼Œå› æ­¤æ‚¨å¯ä»¥å°†æ•°æ®ä»ä¸€ä¸ªæ­¥éª¤å…±äº«åˆ°å¦ä¸€ä¸ªæ­¥éª¤ã€‚ ä¾‹å¦‚ï¼Œå¯ä»¥æœ‰ä¸€ä¸ªç”Ÿæˆåº”ç”¨ç¨‹åºçš„æ­¥éª¤ï¼Œåè·Ÿä¸€ä¸ªæµ‹è¯•å·²ç”Ÿæˆåº”ç”¨ç¨‹åºçš„æ­¥éª¤ã€‚

ä¸€ä¸ªå·¥ä½œæµä¸­å¯ä»¥æœ‰å¤šä¸ªä½œä¸šã€‚ä½œä¸šä¹‹é—´é»˜è®¤æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œå¹¶ä¸”å½¼æ­¤å¹¶è¡Œè¿è¡Œã€‚ ä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥é…ç½®ä¸€ä¸ªä½œä¸šä¾èµ–äºå¦ä¸€ä¸ªä½œä¸šï¼Œæ­¤æ—¶ï¼Œå®ƒå°†ç­‰å¾…ä»å±ä½œä¸šå®Œæˆï¼Œç„¶åæ‰èƒ½è¿è¡Œã€‚ ä¾‹å¦‚ï¼Œå¯¹äºæ²¡æœ‰ä¾èµ–å…³ç³»çš„ä¸åŒä½“ç³»ç»“æ„ï¼Œæ‚¨å¯èƒ½æœ‰å¤šä¸ªæµ‹è¯•ä½œä¸šï¼Œä»¥åŠä¸€ä¸ªä¾èµ–äºè¿™äº›ä½œä¸šçš„æ‰“åŒ…ä½œä¸šã€‚ æµ‹è¯•ä½œä¸šå°†å¹¶è¡Œè¿è¡Œï¼Œå½“å®ƒä»¬å…¨éƒ¨æˆåŠŸå®Œæˆåï¼Œæ‰“åŒ…ä½œä¸šå°†è¿è¡Œã€‚

æ“ä½œ (Action) æ˜¯ç”¨äº GitHub Actions å¹³å°çš„è‡ªå®šä¹‰åº”ç”¨ç¨‹åºï¼Œå®ƒæ‰§è¡Œå¤æ‚ä½†ç»å¸¸é‡å¤çš„ä»»åŠ¡ã€‚ ä½¿ç”¨æ“ä½œå¯å¸®åŠ©å‡å°‘åœ¨å·¥ä½œæµç¨‹æ–‡ä»¶ä¸­ç¼–å†™çš„é‡å¤ä»£ç é‡ã€‚ æ“ä½œå¯ä»¥ä» GitHub æ‹‰å– git å­˜å‚¨åº“ï¼Œä¸ºæ‚¨çš„æ„å»ºç¯å¢ƒè®¾ç½®æ­£ç¡®çš„å·¥å…·é“¾ï¼Œæˆ–è®¾ç½®å¯¹äº‘æä¾›å•†çš„èº«ä»½éªŒè¯ã€‚

æ‚¨å¯ä»¥ç¼–å†™è‡ªå·±çš„æ“ä½œï¼Œä¹Ÿå¯ä»¥åœ¨ GitHub Marketplace ä¸­æ‰¾åˆ°è¦åœ¨å·¥ä½œæµç¨‹ä¸­ä½¿ç”¨çš„æ“ä½œã€‚

æ‰§è¡Œè€… (runner) æ˜¯è¿è¡Œå·¥ä½œæµçš„æœåŠ¡å™¨ã€‚æ¯ä¸ªæ‰§è¡Œè€…ä¸€æ¬¡å¯ä»¥è¿è¡Œä¸€ä¸ªä½œä¸šã€‚ GitHub æä¾› Ubuntu Linuxã€Microsoft Windows å’Œ macOS è¿è¡Œå™¨æ¥è¿è¡Œæ‚¨çš„å·¥ä½œæµç¨‹ï¼›æ¯ä¸ªå·¥ä½œæµç¨‹è¿è¡Œéƒ½åœ¨æ–°é¢„é…çš„å…¨æ–°è™šæ‹Ÿæœºï¼ˆæˆ–è€…å®¹å™¨ï¼‰ä¸­æ‰§è¡Œã€‚

ä¸‹é¢çš„å›¾å±•ç¤ºäº† Github Actions çš„æ¶æ„ï¼š

![](https://images.jieyu.ai/images/2023/12/overview-actions.png)
## 3. å·¥ä½œæµè¯­æ³•æ¦‚è¿°
åœ¨äº†è§£äº† Github Actions çš„æ¶æ„ä¹‹åï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­ï¼Œæ¥è®²è§£å¦‚ä½•å®šä¹‰å·¥ä½œæµã€‚

æˆ‘ä»¬å…ˆçœ‹ ppw ç”Ÿæˆçš„ä¸€ä¸ªå·¥ä½œæµæ–‡ä»¶ï¼š

```yaml title="dev.yml"
name: dev build CI

# å®šä¹‰å“ªäº›äº‹ä»¶å¯ä»¥è§¦å‘å·¥ä½œæµï¼Œä»¥åŠç­›é€‰æ¡ä»¶
on:
  # å½“å­˜å‚¨åº“æœ‰ PUSH æˆ–è€… PULL_REQUEST äº‹ä»¶æ—¶è§¦å‘
  push:
    branches:
      - '*'
  pull_request:
    branches:
      - '*'

# å®šä¹‰ä½œä¸šé›†
jobs:
  # å·¥ä½œæµåŒ…å«ä¸‰ä¸ªä½œä¸šï¼Œåˆ†åˆ«æ˜¯ TEST, PUBLISH_DEV_BUILD, NOTIFICATION
  test:
    # å®šä¹‰ä½œä¸šçš„è¿è¡Œç¯å¢ƒï¼Œè¿™é‡Œä½¿ç”¨äº†çŸ©é˜µå¼å®šä¹‰
    strategy:
      matrix:
        python-versions: ['3.8', '3.9', '3.10']
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    # å°†æ­¥éª¤çš„è¾“å‡ºæå‡ä¸ºä½œä¸šçš„è¾“å‡ºï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥åœ¨ä½œä¸šä¹‹é—´å…±äº«
    outputs:
      package_version: ${{ steps.variables_step.outputs.package_version }}
      package_name: ${{ steps.variables_step.outputs.package_name }}
      repo_name: ${{ steps.variables_step.outputs.repo_name }}
      repo_owner: ${{ steps.variables_step.outputs.repo_owner }}

    # è¿™æ˜¯å¯ç”¨å¤–éƒ¨æœåŠ¡çš„ä¸€ä¸ªç¤ºä¾‹
    # SERVICES:
    #   REDIS:
    #     IMAGE: REDIS
    #     OPTIONS: >-
    #       --HEALTH-CMD "REDIS-CLI PING"
    #       --HEALTH-INTERVAL 10S
    #       --HEALTH-TIMEOUT 5S
    #       --HEALTH-RETRIES 5
    #     PORTS:
    #       - 6379:6379

    # æ­¥éª¤é›†ä»£è¡¨äº†ä¸€ç³»åˆ—çš„ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡å°†ä½œä¸ºä½œä¸šçš„ä¸€éƒ¨åˆ†æ‰§è¡Œ
    steps:
      # ä½œä¸šæ˜¯åœ¨å®¹å™¨é‡Œæ‰§è¡Œçš„ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå°†ä»£ç æ£€å‡ºåˆ°è¿™ä¸ªå¹²å‡€çš„å®¹å™¨é‡Œ
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-versions }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tox tox-gh-actions poetry

      # è¿™ä¸€æ­¥é‡Œï¼Œæˆ‘ä»¬è®¾ç½®äº†ä¸€äº›å˜é‡ï¼Œå°†å…¶è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œä»è€Œå¯ä»¥åœ¨ç¬¬ 85 è¡Œæå‡ä¸º JOB çš„è¾“å‡º
      - name: Declare variables for convenient use
        id: variables_step
        run: |
          echo "::set-output name=repo_owner::${GITHUB_REPOSITORY%/*}"
          echo "::set-output name=repo_name::${GITHUB_REPOSITORY#*/}"
          echo "::set-output name=package_name::`poetry version | awk '{print $1}'`"
          echo "::set-output name=package_version::`poetry version --short`"
        shell: bash

      # æ‰§è¡Œå•å…ƒæµ‹è¯•å’Œä»£ç æ£€æŸ¥ã€‚
      - name: test with tox
        run: tox

      # é€šè¿‡ CODECOV ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡ã€‚
      - uses: codecov/codecov-action@v3
        with:
          fail_ci_if_error: true

  publish_dev_build:
    # åªæœ‰ TEST ä½œä¸šå®Œæˆï¼Œæˆ‘ä»¬æ‰å¼€å§‹æœ¬ä½œä¸š
    needs: test
    # æŒ‡å®šæœ¬ä½œä¸šè¿è¡Œçš„æ“ä½œç³»ç»Ÿç¯å¢ƒã€‚
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          # è¿™ä¸€æ­¥åªéœ€è¦åœ¨ä»»æ„ä¸€ä¸ª PYTHON ç‰ˆæœ¬ä¸Šè¿è¡Œ
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry tox tox-gh-actions

      - name: build documentation
        run: |
          poetry install -E doc
          poetry run mkdocs build
          git config --global user.name Docs deploy
          git config --global user.email docs@dummy.bot.com
          poetry run mike deploy -p -f --ignore "`poetry version --short`.dev"
          poetry run mike set-default -p "`poetry version --short`.dev"

      - name: Build wheels and source tarball
        run: |
          poetry version $(poetry version --short)-dev.$GITHUB_RUN_NUMBER
          poetry lock
          poetry build

      - name: publish to Test PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.TEST_PYPI_API_TOKEN}}
          repository_url: https://test.pypi.org/legacy/
          skip_existing: true

  notification:
    needs: [test,publish_dev_build]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: martialonline/workflow-status@v2
        id: check

      - name: build success notification via email
        if: ${{ steps.check.outputs.status == 'success' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.BUILD_NOTIFY_MAIL_SERVER }}
          server_port: ${{ secrets.BUILD_NOTIFY_MAIL_PORT }}
          username: ${{ secrets.BUILD_NOTIFY_MAIL_FROM }}
          password: ${{ secrets.BUILD_NOTIFY_MAIL_PASSWORD }}
          from: build-bot
          to: ${{ secrets.BUILD_NOTIFY_MAIL_RCPT }}
          subject: ${{ needs.test.outputs.package_name }}.${{ needs.test.outputs.package_version}} build successfully
          convert_markdown: true
          html_body: |
            ## Build Success
            ${{ needs.test.outputs.package_name }}.${{ needs.test.outputs.package_version }} is built and published to test pypi

            ## Change Details
            ${{ github.event.head_commit.message }}

            For more information, please check change history at https://${{ needs.test.outputs.repo_owner }}.github.io/${{ needs.test.outputs.repo_name }}/${{ needs.test.outputs.package_version }}/history

            ## Package Download
            The pacakge is available at: https://test.pypi.org/project/${{ needs.test.outputs.package_name }}/

      - name: build failure notification via email
        if: ${{ steps.check.outputs.status == 'failure' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.BUILD_NOTIFY_MAIL_SERVER }}
          server_port: ${{ secrets.BUILD_NOTIFY_MAIL_PORT }}
          username: ${{ secrets.BUILD_NOTIFY_MAIL_FROM }}
          password: ${{ secrets.BUILD_NOTIFY_MAIL_PASSWORD }}
          from: build-bot
          to: ${{ secrets.BUILD_NOTIFY_MAIL_RCPT }}
          subject: ${{ needs.test.outputs.package_name }}.${{ needs.test.outputs.package_version}} build failure
          convert_markdown: true
          html_body: |
            ## Change Details
            ${{ github.event.head_commit.message }}

            ## View Log
            https://github.com/${{ needs.test.outputs.repo_owner }}/${{ needs.test.outputs.repo_name }}/actions
```

è¿™æ˜¯ä¸€ä¸ªåä¸º dev build CI çš„ä½œä¸šï¼Œå®ƒå°†åœ¨ä»»ä¸€åˆ†æ”¯å‘ç”Ÿæäº¤å’Œ pull request æ—¶è§¦å‘ã€‚å®ƒåŒ…å«ä¸‰ä¸ªä½œä¸šï¼Œå³ testï¼ˆæ‰§è¡Œå•å…ƒæµ‹è¯•ï¼‰ã€publish_dev_buildï¼ˆæ„å»ºå¹¶å‘å¸ƒå¼€å‘ç‰ˆæœ¬åˆ° test_pypi) å’Œ notificationï¼ˆåœ¨æ„å»ºæˆåŠŸæˆ–å¤±è´¥æ—¶å‘é€é‚®ä»¶é€šçŸ¥ï¼‰ã€‚ä¸‰è€…ä¹‹é—´æœ‰ä¾èµ–å…³ç³»ï¼Œå¦‚æœ test ä½œä¸šå¤±è´¥ï¼Œpublish_dev_build ä¼šå–æ¶ˆï¼›ä½†æ˜¯æ— è®º test/publish_dev_build ä½œä¸šæ˜¯å¦æˆåŠŸï¼Œnotification ä½œä¸šéƒ½ä¼šæ‰§è¡Œï¼Œå¹¶æ ¹æ®å‰ä¸¤ä¸ªä½œä¸šçš„çŠ¶æ€å‘é€é‚®ä»¶é€šçŸ¥ã€‚

è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„ä½œä¸šï¼Œä½†ä¹Ÿæ¶‰åŠäº†æˆ‘ä»¬åœ¨ CI ä¸­éœ€è¦åšçš„å‡ ä¹æ‰€æœ‰äº‹æƒ…ã€‚åœ¨ä»£ç ä¸­æˆ‘ä»¬åŠ å…¥äº†è¾ƒå¤šçš„æ³¨é‡Šï¼Œå»ºè®®è¯»è€…ç»“åˆä¸‹é¢çš„è®²è§£ï¼Œä»”ç»†é˜…è¯»ä»£ç ã€‚
### 3.1. å®šä¹‰è§¦å‘æ¡ä»¶
ç¬¬ 4 è¡Œåˆ°ç¬¬ 14 è¡Œé…ç½®äº†å·¥ä½œæµçš„è§¦å‘æ¡ä»¶ã€‚è§¦å‘æ¡ä»¶ä¸€èŠ‚ç”±å…³é”®å­—**'on'**å¼•èµ·ã€‚åœ¨å®ƒçš„ä¸‹ä¸€å±‚ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰å¤šä¸ªè§¦å‘äº‹ä»¶ï¼Œå¹¶ä¸ºæ¯ä¸ªè§¦å‘äº‹ä»¶ï¼ŒæŒ‡å®šç±»å‹å’Œè¿‡æ»¤å™¨ã€‚ä¸€ä¸ªå®Œæ•´çš„è§¦å‘æ¡ä»¶é…ç½®å¦‚ä¸‹ï¼š

```yaml
on:
    push:
        branches: 
          - '*'
        tags:
          - v*
    label:
        branches:
            - main
        types:
            - created
    schedule:
        - cron: '30 5 * * 1,3'
```
åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œ'push', 'label', 'tags'å’Œ'schedule'éƒ½æ˜¯äº‹ä»¶å…³é”®å­—ã€‚å¯ç”¨çš„äº‹ä»¶å…³é”®å­—å¯å‚è§ [è§¦å‘å·¥ä½œæµçš„äº‹ä»¶](https://docs.github.com/zh/actions/using-workflows/events-that-trigger-workflows)ã€‚

åœ¨äº‹ä»¶çš„ä¸‹ä¸€çº§ï¼Œæ˜¯å®šä¹‰æ´»åŠ¨ç±»å‹å’Œç­›é€‰å™¨çš„åœ°æ–¹ã€‚ä¸æ˜¯æ‰€æœ‰çš„äº‹ä»¶éƒ½æœ‰æ´»åŠ¨ç±»å‹ï¼Œå³ä½¿æœ‰ï¼Œå®ƒä»¬çš„æ´»åŠ¨ç±»å‹ä¹Ÿå¾ˆå¯èƒ½ä¸ä¸€æ ·ã€‚æ¯”å¦‚ï¼Œ`push`äº‹ä»¶å°±æ²¡æœ‰æ´»åŠ¨ç±»å‹ï¼Œè€Œ`label`äº‹ä»¶æœ‰`created`, `edited`å’Œ`deleted`ä¸‰ç§æ´»åŠ¨ç±»å‹ï¼Œè€Œ`issues`äº‹ä»¶çš„æ´»åŠ¨ç±»å‹åˆ™æ˜¯`opened`å’Œ`labeled`ç­‰ã€‚è¦æƒ³çŸ¥é“äº‹ä»¶æœ‰å“ªäº›æ´»åŠ¨ç±»å‹ï¼Œå¯ä»¥å‚è€ƒ [è§¦å‘å·¥ä½œæµçš„äº‹ä»¶](https://docs.github.com/zh/actions/using-workflows/events-that-trigger-workflows)ã€‚

ç­›é€‰å™¨æœ‰ branches å’Œ tags ä¸¤ç§ï¼Œåˆ†åˆ«ç”¨äºæŒ‡å®šåˆ†æ”¯å’Œæ ‡ç­¾ã€‚ä»ä¸Šé¢çš„ç¤ºä¾‹å¯ä»¥çœ‹å‡ºï¼Œç­›é€‰å™¨çš„å€¼æ”¯æŒ glob æ¨¡å¼ï¼Œå³ä½ å¯ä»¥ä½¿ç”¨*,**, +, ? å’Œï¼ç­‰é€šé…ç¬¦ã€‚é™¤äº†ç¤ºä¾‹ä¸­çš„æ­£å‘åŒ¹é…å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ branches-ignore æˆ–è€… tags-ignore æ¥åå‘åŒ¹é…ã€‚

ä¸Šé¢çš„ç¤ºä¾‹è¿˜å±•ç¤ºäº†ä¸€ç§ç‰¹æ®Šçš„äº‹ä»¶ï¼Œå³ 'schedule' äº‹ä»¶ã€‚è¿™å°†å¯¼è‡´å·¥ä½œæµå‘¨æœŸæ€§åœ°è¿è¡Œã€‚è¿™å¯ä»¥ç”¨æ¥è¿è¡Œä¸€äº›å®‰å…¨æ€§æ‰«æã€ä¾èµ–å‡çº§æ‰«æç­‰å·¥ä½œã€‚

### 3.2. å®šä¹‰ä½œä¸šé›†
æ¥ä¸‹æ¥å·¥ä½œæµå£°æ˜äº†ä¸‰ä¸ªä½œä¸šï¼Œå³ test, publish_dev_build å’Œ notificationã€‚ä½œä¸šå®šä¹‰ä¸€èŠ‚ç”±å…³é”®å­—**'jobs'**å¼•èµ·ã€‚åœ¨å®ƒçš„ä¸‹ä¸€å±‚ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰å¤šä¸ªä½œä¸šï¼Œå¹¶ä¸ºæ¯ä¸ªä½œä¸šï¼ŒæŒ‡å®šè¿è¡Œç¯å¢ƒå’Œè¿è¡Œæ­¥éª¤ã€‚

æ¯ä¸ªä½œä¸šéƒ½æœ‰è‡ªå·±çš„ id å’Œåå­—ã€‚åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œtest, publish_dev_build å’Œ notification éƒ½æ˜¯ä½œä¸š idã€‚ä½œä¸š id æ˜¯å¿…é¡»çš„ï¼Œä½†æ˜¯ä½œä¸šåå­—æ˜¯å¯é€‰çš„ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šä½œä¸šåå­—ï¼Œé‚£ä¹ˆä½œä¸šåå­—å°†é»˜è®¤ä¸ºä½œä¸š idã€‚ä½œä¸šåå­—å¯ä»¥ç”¨æ¥åœ¨ GitHub Actions çš„ç•Œé¢ä¸Šæ˜¾ç¤ºä½œä¸šçš„åç§°ã€‚

åœ¨ä½œä¸š publish_dev_build ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡å…³é”®å­—`needs`æ¥å®šä¹‰äº†å®ƒå¯¹ä½œä¸š`test`çš„ä¾èµ–ã€‚æˆ‘ä»¬åœ¨ç¬¬ 114 è¡Œè¿˜çœ‹åˆ°ï¼Œä½œä¸šè¿˜å¯ä»¥ä¾èµ–åˆ°ä¸€ç»„ä½œä¸šã€‚å½“æˆ‘ä»¬æŒ‡å®šä½œä¸šä¾èµ–æ—¶ï¼Œè¦æ³¨æ„åªèƒ½ä½¿ç”¨ä½œä¸šçš„ idï¼Œè€Œä¸æ˜¯ä½œä¸šçš„åå­—ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ä¸ºä½œä¸šå®šä¹‰æ‰§è¡Œç¯å¢ƒã€‚æ‰§è¡Œç¯å¢ƒæ˜¯é€šè¿‡å…³é”®å­— 'runs-on' æ¥å®šä¹‰çš„ã€‚æœ‰äº›ä»»åŠ¡åªéœ€è¦åœ¨ä¸€å°æœºå™¨ä¸Šæ‰§è¡Œå°±å¯ä»¥äº†ï¼Œæ¯”å¦‚PythonåŒ…çš„æ„å»ºå’Œå‘å¸ƒï¼›æœ‰äº›ä»»åŠ¡åˆ™éœ€è¦åœ¨æ‰€æœ‰çš„æœºå™¨ä¸Šã€å¹¶ä»¥å¤šä¸ªpythonè¿è¡Œæ—¶æ¥è¿è¡Œï¼Œæ¯”å¦‚æµ‹è¯•ã€‚

æ¯”å¦‚ï¼Œpublish_dev_build ä½œä¸šåªåœ¨ ubuntu_latest å’Œ python 3.9 è¿™ä¸ªç»„åˆä¸Šè¿è¡Œã€‚æˆ‘ä»¬æ˜¯é€šè¿‡ç¬¬ 78 è¡Œå’Œç¬¬ 83 è¡Œæ¥æŒ‡å®šçš„ã€‚ä½†å¯¹æµ‹è¯•ä»»åŠ¡ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒåœ¨æ‰€æœ‰æœºå™¨ä¸Šéƒ½è¿è¡Œï¼Œå¹¶ä¸”è¿˜è¦è¿è¡Œåœ¨ä¸åŒçš„ python ç‰ˆæœ¬ä¸Šã€‚ä¸ºäº†è¡¨è¾¾ç®€æ´èµ·è§ï¼Œgithub actions å¼•å…¥äº†çŸ©é˜µçš„æ¦‚å¿µã€‚

æˆ‘ä»¬é€šè¿‡ strategy.matrix æ¥å®šä¹‰æµ‹è¯•çŸ©é˜µã€‚åœ¨ç¤ºä¾‹ç¬¬ 20~23 è¡Œå®šä¹‰çš„çŸ©é˜µä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº† python ç‰ˆæœ¬å’Œæ“ä½œç³»ç»Ÿåˆ—è¡¨ã€‚è¿™ä¸ªå®šä¹‰éšåå°±è¢«ä½¿ç”¨äº†ï¼Œåœ¨ç¬¬ 24 è¡Œï¼Œæˆ‘ä»¬é€šè¿‡{{matrix.os}}æ¥å¼•ç”¨äº†å…¶ä¸­çš„æ“ä½œç³»ç»Ÿå®šä¹‰ã€‚ç¬¬ 22 è¡Œçš„ python-versions æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å…³é”®å­—ï¼Œå®ƒç”¨æ¥æŒ‡ç¤ºæˆ‘ä»¬è¦ä½¿ç”¨çš„ python ç‰ˆæœ¬ã€‚å¦‚æœæˆ‘ä»¬çš„å¼€å‘è¯­è¨€ä¸æ˜¯ pythonï¼Œè¿™é‡Œçš„æŒ‡å®šå°†æ²¡æœ‰æ„ä¹‰ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ä¸ºä½œä¸šå®šä¹‰å…·ä½“æ‰§è¡Œå“ªäº›ä»»åŠ¡ï¼Œå®ƒä»¬è¢«å½’ç±»åœ¨æ­¥éª¤é›† (steps) ä¸­ã€‚æ­¥éª¤é›†æ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ªæ­¥éª¤çš„åˆ—è¡¨ã€‚è€Œæ¯ä¸€ä¸ªæ­¥éª¤ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ª shell å‘½ä»¤ï¼ˆæˆ–è€…ä¸€ç»„ shell å‘½ä»¤ï¼‰ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ª actionã€‚å¦‚æœè¦è¿è¡Œ shell å‘½ä»¤ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„è¯­æ³•ï¼š
```yaml
- name: <step name>
  run: <shell command>
```
å¦‚æœè¦è¿è¡Œä¸€ç»„ shell å‘½ä»¤ï¼Œæˆ‘ä»¬ä½¿ç”¨ï¼š
```yaml
- name: <step name>
  run: |
    <shell command 1>
    <shell command 2>
    ...
```
æ³¨æ„ä¸Šè¿°ä¸¤ç»„è¯­æ³•çš„ä¸åŒä¹‹å¤„ï¼Œä¸èƒ½æ··æ·†ã€‚

è‡³äº actionï¼Œæˆ‘ä»¬å‰é¢å·²ç»è®²è¿‡äº†ï¼Œå®ƒæ˜¯ç”¨äº GitHub Actions å¹³å°çš„è‡ªå®šä¹‰åº”ç”¨ç¨‹åºã€‚æ‚¨å¯ä»¥è‡ªå·±ç¼–å†™ actionï¼Œä¹Ÿå¯ä»¥åœ¨ Github çš„åº”ç”¨å¸‚åœºä¸ŠæŸ¥æ‰¾ä»–äººå¼€å‘çš„åº”ç”¨ã€‚

æ¯ä¸€ä¸ªæ­¥éª¤éƒ½å¯ä»¥æŒ‡å®š python è¿è¡Œæ—¶ã€‚æˆ‘ä»¬åœ¨ç¬¬ 48 è¡Œçœ‹åˆ°ï¼Œè¿™é‡Œ`{{ matrix.python-versions }}`ä½¿ç”¨çš„æ˜¯çŸ©é˜µä¸­å®šä¹‰çš„ python ç‰ˆæœ¬ã€‚è€Œåœ¨ç¬¬ 84 è¡Œï¼Œæˆ‘ä»¬åˆ™ç›´æ¥æŒ‡å®šäº†ä¸€ä¸ª python çš„ç‰ˆæœ¬ã€‚è¿™é‡Œè¿˜è¦æ³¨æ„ï¼Œç‰ˆæœ¬å·æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œq æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`'3.10'`ï¼Œä½†ä¸èƒ½ä½¿ç”¨`3.10`ï¼Œåè€…å°†ä¼šè¢« yaml è§£æä¸º`3.1`ï¼Œä»è€Œå‡ºç°æ‰¾ä¸åˆ° python ç‰ˆæœ¬çš„é—®é¢˜ã€‚

æœ€åï¼Œæˆ‘ä»¬ä»‹ç»ä¸€ä¸‹ job è¿è¡Œæ—¶çš„æ¡ä»¶æ§åˆ¶ã€‚æˆ‘ä»¬å·²ç»ä»‹ç»è¿‡äº† job ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œè¿™å¯ä»¥ç®—ä½œæ˜¯ä¸€ç§æ¡ä»¶ã€‚è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œæ¯”å¦‚ç¤ºä¾‹ä¸­çš„ notification ä½œä¸šï¼Œæˆ‘ä»¬è¦æ±‚å®ƒåªèƒ½åœ¨å‰ä¸¤ä¸ªä½œä¸šéƒ½å®Œæˆåæ‰è¿è¡Œï¼Œä½†æ— è®ºæˆåŠŸä¸å¦ï¼Œéƒ½è¦è¿è¡Œï¼Œä½†ä¼šæ ¹æ®å‰é¢ä½œä¸šçš„çŠ¶æ€ï¼Œå‘å‡ºä¸åŒå†…å®¹çš„é€šçŸ¥é‚®ä»¶ï¼Œæ­¤æ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦å¼•å…¥`if`æ¡ä»¶æ§åˆ¶ã€‚

`if`æ¡ä»¶æ§åˆ¶å¯ä»¥ä½œç”¨äºä½œä¸šä½œç”¨åŸŸï¼ˆå¦‚ç¬¬ 116 è¡Œæ‰€ç¤ºï¼‰ï¼Œä¹Ÿå¯ä»¥ä½œç”¨äºæ­¥éª¤ä½œç”¨åŸŸï¼ˆå¦‚ç¬¬ 123 è¡Œæ‰€ç¤ºï¼‰ã€‚åœ¨ä½œä¸šä½œç”¨åŸŸä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`success()`ã€`failure()`ã€`cancelled()`ã€`always()`ç­‰å‡½æ•°æ¥æŒ‡å®šåœ¨ä½•ç§æƒ…å†µä¸‹æ‰è¿è¡Œæœ¬ä½œä¸šã€‚åœ¨æ­¥éª¤ä½œç”¨åŸŸä¸­ï¼Œæˆ‘ä»¬åˆ™å¯ä»¥è¿›è¡Œç®€å•çš„æ¡ä»¶åˆ¤æ–­ï¼Œæ¥æŒ‡æ ‡æœ¬æ­¥éª¤æ˜¯å¦è¿è¡Œã€‚

åœ¨è¿›è¡Œæ¡ä»¶åˆ¤æ–­æ—¶ï¼Œæˆ‘ä»¬å¿…ç„¶éœ€è¦ä½¿ç”¨å˜é‡ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦å…¨é¢åœ°ä»‹ç»ä¸€ä¸‹åœ¨å·¥ä½œæµä¸­å˜é‡çš„ä½¿ç”¨ã€‚é€šè¿‡å˜é‡ï¼Œç»“åˆå„ç§æ§åˆ¶æ¡ä»¶ï¼Œæˆ‘ä»¬æ‰èƒ½å®ç°ä¸€äº›é«˜çº§çš„æŠ€å·§ã€‚
Github ä¸­çš„å˜é‡åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯ç³»ç»Ÿå˜é‡ï¼Œä¸€ç§æ˜¯ä½œä¸šå˜é‡ã€‚ç³»ç»Ÿå˜é‡æ˜¯ Github å¹³å°æä¾›çš„ï¼Œä½œä¸šå˜é‡æ˜¯æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ã€‚æ— è®ºé‚£ä¸€ç§å˜é‡ï¼Œæˆ‘ä»¬éƒ½é€šè¿‡`${{ }}`æ¥å¼•ç”¨ã€‚

ç³»ç»Ÿå˜é‡æŒ‰çº§åˆ«å¯ä»¥å®šä¹‰åœ¨ç»„ç»‡ã€å­˜å‚¨åº“æˆ–è€…ç¯å¢ƒä¸Šã€‚æ¯”å¦‚`secrets`å°±å®šä¹‰åœ¨å­˜å‚¨åº“çº§åˆ«ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`${{ secrets.BUILD_NOTIFY_MAIL_RCPT }}`æ¥è®¿é—®å®ƒçš„å€¼ï¼Œè¿™éœ€è¦æˆ‘ä»¬åœ¨å­˜å‚¨åº“é‡Œäº‹å…ˆå®šä¹‰`BUILD_NOTIFY_MAIL_RCPT`è¿™ä¸ªå˜é‡ã€‚Github æä¾›äº†ä¸€äº›é»˜è®¤å˜é‡ï¼Œæ¯”å¦‚`GITHUB_REPOSITORY`ï¼ˆä½ åœ¨ç¬¬ 59 è¡Œï¼Œå£°æ˜å˜é‡é‚£ä¸€èŠ‚å¯ä»¥çœ‹åˆ°å®ƒçš„ä½¿ç”¨ï¼‰ç­‰ã€‚

ä½œä¸šå˜é‡çš„ä½¿ç”¨æ¯”è¾ƒç‰¹æ®Šï¼Œæˆ‘ä»¬çœ‹çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š
```yaml
  notification:
    needs: [test,publish_dev_build]
    steps:
      - name: build success notification via email
        if: ${{ steps.check.outputs.status == 'success' }}
        uses: dawidd6/action-send-mail@v3
        with:
          subject: ${{ needs.test.outputs.package_name }}.
```
ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡${{ needs.test.outputs.package_name }}æ¥å¼•ç”¨åœ¨ç¬¬ 24 è¡Œå£°æ˜çš„`package_name`å˜é‡ã€‚å˜é‡æ˜¯é€šè¿‡`{job_id}.outputs.{variable}`æ¥å¼•ç”¨çš„ï¼Œè¿™å¹¶æ²¡æœ‰ä»€ä¹ˆå¥‡æ€ªçš„åœ°æ–¹ã€‚ä½†æ˜¯è¦æ³¨æ„å®ƒè¿˜æœ‰ä¸€ä¸ª`needs`ä½œç”¨åŸŸã€‚è¿™è¡¨æ˜ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨å˜é‡çš„åœ°æ–¹ï¼Œå…¶æ‰€å±çš„ä½œä¸šå¦‚æœæ²¡æœ‰å£°æ˜ä¾èµ–åˆ°`test`ä½œä¸šï¼Œé‚£ä¹ˆè¿™ä¸ªå˜é‡æ˜¯æ— æ³•è¢«å¼•ç”¨çš„ã€‚

ç¤ºä¾‹ä¸­æ²¡æœ‰å±•ç¤ºç¯å¢ƒå˜é‡çš„ç”¨æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬ç»™ä¸€ä¸ªç¤ºä¾‹ï¼Œè¯·è¯»è€…ç»“åˆæ³¨é‡Šè‡ªè¡Œç ”ç©¶ï¼š
```
env:
  # å£°æ˜äº†ä¸€ä¸ªå…¨å±€ä¸Šä¸‹æ–‡çš„ç¯å¢ƒå˜é‡
  DAY_OF_WEEK: Monday

jobs:
  greeting_job:
    runs-on: ubuntu-latest
    env:
      # å£°æ˜äº†ä¸€ä¸ªä½œä¸šä¸Šä¸‹æ–‡çš„ç¯å¢ƒå˜é‡
      Greeting: Hello
    steps:
      - name: "Say Hello Mona it's Monday"
        # ä½¿ç”¨æ—¶æˆ‘ä»¬åœ¨å˜é‡å‰åŠ ä¸€ä¸ª`ENV.`çš„çº¦æŸ
        if: ${{ env.DAY_OF_WEEK == 'Monday' }}
        # å½“ä½¿ç”¨çš„ç¯å¢ƒå˜é‡æ˜¯åœ¨ä½œä¸šå†…å£°æ˜æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœç•¥`ENV.`çš„çº¦æŸ
        run: echo "$Greeting $First_Name. Today is $DAY_OF_WEEK!"
        env:
          # å£°æ˜äº†æ­¥éª¤ä¸Šä¸‹æ–‡çš„ç¯å¢ƒå˜é‡
          First_Name: Mona
```
### 3.3. è¿æ¥å…¶å®ƒæœåŠ¡
åœ¨ç¤ºä¾‹çš„ç¬¬ 31 è¡Œåˆ°ç¬¬ 40 è¡Œï¼Œæœ‰ä¸€æ®µè¢«æ³¨é‡Šçš„ä»£ç ï¼Œè¿™æ˜¯ç”¨æ¥å¯ç”¨ redis æœåŠ¡çš„ã€‚Github Actions é€šè¿‡å®¹å™¨æŠ€æœ¯æ¥æä¾›è¿™äº›æœåŠ¡ã€‚ç†è®ºä¸Šï¼Œåªè¦åœ¨ docker hub ä¸Šå­˜åœ¨æŸä¸ªæœåŠ¡çš„ imageï¼ˆé•œåƒï¼‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ Github Actions ä¸­ä½¿ç”¨å®ƒã€‚

!!! Attention
    è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬è¦åœ¨ workflow ä¸­ä½¿ç”¨æœåŠ¡ï¼Œæ‰§è¡Œè€… (runner) å¿…é¡»æ˜¯ ubuntu æ“ä½œç³»ç»Ÿï¼Œè€Œä¸æ˜¯èƒ½å…¶å®ƒ Linux ç³»ç»Ÿï¼Œæˆ–è€… windows å’Œ MacOS

æˆ‘ä»¬çš„å·¥ä½œæµå¯ä»¥è¿è¡Œåœ¨æ‰§è¡Œè€… (runner) ä¸Šï¼Œä¹Ÿå¯ä»¥è¿è¡Œåœ¨å®¹å™¨é‡Œï¼ˆè¯¥å®¹å™¨è¿è¡Œåœ¨ runner ä¸Šï¼‰ã€‚å¦‚æœå·¥ä½œæµè¿è¡Œåœ¨å®¹å™¨é‡Œï¼Œåˆ™éœ€è¦é€šè¿‡è‡ªå®šä¹‰çš„æ¡¥æ¥ç½‘ç»œæ¥è¿æ¥è¿è¡Œåœ¨å®¹å™¨é‡Œçš„æœåŠ¡ã€‚å¦‚æœå·¥ä½œæµå°±è¿è¡Œåœ¨æ‰§è¡Œè€… (runner) ä¸Šï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å°†å®¹å™¨çš„ç«¯å£æ˜ å°„åˆ°æ‰§è¡Œè€…ä¸Šï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥è®¿é—®å®¹å™¨é‡Œçš„æœåŠ¡äº†ã€‚

åœ¨å·¥ä½œæµä¸­ä½¿ç”¨æœåŠ¡ï¼Œä¸€èˆ¬éœ€è¦ç­‰å¾…å®¹å™¨å®Œå…¨å¯åŠ¨è¢«åˆå§‹åŒ–æˆåŠŸã€‚è¿™å°±æ˜¯ç¬¬ 96 è¡Œçš„å·¥ä½œã€‚

## 4. ç¬¬ä¸‰æ–¹åº”ç”¨å’Œ Actions
æˆ‘ä»¬å·²ç»åœ¨ç¤ºä¾‹ä¸­çœ‹åˆ°äº†ä¸€äº›æ¥è‡ªåº”ç”¨å¸‚åœºçš„ actionï¼Œæ¯”å¦‚ actions/checkout, actions/setup-python, pypa/gh-action-pypi-publish, dawidd6/action-send-mail, codecove/Codecov ç­‰ç­‰ã€‚è¿™é‡Œ'/'ä¹‹å‰çš„æ˜¯ action çš„ä½œè€…ï¼Œå…¶ä¸­ actions æ˜¯ Github å®˜æ–¹çš„ actionï¼Œå…¶å®ƒçš„éƒ½æ˜¯ç¬¬ä¸‰æ–¹çš„ actionã€‚ä¾‹å­ä¸­çš„ actionï¼Œå®ƒä»¬çš„åå­—å°±å·²ç»è¯´æ˜äº†å…¶åŠŸèƒ½ï¼Œå› æ­¤è¿™é‡Œä¸å†èµ˜è¿°ã€‚

ä¸‹é¢ä»‹ç»å…¶å®ƒä¸€äº›ä½¿ç”¨è¾ƒå¤šçš„ç¬¬ä¸‰æ–¹ actionsï¼Œå…¶ä¸­æœ‰ä¸€äº›æˆ‘ä»¬è¿›è¡Œäº†ç®€è¦è¯´æ˜å¹¶ä¸¾ä¾‹äº†ä½¿ç”¨æ–¹æ³•ã€‚å¦‚æœæˆ‘ä»¬æ²¡æœ‰è¿›è¡Œç‰¹åˆ«è¯´æ˜ï¼Œæˆ–è€…æ‚¨æƒ³è¿›ä¸€æ­¥äº†è§£ç›¸å…³ä¿¡æ¯ï¼Œå¯ä»¥è®¿é—® [marketplace](https://github.com/marketplace/actions) æŸ¥çœ‹ç›¸å…³æ–‡æ¡£ã€‚

### 4.1. Github pages éƒ¨ç½²
è¿™ä¸ª action å¯ä»¥ç”¨æ¥å°†é™æ€ç½‘ç«™éƒ¨ç½²åˆ° Github Pages ä¸Šã€‚åœ¨ ppw ç”Ÿæˆçš„é¡¹ç›®ä¸­ï¼Œå®ƒä¸ mkdocs/mike é…åˆä½¿ç”¨ã€‚å…¶ ID æ˜¯ JamesIves/github-pages-deploy-actionï¼Œä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š
```
name: Build and Deploy
on: [push]
permissions:
  contents: write
jobs:
  build-and-deploy:
    concurrency: ci-${{ github.ref }} # Recommended if you intend to make multiple deployments in quick succession.
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Install and Build ğŸ”§ # This example project is built using npm and outputs the result to the 'build' folder. Replace with the commands required to build your project, or remove this step entirely if your site is pre-built.
        run: |
          npm ci
          npm run build

      - name: Deploy ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: build # The folder the action should deploy.
```

### 4.2. æ„å»ºå’Œå‘å¸ƒ docker é•œåƒ
æ˜¾ç„¶ï¼Œä½œä¸ºæŒç»­éƒ¨ç½²çš„ä¸€ä¸ªæ­¥éª¤ï¼Œdocker é•œåƒçš„æ„å»ºä¹Ÿåº”è¯¥é€šè¿‡ CI/CD æœåŠ¡å™¨æ¥å®Œæˆå¹¶å‘å¸ƒã€‚è¿™æ˜¯ docker å®˜æ–¹çš„ä¸€ä¸ª actionï¼Œ id æ˜¯ docker/build-push-actionã€‚

### 4.3. Github Release
ä¸€èˆ¬åœ°ï¼ŒPython é¡¹ç›®çš„å‘å¸ƒéƒ½æ˜¯é€šè¿‡ PyPI æ¥å®Œæˆçš„ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†å…¶å‘å¸ƒåˆ° Github Release ä¸Šã€‚è¿™ä¸ª action çš„ id æ˜¯ softprops/action-gh-releaseã€‚

### 4.4. åˆ¶è®¢å‘å¸ƒè‰æ¡ˆ
ç¼–å†™ release notes æ˜¯ä¸€ä»¶æ¯ç‡¥ä¹å‘³çš„äº‹ã€‚è¿™ä¸ª action å¯ä»¥å¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨ç”Ÿæˆ release notesã€‚å®ƒçš„ id æ˜¯ relase-drafter/release-drafterã€‚

è¿™ä¸ª action å¯ä»¥ä¸ GH Release ä¸€èµ·ä½¿ç”¨ã€‚

è¿˜æœ‰ä¸€äº›å¥½ç©çš„ actionï¼Œæ¯”å¦‚ä¸€ä¸ªç”Ÿæˆè´ªåƒè›‡æ¸¸æˆçš„ actionï¼Œid æ˜¯ Platane/snkã€‚å®ƒä¼šç”Ÿæˆå¦‚ä¸‹çš„è´ªåƒè›‡æ¸¸æˆï¼š

![](https://images.jieyu.ai/images/2023/12/github-contribution-grid-snake.svg)

### 4.5. é€šçŸ¥æ¶ˆæ¯
æˆ‘ä»¬å·²ç»ä»‹ç»äº†é‚®ä»¶é€šçŸ¥ã€‚åœ¨åº”ç”¨å¸‚åœºé‡Œï¼Œè¿˜æœ‰å„ç§å„æ ·çš„é€šçŸ¥ actionï¼Œæ¯”å¦‚ Slack é€šçŸ¥ï¼Œid æ˜¯ Ilshidur/action-slackã€‚

### 4.6. Giscus
Giscus æ˜¯ä¸€ä¸ªåŸºäº Github Discussion çš„è¯„è®ºç³»ç»Ÿã€‚å®ƒçš„ id æ˜¯ giscus/giscusã€‚å¦‚æœä½ ä½¿ç”¨äº† gitpages ä½œä¸ºåšå®¢å’Œé™æ€ç«™ç³»ç»Ÿï¼Œä½ å¯ä»¥åœ¨ Github ä¸Šå®‰è£…å®ƒï¼Œå¹¶åœ¨åšå®¢å’Œé™æ€ç«™ç³»ç»Ÿä¸­å¢åŠ è¯„è®ºåŠŸèƒ½ã€‚

## 5. é€šè¿‡ Github CI å‘å¸ƒ Python åº“
æˆ‘ä»¬åœ¨å‰é¢çœ‹åˆ°çš„ä¾‹å­æ¥è‡ªäº`ppw`ç”Ÿæˆçš„é¡¹ç›®ä¸‹çš„.github\workflows\dev.yml æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶å®šä¹‰çš„å·¥ä½œæµé€‚ç”¨äºæ‰€æœ‰çš„åˆ†æ”¯ï¼Œåœ¨æ¯æ¬¡ push æ—¶éƒ½ä¼šè§¦å‘ã€‚å®ƒçš„ä½œç”¨æ˜¯è¿›è¡Œé›†æˆæµ‹è¯•ï¼Œæ„å»ºæµ‹è¯•åŒ…å¹¶å‘å¸ƒåˆ° testpypiï¼Œå¹¶å‘å¸ƒéæ­£å¼æ–‡æ¡£åˆ° Github Pages ä¸Šã€‚

æ­£å¼çš„ç‰ˆæœ¬å‘å¸ƒå·¥ä½œäº¤ç»™äº† release.ymlã€‚è¿™ä¸ªå·¥ä½œæµä»…é€‚ç”¨äº main åˆ†æ”¯ï¼Œå¹¶ä¸”åªæœ‰å½“ main åˆ†æ”¯ä¸Šæœ‰æ‰“æ ‡ç­¾äº‹ä»¶å‘ç”Ÿï¼Œå¹¶ä¸”æ ‡ç­¾æ˜¯ä»¥'v'å­—çº¿å¼€å¤´æ—¶ï¼Œæ‰ä¼šçœŸæ­£è¿è¡Œã€‚ä¸‹é¢æ˜¯è¿™ä¸ªå·¥ä½œæµçš„å†…å®¹ï¼š
```yaml title="release.yml"
# PUBLISH PACKAGE ON RELEASE BRANCH IF IT'S TAGGED WITH 'V*'

name: build & release

# CONTROLS WHEN THE ACTION WILL RUN.
on:
  # TRIGGERS THE WORKFLOW ON PUSH OR PULL REQUEST EVENTS BUT ONLY FOR THE MASTER BRANCH
  push:
    branch: [main, master]
    tags:
      - 'v*'

  # ALLOWS YOU TO RUN THIS WORKFLOW MANUALLY FROM THE ACTIONS TAB
  workflow_dispatch:

# A WORKFLOW RUN IS MADE UP OF ONE OR MORE JOBS THAT CAN RUN SEQUENTIALLY OR IN PARALLEL
jobs:
  release:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-versions: ['3.9']

    # MAP STEP OUTPUTS TO JOB OUTPUTS SO THEY CAN BE SHARE AMONG JOBS
    outputs:
      package_version: ${{ steps.variables_step.outputs.package_version }}
      package_name: ${{ steps.variables_step.outputs.package_name }}
      repo_name: ${{ steps.variables_step.outputs.repo_name }}
      repo_owner: ${{ steps.variables_step.outputs.repo_owner }}

    # STEPS REPRESENT A SEQUENCE OF TASKS THAT WILL BE EXECUTED AS PART OF THE JOB
    steps:
      # CHECKS-OUT YOUR REPOSITORY UNDER $GITHUB_WORKSPACE, SO YOUR JOB CAN ACCESS IT
      - uses: actions/checkout@v2

      - name: build change log
        id: build_changelog
        uses: mikepenz/release-changelog-builder-action@v3.2.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-versions }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tox-gh-actions poetry

        # DECLARE PACKAGE_VERSION, REPO_OWNER, REPO_NAME, PACKAGE_NAME SO YOU MAY USE IT IN WEB HOOKS.
      - name: Declare variables for convenient use
        id: variables_step
        run: |
          echo "::set-output name=repo_owner::${GITHUB_REPOSITORY%/*}"
          echo "::set-output name=repo_name::${GITHUB_REPOSITORY#*/}"
          echo "::set-output name=package_name::`poetry version | awk '{print $1}'`"
          echo "::set-output name=package_version::`poetry version --short`"
        shell: bash

      - name: publish documentation
        run: |
          poetry install -E dev
          poetry run mkdocs build
          git config --global user.name Docs deploy
          git config --global user.email docs@dummy.bot.com
          poetry run mike deploy -p -f --ignore `poetry version --short`
          poetry run mike set-default -p `poetry version --short`

      - name: Build wheels and source tarball
        run: |
          poetry lock
          poetry build

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: ${{ steps.build_changelog.outputs.changelog }}
          draft: false
          prerelease: false

      - name: publish to PYPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip_existing: true
```
è¿™ä¸ªå·¥ä½œæµç”¨åˆ°çš„è¯­æ³•ç‰¹æ€§å‰é¢å·²ç»è®²è¿‡äº†ã€‚è¿™é‡Œå°±ä¸å†è§£é‡Šã€‚
