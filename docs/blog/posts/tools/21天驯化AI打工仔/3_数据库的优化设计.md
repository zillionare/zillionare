# 21 å¤©é©¯åŒ– AI æ‰“å·¥ä»”ï¼šå¼€å‘é‡åŒ–äº¤æ˜“ç³»ç»Ÿï¼ˆä¸‰ï¼‰æ•°æ®åº“çš„ä¼˜åŒ–è®¾è®¡

## å‰è¨€
äº”ä¸€å°é•¿å‡ä¹‹å‰ï¼Œæˆ‘åœ¨æ­æ¡£ 007 çš„å¸®åŠ©ä¸‹å·²ç»æˆåŠŸå®ç°äº†ä» Tushare è·å– OHLC æ•°æ®ï¼Œå¹¶é€šè¿‡ Redis æ¶ˆæ¯é˜Ÿåˆ—å°†æ•°æ®å­˜å‚¨åˆ° ClickHouse æ•°æ®åº“ã€‚ä¸ºäº†è¿›ä¸€æ­¥å®Œå–„é‡åŒ–äº¤æ˜“ç³»ç»Ÿçš„æ•°æ®æ”¯æŒï¼Œä»Šå¤©æˆ‘ä»¬å°†èšç„¦äºæ•°æ®åº“çš„ä¼˜åŒ–è®¾è®¡ï¼Œä¸»è¦æ¶‰åŠè·å–æ—¥çº¿å¤æƒå› å­ã€è·å–åˆ†é’Ÿçº¿æ•°æ®ä»¥åŠè®¡ç®—åˆ†é’Ÿçº¿æ•°æ®ï¼ˆä¾‹å¦‚ 15 åˆ†é’Ÿï¼‰ä¸‰ä¸ªæ–¹é¢ã€‚äº”ä¸€ç»“æŸä¹‹åï¼Œæˆ‘ä»¬è®¡åˆ’é€šè¿‡è¿™äº›ä¼˜åŒ–ï¼Œèƒ½å¤Ÿä¸ºé‡åŒ–äº¤æ˜“ç­–ç•¥æä¾›æ›´ä¸°å¯Œã€æ›´ç²¾ç»†çš„æ•°æ®ï¼Œä»è€Œæå‡ç³»ç»Ÿçš„æ€§èƒ½å’Œå†³ç­–èƒ½åŠ›ã€‚

## 1. è·å–æ—¥çº¿çš„å¤æƒå› å­
> æˆ‘ï¼š007ï¼å¸®æˆ‘åœ¨ `data_producer.py` å’Œ `data_consumer.py` ä¸­æ·»åŠ è·å–æ—¥çº¿å› å­çš„ä»£ç ã€‚
> 
> 007ï¼šğŸ«¡æ”¶åˆ°è¯·æ±‚ï¼Œæ­£åœ¨å¤„ç†...

ä¸ºäº†åœ¨ `data_consumer.py` å’Œ `data_producer.py` ä¸­è¡¥å……å› å­çš„æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦å¯¹åŸä»£ç è¿›è¡Œä¸€äº›ä¿®æ”¹ã€‚ä¸»è¦æ€è·¯æ˜¯åœ¨ç”Ÿäº§è€…ä»£ç ä¸­è·å–å› å­æ•°æ®å¹¶å°è£…åˆ°æ•°æ®ç»“æ„ä¸­ï¼Œç„¶ååœ¨æ¶ˆè´¹è€…ä»£ç ä¸­å¤„ç†è¿™äº›å› å­æ•°æ®ã€‚å› ä¸ºåç»­æˆ‘ä»¬è¦æ”¶é›†åˆ†é’Ÿçº§çš„æ•°æ®ï¼Œæ‰€ä»¥æˆ‘æ–°å»ºäº†ä¸€å¼ è¡¨ï¼Œå‘½åä¸º `daily_data`ï¼Œç”¨äºå­˜å‚¨æ—¥çº¿å› å­æ•°æ®ã€‚


![](https://images.jieyu.ai/images/2025/05/3_01.png)

ç„¶åï¼Œæˆ‘éœ€è¦é’ˆå¯¹è¿™ä¸ªæ•°æ®è¡¨ï¼Œå¯¹ `data_producer.py` å’Œ `data_consumer.py` è¿›è¡Œä¿®æ”¹ã€‚

![](https://images.jieyu.ai/images/2025/05/3_02.png)

007 å›ç­”æˆ‘çš„å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```python
"""data_producer.py"""
import redis
import tushare as ts
import json
from datetime import datetime

# Tushareå’ŒRedisé…ç½®
TUSHARE_TOKEN = "YOUR TOKEN"
REDIS_HOST = "localhost"
REDIS_PORT = 6379
REDIS_QUEUE_NAME = "tushare_data_queue"

# åˆå§‹åŒ–è¿æ¥
pro = ts.pro_api(TUSHARE_TOKEN)
redis_client = redis.StrictRedis(host=REDIS_HOST, port=REDIS_PORT, decode_responses=True)

def fetch_ohlc_daily_data(ts_code: str, start_date: str, end_date: str) -> list:
    try:
        df = pro.daily(ts_code=ts_code, start_date=start_date, end_date=end_date)
        return df[['ts_code', 'trade_date', 'open', 'high', 'low', 'close', 'vol']].to_dict('records')
    except Exception as e:
        print(f"OHLCæ•°æ®è·å–å¤±è´¥: {str(e)}")
        return []

def fetch_adj_factor(ts_code: str, start_date: str, end_date: str) -> list:
    try:
        df = pro.adj_factor(ts_code=ts_code, start_date=start_date, end_date=end_date)
        return df[['ts_code', 'trade_date', 'adj_factor']].to_dict('records')
    except Exception as e:
        print(f"å¤æƒå› å­è·å–å¤±è´¥: {str(e)}")
        return []
def produce_data(ts_code_list: list, date_range: tuple):
    start_date, end_date = date_range
    for ts_code in ts_code_list:
        data_package = {
            "timestamp": datetime.now().isoformat(),
            "ts_code": ts_code,
            "ohlc_data": fetch_ohlc_daily_data(ts_code, start_date, end_date),
            "adj_factor": fetch_adj_factor(ts_code, start_date, end_date)
        }
        redis_client.lpush(REDIS_QUEUE_NAME, json.dumps(data_package))
        print(f"å·²æ¨é€æ•°æ®: {ts_code} - {start_date}è‡³{end_date}")

if __name__ == "__main__":
    STOCK_CODES = ["000001.SZ", "600519.SH"]
    DATE_RANGE = ("20230101", "20231231")
    produce_data(STOCK_CODES, DATE_RANGE)
```

```python
"""data_consumer.py"""
import redis
import json
from clickhouse_driver import Client
from datetime import datetime

# é…ç½®å‚æ•°
REDIS_HOST = "localhost"
REDIS_PORT = 6379
REDIS_QUEUE_NAME = "tushare_data_queue"

CLICKHOUSE_HOST = "localhost"
CLICKHOUSE_PORT = 9000
CLICKHOUSE_DB = "default"

# åˆå§‹åŒ– Redis å’Œ ClickHouse å®¢æˆ·ç«¯
redis_client = redis.StrictRedis(host=REDIS_HOST, port=REDIS_PORT, decode_responses=True)
clickhouse_client = Client(host=CLICKHOUSE_HOST, port=CLICKHOUSE_PORT, database=CLICKHOUSE_DB)

def insert_to_clickhouse(data):
    """å°†æ•°æ®æ’å…¥åˆ° ClickHouse"""
    query = """
    INSERT INTO daily_data (ts_code, trade_date, open, high, low, close, vol, adj_factor)
    VALUES
    """
    values = []
    for record in data["ohlc_data"]:
        adj_factor_record = next((adj for adj in data["adj_factor"] if adj["trade_date"] == record["trade_date"]), None)
        adj_factor = adj_factor_record["adj_factor"] if adj_factor_record else None
        values.append((
            record["ts_code"],
            datetime.strptime(record["trade_date"], "%Y%m%d").date(),
            record["open"],
            record["high"],
            record["low"],
            record["close"],
            record["vol"],
            adj_factor
        ))
    clickhouse_client.execute(query, values)

def consume_data():
    """æ•°æ®æ¶ˆè´¹ä¸»å‡½æ•°"""
    print("å¯åŠ¨æ•°æ®æ¶ˆè´¹è€…ï¼Œç­‰å¾…é˜Ÿåˆ—æ•°æ®...")
    while True:
        try:
            # é˜»å¡å¼è·å–é˜Ÿåˆ—æ•°æ®
            result = redis_client.brpop(REDIS_QUEUE_NAME, timeout=1)
            if result is None:
                # å¦‚æœæ²¡æœ‰è·å–åˆ°æ•°æ®ï¼Œè¯´æ˜é˜Ÿåˆ—ä¸ºç©ºï¼Œé€€å‡ºå¾ªç¯
                print("Redis é˜Ÿåˆ—ä¸ºç©ºï¼Œåœæ­¢æ¶ˆè´¹æ•°æ®ã€‚")
                break
            _, json_data = result
            data_package = json.loads(json_data)
            insert_to_clickhouse(data_package)
            print(f"æˆåŠŸæ’å…¥æ•°æ®: {len(data_package['ohlc_data'])} æ¡")
        except Exception as e:
            print(f"æ•°æ®å¤„ç†å¼‚å¸¸: {str(e)}")
            continue

if __name__ == "__main__":
    consume_data()
```

## 2. è·å–åˆ†é’Ÿçº¿æ•°æ®
åŒä¸Šè¿°æ­¥éª¤ï¼Œæˆ‘éœ€è¦è·å–åˆ†é’Ÿçº¿æ•°æ®ï¼Œå¹¶æ·»åŠ åˆ°æ•°æ®è¡¨ä¸­ã€‚

![](https://images.jieyu.ai/images/2025/05/3_03.png)

007 ç»™æˆ‘æä¾›äº†ä»¥ä¸‹å»ºè®®ï¼š
1. é¦–å…ˆåˆ›å»ºåˆ†é’Ÿçº¿æ•°æ®è¡¨ï¼›
2. ä¿®æ”¹ç”Ÿäº§è€…ä»£ç ï¼Œæ·»åŠ åˆ†é’Ÿçº¿æ•°æ®è·å–åŠŸèƒ½ï¼›
3. åˆ›å»ºå¯¹åº”çš„æ¶ˆè´¹è€…ä»£ç ã€‚

###  2.1. åˆ›å»ºåˆ†é’Ÿçº¿æ•°æ®è¡¨
<!--
!!! Warning æ³¨æ„
    è¿™é‡Œçš„åˆ†é’Ÿçº¿æ•°æ®è¡¨æ˜¯ä¸å«å› å­çš„ï¼-->

![](https://images.jieyu.ai/images/2025/05/3_04.png)

```sql
CREATE TABLE IF NOT EXISTS minute_data (
    ts_code String,
    trade_time DateTime,
    open Float32,
    high Float32,
    low Float32,
    close Float32,
    vol Float32,
    amount Float32
) ENGINE = MergeTree()
ORDER BY (ts_code, trade_time);
```

## 2.2. ä¿®æ”¹ç”Ÿäº§è€…ä»£ç ï¼Œæ·»åŠ åˆ†é’Ÿçº¿æ•°æ®è·å–åŠŸèƒ½
007 è¿˜æ˜¯é‡‡ç”¨ tushare æ¥è·å–åˆ†é’Ÿçº¿æ•°æ®ï¼Œå¹¶æ·»åŠ åˆ°æ•°æ®è¡¨ä¸­ã€‚ä½†æ˜¯ï¼Œè¿™é‡Œè·å–åˆ†é’Ÿçº¿æ•°æ®æˆ‘å¹¶ä¸æ‰“ç®—ç”¨ tushare ä½œä¸ºæ•°æ®æºï¼Œè€Œæ˜¯æ‰“ç®—é‡‡ç”¨ qmt æä¾›çš„ API æ¥å£æ¥è·å–åˆ†é’Ÿçº§çš„æ•°æ®ã€‚

<!--
!!! note æ”¹ç”¨ qmt çš„ä¸€äº›ç†ç”±
    QMTï¼ˆè¿…æŠ•æé€Ÿç­–ç•¥äº¤æ˜“ç³»ç»Ÿï¼‰ç›¸è¾ƒäº Tushare åœ¨è·å–åˆ†é’Ÿçº¿æ•°æ®æ–¹é¢æœ‰ä¸€äº›ä¼˜åŠ¿ï¼Œä»¥ä¸‹æ˜¯å…·ä½“åŸå› ï¼š

    | æ¯”è¾ƒç»´åº¦ | QMT | Tushare |
    | --- | --- | --- |
    | æ•°æ®å®æ—¶æ€§ä¸å‡†ç¡®æ€§ | **å®æ—¶æ€§é«˜**ï¼šé€šå¸¸ä¸åˆ¸å•†äº¤æ˜“ç³»ç»Ÿæ·±åº¦é›†æˆï¼Œèƒ½ç›´æ¥ä»äº¤æ˜“æ‰€è·å–æœ€åŠæ—¶è¡Œæƒ…æ•°æ®ï¼Œåˆ†é’Ÿçº¿é«˜é¢‘æ•°æ®å‡ ä¹å®æ—¶æ›´æ–°ã€‚<br>**æ•°æ®å‡†ç¡®æ€§å¼º**ï¼šç›´æ¥å¯¹æ¥äº¤æ˜“æ‰€æ•°æ®ï¼Œå‡å°‘ä¸­é—´ç¯èŠ‚è¯¯å·®å’Œå»¶è¿Ÿï¼Œä¿è¯åˆ†é’Ÿçº¿æ•°æ®å‡†ç¡®å®Œæ•´ã€‚ | æ•°æ®æ›´æ–°æœ‰å»¶è¿Ÿï¼šæ•°æ®ç»æ•´ç†èšåˆåæä¾›ï¼Œè·å–åˆ†é’Ÿçº¿é«˜é¢‘æ•°æ®æ—¶ä¸å¯é¿å…å­˜åœ¨å»¶è¿Ÿã€‚<br>æ•°æ®è´¨é‡ä¾èµ–æ•°æ®æºï¼šæœ¬èº«ä¸ç›´æ¥ä»äº¤æ˜“æ‰€è·å–æ•°æ®ï¼Œæ•°æ®è´¨é‡å—åˆä½œæ•°æ®æºå½±å“ï¼Œå¯èƒ½å­˜åœ¨æ•°æ®ç¼ºå¤±æˆ–ä¸å‡†ç¡®æƒ…å†µã€‚ |
    | æ•°æ®è·å–æ€§èƒ½ | **ä½å»¶è¿Ÿ**ï¼šç³»ç»Ÿç»è¿‡ä¼˜åŒ–ï¼Œæ•°æ®ä¼ è¾“å’Œå¤„ç†å»¶è¿Ÿä½ï¼Œèƒ½å¿«é€Ÿå“åº”æä¾›åˆ†é’Ÿçº¿æ•°æ®ã€‚<br>**é«˜å¹¶å‘å¤„ç†èƒ½åŠ›**ï¼šå¯æ”¯æŒå¤§é‡ç”¨æˆ·åŒæ—¶è¯·æ±‚æ•°æ®ï¼Œé«˜å¹¶å‘ä¸‹ä¹Ÿèƒ½å¿«é€Ÿè·å–åˆ†é’Ÿçº¿æ•°æ®ã€‚ | å­˜åœ¨æ€§èƒ½ç“¶é¢ˆï¼šä½œä¸ºé¢å‘å¹¿å¤§ç”¨æˆ·çš„æ•°æ®æœåŠ¡å¹³å°ï¼Œå—æœåŠ¡å™¨æ€§èƒ½å’Œå¸¦å®½é™åˆ¶ï¼Œé«˜å¹¶å‘æ—¶æ•°æ®è·å–é€Ÿåº¦å—å½±å“ï¼Œå°¤å…¶å¯¹äºå¤§é‡åˆ†é’Ÿçº¿æ•°æ®è¯·æ±‚ã€‚ |
    | åˆè§„æ€§ä¸å®‰å…¨æ€§ | **åˆè§„æ€§å¼º**ï¼šæ˜¯åˆ¸å•†æä¾›çš„ä¸“ä¸šäº¤æ˜“ç³»ç»Ÿï¼Œä¸¥æ ¼éµå®ˆé‡‘èè¡Œä¸šç›‘ç®¡è¦æ±‚å’Œåˆè§„æ ‡å‡†ï¼Œæ•°æ®è·å–å’Œä½¿ç”¨åˆæ³•åˆè§„ã€‚<br>**æ•°æ®å®‰å…¨æœ‰ä¿éšœ**ï¼šåˆ¸å•†é‡‡ç”¨ä¸¥æ ¼å®‰å…¨æªæ–½ä¿æŠ¤ç”¨æˆ·æ•°æ®å®‰å…¨ï¼Œå¦‚æ•°æ®åŠ å¯†ã€è®¿é—®æ§åˆ¶ç­‰ï¼Œå¯¹æ•æ„Ÿäº¤æ˜“ä¿¡æ¯çš„åˆ†é’Ÿçº¿æ•°æ®å¾ˆé‡è¦ã€‚ | åˆè§„é£é™©ï¼šæ•°æ®æ¥æºå’Œä½¿ç”¨å¯èƒ½å­˜åœ¨åˆè§„é£é™©ï¼Œæ•°æ®é‡‡é›†å’Œåˆ†å‘è¿‡ç¨‹å¯èƒ½å—ç›¸å…³æ³•å¾‹æ³•è§„é™åˆ¶ã€‚<br>æ•°æ®å®‰å…¨éšæ‚£ï¼šä½œä¸ºç¬¬ä¸‰æ–¹æ•°æ®å¹³å°ï¼Œæ•°æ®å®‰å…¨æªæ–½ç›¸å¯¹è¾ƒå¼±ï¼Œå­˜åœ¨æ•°æ®æ³„éœ²é£é™©ã€‚ |
    -->

![](https://images.jieyu.ai/images/2025/05/3_05.png)

007 æ·»åŠ äº†ä¸€ä¸ªæ–°çš„ç”Ÿäº§è€…ä»£ç æ–‡ä»¶ `minute_producer.py`ï¼Œåœ¨ `data_producer.py` çš„åŸºç¡€ä¸Šä¸»è¦ä¿®æ”¹å†…å®¹ï¼š
- æ›¿æ¢äº† Tushare ä¸º QMT çš„æ•°æ®æ¥å£
- æ·»åŠ äº†æ•°æ®ä¸‹è½½åŠŸèƒ½
- ä½¿ç”¨ QMT çš„ `get_local_data` è·å–åˆ†é’Ÿçº¿æ•°æ®
- å¢åŠ äº†äº¤æ˜“æ—¥æœŸçš„å¤„ç†

ä½†æ˜¯æˆ‘åœ¨æ­¤å¤„é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œqmt ç›®å‰åªæ”¯æŒ windows ç³»ç»Ÿï¼Œè€Œæˆ‘çš„ç³»ç»Ÿæ˜¯ macos ï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨ qmtã€‚

007 æä¾›äº†ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œä½¿ç”¨ redis ä½œä¸ºä¸­é—´ä»¶ï¼ŒæŠŠ windows çš„æ•°æ®ä¼ é€’ç»™ macos çš„ç¨‹åºï¼Œå¹¶æœ€ç»ˆå­˜å‚¨åœ¨ clickhouse ä¸­ã€‚


![](https://images.jieyu.ai/images/2025/05/3_06.png)

ä¾æ® 007 çš„å¥½å»ºè®®ï¼Œæˆ‘å®Œæˆäº†ä»¥ä¸‹ä»£ç ã€‚
### 2.2.3. windows çš„æ•°æ®ç”Ÿäº§è€…ä»£ç 
007 åŸå…ˆçš„ä»£ç å¦‚ä¸‹ï¼š
```python
import redis
import json
from datetime import datetime
from xtquant.xtdata import (
    init,
    download_history_data,
    get_local_data,
    get_trading_dates,
    close
)

# Redisé…ç½® - ä½¿ç”¨Macçš„IPåœ°å€
REDIS_HOST = "æ›¿æ¢ä¸ºMacçš„IPåœ°å€"
REDIS_PORT = 6379
REDIS_QUEUE_NAME = "qmt_minute_queue"
REDIS_PASSWORD = None  # å¦‚æœæœ‰å¯†ç ï¼Œè¯·è®¾ç½®

def setup_redis_client():
    """åˆå§‹åŒ–Rediså®¢æˆ·ç«¯"""
    return redis.StrictRedis(
        host=REDIS_HOST, 
        port=REDIS_PORT, 
        password=REDIS_PASSWORD,
        decode_responses=True
    )

def fetch_minute_data(stock_code, date_str):
    """è·å–æŒ‡å®šæ—¥æœŸçš„åˆ†é’Ÿçº¿æ•°æ®"""
    try:
        # è·å–åˆ†é’Ÿçº¿æ•°æ®
        df = get_local_data(stock_code, 'min1', date_str, date_str)
        if df is None or len(df) == 0:
            return []
        
        # è½¬æ¢æ•°æ®æ ¼å¼
        records = []
        for time, row in df.iterrows():
            records.append({
                "ts_code": stock_code,
                "trade_time": time.strftime("%Y-%m-%d %H:%M:%S"),
                "open": float(row['open']),
                "high": float(row['high']),
                "low": float(row['low']),
                "close": float(row['close']),
                "vol": float(row['volume']),
                "amount": float(row['amount'])
            })
        return records
    except Exception as e:
        print(f"è·å–åˆ†é’Ÿçº¿æ•°æ®å¤±è´¥ {stock_code} {date_str}: {str(e)}")
        return []

def main():
    """ä¸»å‡½æ•°"""
    # åˆå§‹åŒ–QMTæ¥å£
    init()
        
    # åˆå§‹åŒ–Rediså®¢æˆ·ç«¯
    redis_client = setup_redis_client()
        
    try:
        # é…ç½®å‚æ•°
        stock_list = ["000001.SZ", "600519.SH"]
        start_date = "20230101"
        end_date = "20230131"
            
        # ä¸‹è½½å†å²æ•°æ®
        print(f"å¼€å§‹ä¸‹è½½å†å²æ•°æ®: {start_date} è‡³ {end_date}")
        download_history_data(stock_list, 'min1', start_date, end_date)
        print("å†å²æ•°æ®ä¸‹è½½å®Œæˆ")
            
        # è·å–äº¤æ˜“æ—¥åˆ—è¡¨
        trading_dates = get_trading_dates(start_date, end_date)
            
        # æŒ‰æ—¥æœŸå’Œè‚¡ç¥¨ä»£ç è·å–åˆ†é’Ÿçº¿æ•°æ®å¹¶å‘é€åˆ°Redis
        for trade_date in trading_dates:
            date_str = trade_date.strftime("%Y%m%d")
            print(f"å¤„ç†æ—¥æœŸ: {date_str}")
                
            for stock_code in stock_list:
                minute_data = fetch_minute_data(stock_code, date_str)
                
                if minute_data:
                    # å°è£…æ•°æ®
                    data_package = {
                        "timestamp": datetime.now().isoformat(),
                        "ts_code": stock_code,
                        "trade_date": date_str,
                        "minute_data": minute_data
                    }
                        
                    # å‘é€åˆ°Redis
                    redis_client.lpush(REDIS_QUEUE_NAME, json.dump(data_package))
                    print(f"å·²æ¨é€åˆ†é’Ÿçº¿æ•°æ®: {stock_code} - {date_str} ({len(minute_data)}æ¡)")
        
    except Exception as e:
        print(f"ç¨‹åºæ‰§è¡Œå¼‚å¸¸: {str(e)}")
        
    finally:
        # å…³é—­QMTæ¥å£
        close()
        print("ç¨‹åºæ‰§è¡Œå®Œæ¯•")

if __name__ == "__main__":
    main()
```

ä½†æ˜¯è¿™ä¸ªä»£ç æ˜¯ä¸å¯ä»¥è¿è¡Œçš„ï¼Œå› ä¸º qmt åº“çš„ç‰ˆæœ¬å¯èƒ½å‘ç”Ÿäº†æ”¹å˜ï¼Œæœ‰ä¸€äº›æ¨¡å—æ˜¯è¢«ç§»é™¤æˆ–ä¿®æ”¹çš„ã€‚è€Œä¸”æˆ‘ä»¬æƒ³ä» Windows æœºå™¨è¿æ¥åˆ° Mac ä¸Šè¿è¡Œçš„ Redis æœåŠ¡å™¨ã€‚è¿™æ¶‰åŠåˆ°ç½‘ç»œè¿æ¥ã€é˜²ç«å¢™è®¾ç½®ã€Redis é…ç½®ä»¥åŠå¯èƒ½çš„æƒé™é—®é¢˜ã€‚

é’ˆå¯¹ Redis çš„æœ‰å…³é—®é¢˜ï¼Œæˆ‘æ‰“ç®—ç»§ç»­ç”¨ 007 çš„â€œè´´å¿ƒä»£ç â€è¿›è¡Œ Redis è¿æ¥çš„æµ‹è¯•ã€‚
```python
# Redisé…ç½® - ä½¿ç”¨Macçš„IPåœ°å€
REDIS_HOST = "æ›¿æ¢ä¸ºMacçš„IPåœ°å€"
REDIS_PORT = 6379
REDIS_QUEUE_NAME = "qmt_minute_queue"
REDIS_PASSWORD = None  # å¦‚æœæœ‰å¯†ç ï¼Œè¯·è®¾ç½®


# æµ‹è¯•Redisè¿æ¥
import redis
import time

try:
    # åˆ›å»ºRediså®¢æˆ·ç«¯
    redis_client = redis.Redis(
        host=REDIS_HOST,
        port=REDIS_PORT,
        password=REDIS_PASSWORD,
        socket_timeout=5,
        decode_responses=True
    )
    
    # æµ‹è¯•è¿æ¥ - PINGå‘½ä»¤
    response = redis_client.ping()
    print(f"Redisè¿æ¥æµ‹è¯• (PING): {'æˆåŠŸ' if response else 'å¤±è´¥'}")
    
    # æµ‹è¯•åŸºæœ¬æ“ä½œ - å†™å…¥å’Œè¯»å–
    test_key = "test_connection_key"
    test_value = f"test_value_{time.time()}"
    
    # å†™å…¥æµ‹è¯•
    redis_client.set(test_key, test_value)
    print(f"Rediså†™å…¥æµ‹è¯•: æˆåŠŸå†™å…¥é”® '{test_key}'")
    
    # è¯»å–æµ‹è¯•
    read_value = redis_client.get(test_key)
    print(f"Redisè¯»å–æµ‹è¯•: {'æˆåŠŸ' if read_value == test_value else 'å¤±è´¥'}")
    print(f"å†™å…¥å€¼: {test_value}")
    print(f"è¯»å–å€¼: {read_value}")
    
    # æµ‹è¯•é˜Ÿåˆ—æ“ä½œ
    redis_client.lpush(REDIS_QUEUE_NAME, "æµ‹è¯•æ¶ˆæ¯")
    queue_length = redis_client.llen(REDIS_QUEUE_NAME)
    print(f"Redisé˜Ÿåˆ—æµ‹è¯•: æˆåŠŸå†™å…¥é˜Ÿåˆ— '{REDIS_QUEUE_NAME}'ï¼Œå½“å‰é˜Ÿåˆ—é•¿åº¦: {queue_length}")
    
    # æ¸…ç†æµ‹è¯•æ•°æ®
    redis_client.delete(test_key)
    
    print("Redisè¿æ¥å’ŒåŸºæœ¬æ“ä½œæµ‹è¯•å®Œæˆï¼Œè¿æ¥æ­£å¸¸")
    
except redis.exceptions.ConnectionError as e:
    print(f"Redisè¿æ¥é”™è¯¯: {str(e)}")
    print("è¯·æ£€æŸ¥ä»¥ä¸‹é—®é¢˜:")
    print("1. RedisæœåŠ¡å™¨æ˜¯å¦åœ¨è¿è¡Œ")
    print("2. IPåœ°å€æ˜¯å¦æ­£ç¡®")
    print("3. ç«¯å£æ˜¯å¦æ­£ç¡®")
    print("4. é˜²ç«å¢™æ˜¯å¦å…è®¸è¿æ¥")
    print("5. Redisæ˜¯å¦é…ç½®ä¸ºå…è®¸è¿œç¨‹è¿æ¥")
    
except Exception as e:
    print(f"Redisæµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°å…¶ä»–é”™è¯¯: {str(e)}")
```

æœ‰äº†æµ‹è¯•ä»£ç ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘ Redis çš„é»˜è®¤é…ç½®ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒRedis åªå…è®¸æœ¬åœ°è¿æ¥ï¼Œç»‘å®šåˆ° 127.0.0.1ã€‚å› æ­¤ï¼Œè¦å…è®¸è¿œç¨‹è¿æ¥ï¼Œå¿…é¡»ä¿®æ”¹ Redis çš„é…ç½®æ–‡ä»¶ï¼Œå°†ç»‘å®šåœ°å€æ”¹ä¸º 0.0.0.0 æˆ–è€… Mac çš„å±€åŸŸç½‘ IP åœ°å€ã€‚è¿™ä¸€æ­¥å¯èƒ½éœ€è¦ç”¨æˆ·ç¼–è¾‘ Redis çš„é…ç½®æ–‡ä»¶ï¼Œæ¯”å¦‚ redis.confï¼Œæ‰¾åˆ° bind å‚æ•°å¹¶ä¿®æ”¹ã€‚

1. ä¿®æ”¹ Redis é…ç½®æ–‡ä»¶
    é»˜è®¤æƒ…å†µä¸‹ï¼ŒRedis ä»…ç›‘å¬æœ¬åœ° IPï¼ˆ127.0.0.1ï¼‰ï¼Œéœ€è°ƒæ•´ä¸ºå…è®¸è¿œç¨‹è¿æ¥ï¼š
    - æ‰“å¼€é…ç½®æ–‡ä»¶
        ```bash
        sudo nano /usr/local/etc/redis.conf
        ```
    - ä¿®æ”¹ä»¥ä¸‹å‚æ•°ï¼š
      - ç»‘å®š IPï¼šå°† bind 127.0.0.1 æ”¹ä¸º bind 0.0.0.0ï¼ˆå…è®¸æ‰€æœ‰ IP è®¿é—®ï¼‰æˆ–æ›¿æ¢ä¸º Mac çš„å±€åŸŸç½‘ IPï¼ˆå¦‚ 192.168.1.100ï¼‰ã€‚
        ![](https://images.jieyu.ai/images/2025/05/3_07.png)
        
      - å…³é—­ä¿æŠ¤æ¨¡å¼ï¼šå°† `protected-mode yes` æ”¹ä¸º `protected-mode no`ã€‚
        ![](https://images.jieyu.ai/images/2025/05/3_08.png)
      - è®¾ç½®å¯†ç ï¼ˆå¯é€‰ä½†æ¨èï¼‰ï¼šå–æ¶ˆæ³¨é‡Š requirepass å¹¶è®¾ç½®å¯†ç ï¼š
        ```bash
        requirepass your_password
        ```
        ![](https://images.jieyu.ai/images/2025/05/3_09.png)
    - ä¿å­˜å¹¶é€€å‡ºï¼šæŒ‰ `Ctrl+O` ä¿å­˜ï¼Œ`Ctrl+X` é€€å‡ºã€‚

1. é‡å¯ Redis æœåŠ¡ï¼ˆäºŒé€‰ä¸€å³å¯ï¼‰
    ```bash
    brew services restart redis  # é€‚ç”¨äºHomebrewå®‰è£…
    redis-server /usr/local/etc/redis.conf  # æ‰‹åŠ¨é‡å¯
    ```

2. å¼€æ”¾ Mac é˜²ç«å¢™ç«¯å£
    - å›¾å½¢åŒ–æ“ä½œï¼š
      - è¿›å…¥ ç³»ç»Ÿåå¥½è®¾ç½® â†’ å®‰å…¨æ€§ä¸éšç§ â†’ é˜²ç«å¢™ã€‚
      - ç‚¹å‡»é”å›¾æ ‡è§£é”ï¼Œé€‰æ‹© é˜²ç«å¢™é€‰é¡¹ã€‚
      - ç‚¹å‡» + æ·»åŠ  redis-server åˆ°å…è®¸åˆ—è¡¨ã€‚
    - å‘½ä»¤è¡Œæ“ä½œï¼ˆéœ€ç®¡ç†å‘˜æƒé™ï¼‰ï¼š
    ```bash
    sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add /usr/local/bin/redis-server
    sudo /usr/libexec/ApplicationFirewall/socketfilterfw --unblockapp /usr/local/bin/redis-server
    ``` 

å®Œæˆä¸Šè¿°æ­¥éª¤ä¹‹åï¼Œæˆ‘ä»¬å¯¹ Windows ç«¯è¿›è¡Œé…ç½®ï¼ˆä¸‹è½½ Redis å®¢æˆ·ç«¯ï¼‰
1. å®‰è£… Redis å®¢æˆ·ç«¯
    - ä¸‹è½½ Windows ç‰ˆ Redisï¼šä» [Redis å®˜ç½‘](https://redis.io/downloads/) ä¸‹è½½ç¨³å®šç‰ˆï¼Œè§£å‹åˆ°ä»»æ„ç›®å½•ï¼ˆå¦‚ C:\redisï¼‰ã€‚
    - æ·»åŠ åˆ°ç³»ç»Ÿè·¯å¾„ï¼šå°† C:\redis\bin åŠ å…¥ç¯å¢ƒå˜é‡ PATHï¼Œä»¥ä¾¿åœ¨å‘½ä»¤è¡Œç›´æ¥ä½¿ç”¨ redis-cliã€‚

2. è¿æ¥ Redis æœåŠ¡å™¨
    - å‘½ä»¤æ ¼å¼ï¼š
    ```bash
    redis-cli -h <Macçš„å±€åŸŸç½‘IP> -p 6379 -a <å¯†ç >
    ```
      - ç¤ºä¾‹ï¼ˆå‡è®¾ Mac IP ä¸º 192.168.1.100ï¼Œå¯†ç ä¸º your_redis_passwordï¼‰ï¼š
        ```bash
        redis-cli -h 192.168.1.100 -p 6379 -a your_redis_password
        ```
      - éªŒè¯è¿æ¥ï¼š
        ```bash
        192.168.1.100:6379> PING
        PONG  # è¿æ¥æˆåŠŸ
        ```

ä¸Šé¢çš„æ­¥éª¤ä¾æ—§ä¸èƒ½ç¡®ä¿ Redis æœåŠ¡å™¨åœ¨ Windows ä¸Šå¯ä»¥æ¥å—æ¥è‡ª Mac çš„è¿æ¥ã€‚ï¼ˆè¿™é‡Œæˆ‘ä»¬å…ˆç•™ä¸€ä¸ªå‘å¦‚æœæœ‹å‹ä»¬æœ‰æƒ³æ³•ä¹Ÿå¯ä»¥åœ¨è¯„è®ºåŒºç•™ä¸‹ä½ ä»¬çš„è§£å†³æ–¹æ¡ˆï¼‰

### 2.2.4. macos çš„æ•°æ®æ¶ˆè´¹è€…ä»£ç 
   ```python
    import redis
    import json
    from clickhouse_driver import Client
    from datetime import datetime
    import time

    # Redisé…ç½®
    REDIS_HOST = "localhost"  # æœ¬åœ°Redisæˆ–Windowsçš„IP
    REDIS_PORT = 6379
    REDIS_QUEUE_NAME = "qmt_minute_queue"
    REDIS_PASSWORD = None  # å¦‚æœæœ‰å¯†ç ï¼Œè¯·è®¾ç½®

    # ClickHouseé…ç½®
    CLICKHOUSE_HOST = "localhost"
    CLICKHOUSE_PORT = 9000
    CLICKHOUSE_DB = "default"
    CLICKHOUSE_USER = "default"
    CLICKHOUSE_PASSWORD = ""

    def setup_redis_client():
        """åˆå§‹åŒ–Rediså®¢æˆ·ç«¯"""
        return redis.StrictRedis(
            host=REDIS_HOST, 
            port=REDIS_PORT, 
            password=REDIS_PASSWORD,
            decode_responses=True
        )

    def setup_clickhouse_client():
        """åˆå§‹åŒ–ClickHouseå®¢æˆ·ç«¯"""
        return Client(
            host=CLICKHOUSE_HOST,
            port=CLICKHOUSE_PORT,
            database=CLICKHOUSE_DB,
            user=CLICKHOUSE_USER,
            password=CLICKHOUSE_PASSWORD
        )

    def insert_to_clickhouse(client, data):
        """å°†åˆ†é’Ÿçº¿æ•°æ®æ’å…¥åˆ°ClickHouse"""
        if not data["minute_data"]:
            print("æ²¡æœ‰æ•°æ®éœ€è¦æ’å…¥")
            return 0
        
        query = """
        INSERT INTO minute_data 
        (ts_code, trade_time, open, high, low, close, vol, amount)
        VALUES
        """
        
        values = []
        for record in data["minute_data"]:
            values.append((
                record["ts_code"],
                datetime.strptime(record["trade_time"], "%Y-%m-%d %H:%M:%S"),
                record["open"],
                record["high"],
                record["low"],
                record["close"],
                record["vol"],
                record["amount"]
            ))
        
        if values:
            client.execute(query, values)
            return len(values)
        return 0

    def main():
        """ä¸»å‡½æ•°"""
        # åˆå§‹åŒ–å®¢æˆ·ç«¯
        redis_client = setup_redis_client()
        clickhouse_client = setup_clickhouse_client()
        
        print("å¯åŠ¨åˆ†é’Ÿçº¿æ•°æ®æ¶ˆè´¹è€…ï¼Œç­‰å¾…é˜Ÿåˆ—æ•°æ®...")
        
        try:
            while True:
                # å°è¯•ä»Redisè·å–æ•°æ®
                result = redis_client.brpop(REDIS_QUEUE_NAME, timeout=1)
                
                if result is None:
                    print("Redisé˜Ÿåˆ—ä¸ºç©ºï¼Œç­‰å¾…æ–°æ•°æ®...")
                    time.sleep(5)  # ç­‰å¾…5ç§’å†æ¬¡å°è¯•
                    continue
                
                # è§£ææ•°æ®
                _, json_data = result
                data_package = json.loads(json_data)
                
                # æ’å…¥ClickHouse
                inserted_count = insert_to_clickhouse(clickhouse_client, data_package)
                print(f"æˆåŠŸæ’å…¥åˆ†é’Ÿçº¿æ•°æ®: {data_package['ts_code']} - {data_package['trade_date']} ({inserted_count}æ¡)")
        
        except KeyboardInterrupt:
            print("ç¨‹åºè¢«æ‰‹åŠ¨ä¸­æ–­")
        
        except Exception as e:
            print(f"ç¨‹åºæ‰§è¡Œå¼‚å¸¸: {str(e)}")
        
        finally:
            print("ç¨‹åºæ‰§è¡Œå®Œæ¯•")

    if __name__ == "__main__":
        main()
   ```

ç”±äºwindowså’Œmacä¹‹é—´çš„redisè¿æ¥é—®é¢˜è¿˜å°šæœªè§£å†³ï¼Œæˆ‘æ‰“ç®—å…ˆæŠŠä» qmt å»åˆ°çš„åˆ†é’Ÿçº¿æ•°æ®å­˜å…¥ `000001.SH_data.csv` å’Œ `300750.SZ_data.csv`ï¼Œå°†å…¶ä¸­çš„æ•°æ®å­˜å…¥Clickhouseæ•°æ®åº“ä¸­ï¼Œå¹¶ä½¿ç”¨Pythonè¿›è¡Œæ•°æ®å¤„ç†ã€‚

```python
from xtquant import xtdata
import os
import pandas as pd

code_list = ['000001.SH', '300750.SZ']
period = '1h'
start_time = '20250101093000'
end_time = '20250201093000'

def on_data(datas):
    if datas:
        print(datas)
    else:
        print("æ•°æ®ä¸‹è½½å¤±è´¥æˆ–ä¸ºç©º")

xtdata.download_history_data2(code_list, period, start_time, end_time, on_data)

# åˆ›å»ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
save_dir = 'C:\\wbq'
os.makedirs(save_dir, exist_ok=True)

for code in code_list:
    data = xtdata.get_market_data_ex([], [code], period, start_time, end_time)
    if code in data and not data[code].empty:
        # ä¸ºæ¯ä¸ªè‚¡ç¥¨åˆ›å»ºå•ç‹¬çš„æ–‡ä»¶
        file_path = os.path.join(save_dir, f'{code}_data.csv')
        # ç¡®ä¿æ•°æ®æ˜¯DataFrameæ ¼å¼
        df = data[code]
        # ä¿å­˜æ•°æ®ï¼Œæ·»åŠ é”™è¯¯å¤„ç†
        try:
            df.to_csv(file_path)
            print(f'{code}æ•°æ®ä¿å­˜åˆ°æœ¬åœ°: {file_path}')
        except Exception as e:
            print(f'ä¿å­˜{code}æ•°æ®æ—¶å‡ºé”™: {str(e)}')
    else:
        print(f'{code}æ²¡æœ‰è·å–åˆ°æ•°æ®')

print("è¿è¡Œç»“æŸ")
```

![](https://images.jieyu.ai/images/2025/05/quantide.png)