# 21 å¤©é©¯åŒ– AI æ‰“å·¥ä»”ï¼šå¼€å‘é‡åŒ–äº¤æ˜“ç³»ç»Ÿ
## ï¼ˆå…«ï¼‰QMT å®æ—¶åˆ†ç¬”æ•°æ®è®¢é˜…ç³»ç»Ÿä¸å¤š Client é—®é¢˜

> å½“æ•°æ®å¦‚æ½®æ°´èˆ¬æ¶Œæ¥ï¼Œå¦‚ä½•è®©ç³»ç»Ÿç¨³å¦‚ç£çŸ³ï¼Ÿæœ¬æ–‡å¸¦ä½ æ·±å…¥ QMT å®æ—¶æ•°æ®è®¢é˜…çš„ä¸–ç•Œï¼Œè§è¯ 007 åŠ©æ‰‹å¦‚ä½•å°†ä¸€ä¸ªç®€å•çš„æ•°æ®è·å–ç¨‹åºï¼Œå‡çº§ä¸ºå¤„ç†èƒ½åŠ›æå‡ 10 å€çš„é«˜æ€§èƒ½ç³»ç»Ÿï¼

"007ï¼Œæˆ‘ä»¬çš„æ—¥çº¿æ•°æ®å®šæ—¶è·å–ç³»ç»Ÿå·²ç»å¾ˆç¨³å®šäº†ï¼Œä½†ç°åœ¨æˆ‘éœ€è¦æ›´ç»†ç²’åº¦çš„æ•°æ®â€”â€”åˆ†é’Ÿçº¿æ•°æ®ã€‚"æˆ‘ä¸€è¾¹æŸ¥çœ‹ç€ ClickHouse ä¸­çš„æ—¥çº¿æ•°æ®ï¼Œä¸€è¾¹å¯¹æˆ‘çš„ AI åŠ©æ‰‹è¯´é“ã€‚

"æ”¶åˆ°ğŸ«¡ï¼åˆ†é’Ÿçº¿æ•°æ®çš„å®æ—¶æ€§è¦æ±‚æ›´é«˜ï¼Œæˆ‘ä»¬éœ€è¦è®¾è®¡ä¸€ä¸ªå…¨æ–°çš„æ¶æ„ã€‚"007 ç«‹åˆ»å›åº”é“ã€‚

è¿™æ˜¯æˆ‘ä»¬é‡åŒ–äº¤æ˜“ç³»ç»Ÿå¼€å‘çš„ç¬¬ 8 å¤©ã€‚å‰é¢å‡ å¤©ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸæ­å»ºäº†æ—¥çº¿æ•°æ®çš„å®šæ—¶è·å–ç³»ç»Ÿï¼Œä½†åœ¨å®é™…é‡åŒ–ç­–ç•¥å¼€å‘ä¸­ï¼Œæˆ‘å‘ç°ä»…æœ‰æ—¥çº¿æ•°æ®æ˜¯è¿œè¿œä¸å¤Ÿçš„ã€‚é«˜é¢‘äº¤æ˜“ã€æ—¥å†…ç­–ç•¥ã€æŠ€æœ¯åˆ†æç­‰éƒ½éœ€è¦æ›´ç»†ç²’åº¦çš„åˆ†é’Ÿçº¿æ•°æ®ã€‚

ä½œä¸ºä¸€ä¸ªé‡åŒ–äº¤æ˜“çˆ±å¥½è€…ï¼Œæˆ‘ä¸€ç›´åœ¨å¯»æ‰¾ä¸€ä¸ªç¨³å®šã€é«˜æ•ˆçš„å®æ—¶æ•°æ®è·å–æ–¹æ¡ˆã€‚å¸‚é¢ä¸Šçš„æ•°æ®æœåŠ¡è¦ä¹ˆå¤ªè´µï¼ˆåŠ¨è¾„å‡ ä¸‡å…ƒä¸€å¹´ï¼‰ï¼Œè¦ä¹ˆå»¶è¿Ÿå¤ªé«˜ï¼ˆå‡ ç§’ç”šè‡³å‡ åˆ†é’Ÿï¼‰ï¼Œè¦ä¹ˆè¦†ç›–é¢ä¸å¤Ÿï¼ˆåªæœ‰ä¸»æµè‚¡ç¥¨ï¼‰ã€‚QMTï¼ˆè¿…æŠ• QMT é‡åŒ–äº¤æ˜“å¹³å°ï¼‰æä¾›äº†ä¸°å¯Œçš„æ•°æ®æ¥å£ï¼Œå¯ä»¥è·å–å®æ—¶çš„è‚¡ç¥¨è¡Œæƒ…æ•°æ®ã€‚äºæ˜¯ï¼Œæˆ‘å†³å®šåŸºäº QMT æ­å»ºä¸€å¥—å±äºè‡ªå·±çš„å®æ—¶åˆ†é’Ÿçº¿æ•°æ®è®¢é˜…ç³»ç»Ÿã€‚è¿™ä¸ªè¿‡ç¨‹å……æ»¡äº†æŒ‘æˆ˜ï¼Œä¹Ÿæ”¶è·äº†å¾ˆå¤šç»éªŒã€‚ä»æœ€åˆçš„åŸºç¡€ç‰ˆåˆ°åæ¥çš„å¢å¼ºç‰ˆï¼Œæ€§èƒ½å¤§å¹…æå‡ï¼Œç¨³å®šæ€§ä¹Ÿå¤§å¹…æ”¹å–„ã€‚ä»Šå¤©å°±æ¥åˆ†äº«ä¸€ä¸‹è¿™ä¸ªå®Œæ•´çš„å¼€å‘å†ç¨‹ã€‚

## ğŸ“‹ éœ€æ±‚åˆ†æï¼šæˆ‘ä»¬è¦åšä»€ä¹ˆ

"åœ¨å¼€å§‹ç¼–ç ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®ç³»ç»Ÿçš„æ ¸å¿ƒéœ€æ±‚ã€‚"æˆ‘å¯¹ 007 è¯´é“ã€‚

ç»è¿‡æ·±å…¥æ€è€ƒï¼Œæˆ‘ä»¬æ¢³ç†å‡ºäº†ä»¥ä¸‹å…³é”®éœ€æ±‚ï¼š

!!! note
    **æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚**
    1. **å®æ—¶è·å–è‚¡ç¥¨åˆ†é’Ÿçº¿æ•°æ®**ï¼šåŒ…æ‹¬å¼€é«˜ä½æ”¶ã€æˆäº¤é‡ã€æˆäº¤é¢ç­‰åŸºç¡€æ•°æ®
    2. **æ”¯æŒå…¨å¸‚åœºè‚¡ç¥¨**ï¼šA è‚¡ä¸»æ¿ã€ä¸­å°æ¿ã€åˆ›ä¸šæ¿ã€ç§‘åˆ›æ¿ï¼Œè¦†ç›– 4000+ åªè‚¡ç¥¨
    3. **è·¨å¹³å°æ•°æ®ä¼ è¾“**ï¼šWindows ç«¯è·å–æ•°æ®ï¼ŒMac ç«¯å­˜å‚¨å’ŒæŸ¥è¯¢
    4. **å¤šæ—¶é—´å‘¨æœŸæ”¯æŒ**ï¼š1 åˆ†é’Ÿã€5 åˆ†é’Ÿã€30 åˆ†é’Ÿã€æ—¥çº¿ç­‰å¤šç§å‘¨æœŸ
    5. **é«˜å¯ç”¨æ€§**ï¼š7Ã—24 å°æ—¶ç¨³å®šè¿è¡Œï¼Œè‡ªåŠ¨é‡è¿å’Œé”™è¯¯æ¢å¤

    **æ€§èƒ½è¦æ±‚**
    - **ä½å»¶è¿Ÿ**ï¼šæ•°æ®å»¶è¿Ÿæ§åˆ¶åœ¨ 1 ç§’ä»¥å†…
    - **é«˜åå**ï¼šæ”¯æŒæ¯ç§’å¤„ç† 1000+ æ¡æ•°æ®
    - **é«˜å¯é æ€§**ï¼šæ•°æ®ä¸¢å¤±ç‡æ§åˆ¶åœ¨ 0.1% ä»¥ä¸‹
    - **å¯æ‰©å±•æ€§**ï¼šåç»­å¯ä»¥æ¥å…¥æ›´å¤šæ•°æ®æºå’Œå¤„ç†é€»è¾‘
    
    **æŠ€æœ¯çº¦æŸ**
    - **QMT é™åˆ¶**ï¼šåªèƒ½åœ¨ Windows ç¯å¢ƒè¿è¡Œ
    - **ç½‘ç»œç¯å¢ƒ**ï¼šéœ€è¦è·¨ç½‘ç»œä¼ è¾“æ•°æ®
    - **å­˜å‚¨éœ€æ±‚**ï¼šæµ·é‡æ—¶åºæ•°æ®çš„é«˜æ•ˆå­˜å‚¨å’ŒæŸ¥è¯¢

![](https://images.jieyu.ai/images/2025/06/8_01.png)

"è¿™äº›éœ€æ±‚çœ‹èµ·æ¥å¾ˆæœ‰æŒ‘æˆ˜æ€§ï¼Œç‰¹åˆ«æ˜¯è·¨å¹³å°çš„å®æ—¶æ•°æ®ä¼ è¾“ã€‚"æˆ‘å¯¹ 007 è¯´é“ã€‚

"æ²¡é—®é¢˜ï¼æˆ‘ä»¬å¯ä»¥ç”¨ Redis ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç° Windows åˆ° Mac çš„æ•°æ®ä¼ è¾“ã€‚"007 ä¿¡å¿ƒæ»¡æ»¡åœ°å›ç­”ã€‚

## ğŸ”§ QMT æ¥å£æ·±åº¦è°ƒç ”

"é¦–å…ˆæˆ‘ä»¬éœ€è¦æ·±å…¥äº†è§£ QMT æä¾›çš„ API æ¥å£ã€‚"æˆ‘å¯¹ 007 è¯´é“ã€‚

007 ç«‹åˆ»å¼€å§‹äº†æŠ€æœ¯è°ƒç ”ï¼ŒQMT æä¾›äº†ä¸°å¯Œçš„ Python æ¥å£ï¼Œæˆ‘ä»¬é‡ç‚¹ç ”ç©¶äº†ä»¥ä¸‹å‡ ä¸ªå…³é”® APIï¼š

### æ•°æ®è®¢é˜…ç›¸å…³æ¥å£
!!! tip
    1. å•è‚¡è®¢é˜…æ¥å£ï¼ˆåŸºç¡€ç‰ˆä½¿ç”¨ï¼‰
    `xtdata.subscribe_quote(stock_code, period='1m', callback=callback_func)`

    2. å…¨æ¨è¡Œæƒ…è®¢é˜…æ¥å£ï¼ˆå¢å¼ºç‰ˆçš„å…³é”®å‘ç°ï¼‰
    `xtdata.subscribe_whole_quote(code_list, callback=callback_func)`

    3. å†å²æ•°æ®è·å–æ¥å£
    `xtdata.get_market_data_ex(stock_list, period, start_time, end_time)`

    4. è‚¡ç¥¨åˆ—è¡¨è·å–æ¥å£
    `xtdata.get_stock_list_in_sector('æ²ªæ·±Aè‚¡')`

    5. å®æ—¶ tick æ•°æ®è·å–æ¥å£
    `xtdata.get_full_tick(stock_list)`

![](https://images.jieyu.ai/images/2025/06/8_02.png)

### è¿æ¥å’Œæ§åˆ¶æ¥å£
!!! tip
    1. è¿æ¥ QMT
    `xtdata.connect()`

    2. å¯åŠ¨æ•°æ®æ¥æ”¶å¾ªç¯
    `xtdata.run()`

    3. å–æ¶ˆè®¢é˜…
    `xtdata.unsubscribe_quote()`

![](https://images.jieyu.ai/images/2025/06/8_03.png)

### æŠ€æœ¯æ¶æ„è®¾è®¡

ç»è¿‡æ·±å…¥è°ƒç ”å’Œè®¨è®ºï¼Œæˆ‘ä»¬ç¡®å®šäº†ä»¥ä¸‹æŠ€æœ¯æ¶æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Windowsç«¯     |    |    è¿œç¨‹Redis     â”‚    â”‚    Macç«¯        â”‚
â”‚   QMTæ•°æ®æº      â”‚â”€â”€â”€â–¶â”‚    æ¶ˆæ¯é˜Ÿåˆ—      â”‚â”€â”€â”€â–¶â”‚   ClickHouse    â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚   æ•°æ®å­˜å‚¨       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒç»„ä»¶é€‰æ‹©ï¼š**
- **Windows ç«¯**ï¼šä½¿ç”¨ QMT æ¥å£è·å–å®æ—¶æ•°æ®ï¼ŒPython + xtquant åº“
- **Redis**ï¼šä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç°è·¨å¹³å°æ•°æ®ä¼ è¾“ï¼Œéƒ¨ç½²åœ¨è¿œç¨‹æœåŠ¡å™¨
- **Mac ç«¯**ï¼šä½¿ç”¨ ClickHouse å­˜å‚¨æ•°æ®ï¼Œæä¾›æŸ¥è¯¢æ¥å£

"è¿™ä¸ªæ¶æ„çœ‹èµ·æ¥ä¸é”™ï¼Œä½†æˆ‘æ‹…å¿ƒæ€§èƒ½é—®é¢˜ã€‚1000 åªè‚¡ç¥¨çš„å®æ—¶æ•°æ®ï¼Œæ¯åˆ†é’Ÿå°±æ˜¯ 1000 æ¡è®°å½•ï¼Œä¸€å¤©å°±æ˜¯å‡ åä¸‡æ¡æ•°æ®ã€‚"æˆ‘æœ‰äº›æ‹…å¿ƒåœ°è¯´é“ã€‚

"æ²¡å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†é˜¶æ®µå®ç°ã€‚å…ˆåšä¸€ä¸ªåŸºç¡€ç‰ˆéªŒè¯å¯è¡Œæ€§ï¼Œç„¶åå†ä¼˜åŒ–æ€§èƒ½ã€‚"007 å»ºè®®é“ã€‚

## ğŸ—ï¸ **ä»é›¶å¼€å§‹ï¼šåŸºç¡€ç‰ˆç³»ç»Ÿæ­å»º**

"å¥½ï¼Œæˆ‘ä»¬å…ˆå®ç°ä¸€ä¸ªåŸºç¡€ç‰ˆæœ¬ï¼ŒéªŒè¯æ•´ä½“æ¶æ„çš„å¯è¡Œæ€§ã€‚"æˆ‘å¯¹ 007 è¯´é“ã€‚

### ç¬¬ä¸€æ­¥ï¼šWindows ç«¯æ•°æ®è®¢é˜…å™¨

007 é¦–å…ˆåœ¨ Windows ç«¯æ­å»ºäº†æ•°æ®è®¢é˜…å™¨ã€‚æœ€åˆçš„æƒ³æ³•å¾ˆç®€å•ï¼šé€ä¸ªè®¢é˜…è‚¡ç¥¨ï¼Œæ¥æ”¶æ•°æ®åå‘é€åˆ° Redisã€‚

"æˆ‘ä»¬å…ˆç”¨æœ€ç›´æ¥çš„æ–¹å¼å®ç°ï¼Œå•è‚¡è®¢é˜…æ¨¡å¼ã€‚"007 è§£é‡Šé“ã€‚

```python
class QMTSubscriber:
    def __init__(self, config):
        self.config = config
        self.redis_client = redis.StrictRedis(
            host=config['redis']['host'],
            port=config['redis']['port'],
            password=config['redis']['password']
        )

    def start_subscription(self):
        # è·å–è‚¡ç¥¨åˆ—è¡¨
        stock_list = self.get_stock_list()

        # é€ä¸ªè®¢é˜…
        for stock_code in stock_list:
            seq = xtdata.subscribe_quote(
                stock_code=stock_code,
                period='1m',
                callback=self.on_data
            )

    def on_data(self, data):
        # å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®
        for symbol, quote_data in data.items():
            minute_bar = self.process_data(symbol, quote_data)
            # å‘é€åˆ°Redis
            self.redis_client.lpush("minute_bar_queue",
                                  json.dumps(minute_bar))
```

### ç¬¬äºŒæ­¥ï¼šMac ç«¯æ•°æ®æ¶ˆè´¹å™¨

"Windows ç«¯è´Ÿè´£æ•°æ®è·å–ï¼ŒMac ç«¯è´Ÿè´£æ•°æ®å­˜å‚¨å’ŒæŸ¥è¯¢ã€‚"æˆ‘å¯¹ 007 è¯´æ˜äº†åˆ†å·¥ã€‚

åœ¨ Mac ç«¯ï¼Œ007 æ­å»ºäº†æ•°æ®æ¶ˆè´¹å™¨ï¼Œä» Redis è·å–æ•°æ®å¹¶å­˜å‚¨åˆ° ClickHouseï¼š

```python
class DataConsumer:
    def __init__(self, config):
        self.redis_client = redis.StrictRedis(
            host="8.217.201.221",
            port=16379,
            password="quantide666"
        )
        self.clickhouse_client = Client(host='localhost')

    def consume_data(self):
        while True:
            # ä» Redis è·å–æ•°æ®
            data = self.redis_client.brpop("minute_bar_queue", timeout=1)
            if data:
                minute_bar = json.loads(data[1])
                # æ’å…¥ ClickHouse
                self.insert_to_clickhouse(minute_bar)
```

### ç¬¬ä¸‰æ­¥ï¼šåˆæ­¥æµ‹è¯•ä¸ç°å®çš„å†²å‡»

"ç³»ç»Ÿæ­å»ºå®Œæˆï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹æ•ˆæœã€‚"æˆ‘æ»¡æ€€æœŸå¾…åœ°è¯´é“ã€‚

åŸºç¡€ç‰ˆç³»ç»Ÿæ­å»ºå®Œæˆåï¼Œæˆ‘ä»¬è¿›è¡Œäº†åˆæ­¥æµ‹è¯•ã€‚ç»“æœè®©äººå–œå¿§å‚åŠï¼š

**ğŸ‰ å¥½æ¶ˆæ¯**ï¼š
- ç³»ç»Ÿèƒ½å¤Ÿæ­£å¸¸è¿è¡Œï¼Œæ¶æ„éªŒè¯æˆåŠŸ
- æ•°æ®èƒ½å¤Ÿä» Windows ä¼ è¾“åˆ° Macï¼Œè·¨å¹³å°æ–¹æ¡ˆå¯è¡Œ
- ClickHouse ä¸­èƒ½å¤Ÿçœ‹åˆ°å®æ—¶æ•°æ®ï¼Œå­˜å‚¨æ–¹æ¡ˆæœ‰æ•ˆ
- åŸºæœ¬çš„åˆ†é’Ÿçº¿æ•°æ®æ ¼å¼æ­£ç¡®

**ğŸ˜° åæ¶ˆæ¯**ï¼š
- è®¢é˜… 1000 åªè‚¡ç¥¨éœ€è¦ 5 åˆ†é’Ÿï¼Œæ•ˆç‡å¤ªä½
- æ•°æ®å¤„ç†é€Ÿåº¦åªæœ‰ 1-2 æ¡/ç§’ï¼Œè¿œä½äºé¢„æœŸ
- å¶å°”å‡ºç°æ•°æ®å¼‚å¸¸å’Œè¿æ¥ä¸­æ–­
- å†…å­˜ä½¿ç”¨é‡æŒç»­å¢é•¿ï¼Œå­˜åœ¨å†…å­˜æ³„æ¼

"çœ‹æ¥åŸºç¡€ç‰ˆåªèƒ½ç®—æ˜¯ä¸€ä¸ªåŸå‹ï¼Œè·ç¦»ç”Ÿäº§ç¯å¢ƒè¿˜æœ‰å¾ˆå¤§å·®è·ã€‚"æˆ‘æœ‰äº›å¤±æœ›åœ°è¯´é“ã€‚

"æ²¡å…³ç³»ï¼Œè¿™æ˜¯æ­£å¸¸çš„ã€‚æˆ‘ä»¬å·²ç»éªŒè¯äº†æ¶æ„çš„å¯è¡Œæ€§ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ä¼˜åŒ–çš„é—®é¢˜äº†ã€‚"007 å®‰æ…°é“ã€‚

## ğŸ˜¤ é‡åˆ°çš„é—®é¢˜ï¼šåŸºç¡€ç‰ˆçš„ç“¶é¢ˆåˆ†æ

"æˆ‘ä»¬éœ€è¦ä»”ç»†åˆ†æåŸºç¡€ç‰ˆçš„é—®é¢˜ï¼Œæ‰èƒ½æœ‰é’ˆå¯¹æ€§åœ°ä¼˜åŒ–ã€‚"æˆ‘å¯¹ 007 è¯´é“ã€‚

åœ¨åŸºç¡€ç‰ˆç³»ç»Ÿè¿è¡Œäº†ä¸€æ®µæ—¶é—´åï¼Œæˆ‘ä»¬å‘ç°äº†å‡ ä¸ªæ˜æ˜¾çš„é—®é¢˜ï¼š

### é—®é¢˜ 1ï¼šè®¢é˜…æ•ˆç‡ä½ä¸‹
```
2025-05-29 15:00:46,949 - qmt_subscriber - INFO - è®¢é˜…å®Œæˆ: æˆåŠŸ 100 åª, å¤±è´¥ 0 åª
2025-05-29 15:00:46,949 - qmt_subscriber - WARNING - è®¢é˜…æˆåŠŸç‡è¾ƒä½(100/1000)ï¼Œåˆ‡æ¢åˆ°è½®è¯¢æ¨¡å¼...
```

"è¿™ä¸ªæ—¥å¿—å¾ˆæœ‰æ„æ€ï¼Œæ˜æ˜æˆåŠŸç‡æ˜¯ 100%ï¼Œä¸ºä»€ä¹ˆç³»ç»Ÿåˆ¤æ–­ä¸º'è¾ƒä½'ï¼Ÿ"æˆ‘ç–‘æƒ‘åœ°é—®é“ã€‚

007 åˆ†æåå‘ç°ï¼šç³»ç»Ÿè¯¯åˆ¤ 100% çš„æˆåŠŸç‡ä¸º"è¾ƒä½"ï¼Œé¢‘ç¹åˆ‡æ¢åˆ°ä½æ•ˆçš„è½®è¯¢æ¨¡å¼ã€‚æ›´è¦å‘½çš„æ˜¯ï¼Œå•è‚¡è®¢é˜…æ¨¡å¼ä¸‹ï¼Œ1000 åªè‚¡ç¥¨éœ€è¦é€ä¸ªè®¢é˜…ï¼Œæ¯åªè‚¡ç¥¨è€—æ—¶çº¦ 0.3 ç§’ï¼Œæ€»è®¡éœ€è¦ 5 åˆ†é’Ÿæ‰èƒ½å®Œæˆè®¢é˜…ã€‚

### é—®é¢˜ 2ï¼šæ€§èƒ½ç“¶é¢ˆæ˜æ˜¾
"å•çº¿ç¨‹å¤„ç†æ˜æ˜¾è·Ÿä¸ä¸Šæ•°æ®æµçš„é€Ÿåº¦ã€‚"007 æŒ‡å‡ºäº†æ ¸å¿ƒé—®é¢˜ã€‚

æ•°æ®å¤„ç†é‡‡ç”¨å•çº¿ç¨‹æ¨¡å¼ï¼Œæ¯æ¡æ•°æ®éƒ½è¦ç»å†"æ¥æ”¶â†’å¤„ç†â†’å‘å¸ƒ"çš„ä¸²è¡Œæµç¨‹ï¼š
- **æ¥æ”¶ç“¶é¢ˆ**ï¼šQMT å›è°ƒå‡½æ•°ä¸­å¤„ç†æ—¶é—´è¿‡é•¿ï¼Œå½±å“åç»­æ•°æ®æ¥æ”¶
- **å¤„ç†ç“¶é¢ˆ**ï¼šæ•°æ®æ ¼å¼è½¬æ¢å’ŒéªŒè¯è€—æ—¶è¾ƒé•¿
- **å‘å¸ƒç“¶é¢ˆ**ï¼šæ¯æ¡æ•°æ®å•ç‹¬å‘é€åˆ° Redisï¼Œç½‘ç»œå¼€é”€å¤§

åœ¨å¸‚åœºæ´»è·ƒæ—¶æ®µï¼ˆå¦‚å¼€ç›˜å‰ 30 åˆ†é’Ÿï¼‰ï¼Œæ•°æ®ç§¯å‹ä¸¥é‡ï¼Œå»¶è¿Ÿä» 1 ç§’å¢åŠ åˆ° 10 ç§’ä»¥ä¸Šã€‚

## ğŸš€ æŠ€æœ¯çªç ´ï¼šå…¨æ¨è¡Œæƒ…è®¢é˜…çš„å¨åŠ›
"æˆ‘ä»¬éœ€è¦ä»æ ¹æœ¬ä¸Šæ”¹å˜è®¢é˜…æ¨¡å¼ã€‚"007 å¼€å§‹äº†æ·±åº¦æŠ€æœ¯è°ƒç ”ã€‚

ç»è¿‡æ·±å…¥ç ”ç©¶ QMT API æ–‡æ¡£ï¼Œ007 å‘ç°äº†ä¸€ä¸ªå…³é”®çš„ APIï¼š`subscribe_whole_quote`ã€‚

"æˆ‘æ‰¾åˆ°äº†è§£å†³æ–¹æ¡ˆï¼è¿™ä¸ª API æ”¯æŒå…¨æ¨è¡Œæƒ…è®¢é˜…ï¼Œæ¯”å•è‚¡è®¢é˜…æ•ˆç‡é«˜å¾—å¤šï¼"007 å…´å¥‹åœ°è¯´ã€‚

"å…¨æ¨è¡Œæƒ…ï¼Ÿè¿™å¬èµ·æ¥å¾ˆå‰å®³ï¼Œå…·ä½“æ˜¯ä»€ä¹ˆåŸç†ï¼Ÿ"æˆ‘å¥½å¥‡åœ°é—®é“ã€‚

"ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¸€æ¬¡æ€§è®¢é˜…å…¨å¸‚åœºçš„æ•°æ®ï¼Œè€Œä¸æ˜¯é€ä¸ªè®¢é˜…æ¯åªè‚¡ç¥¨ã€‚è¿™æ ·å¯ä»¥å¤§å¤§å‡å°‘ API è°ƒç”¨æ¬¡æ•°å’Œç½‘ç»œå¼€é”€ã€‚"007 è§£é‡Šé“ã€‚

### åŸºç¡€ç‰ˆ vs å¢å¼ºç‰ˆè®¢é˜…å¯¹æ¯”

è®©æˆ‘ä»¬æ¥çœ‹çœ‹ä¸¤ç§è®¢é˜…æ¨¡å¼çš„å…·ä½“å·®å¼‚ï¼š

**åŸºç¡€ç‰ˆï¼ˆå•è‚¡è®¢é˜…ï¼‰ï¼š**
```python
# é€ä¸ªè®¢é˜…ï¼Œæ•ˆç‡ä½ä¸‹
def start_individual_subscription(self):
    success_count = 0
    for stock_code in stock_list:
        try:
            seq = xtdata.subscribe_quote(
                stock_code=stock_code,
                period='1m',
                callback=self.on_data
            )
            success_count += 1
            time.sleep(0.1)  # é¿å… API è°ƒç”¨è¿‡å¿«
        except Exception as e:
            self.logger.error(f"è®¢é˜…å¤±è´¥: {stock_code}, {e}")

    self.logger.info(f"è®¢é˜…å®Œæˆ: æˆåŠŸ {success_count} åª")
```

**å¢å¼ºç‰ˆï¼ˆå…¨æ¨è¡Œæƒ…è®¢é˜…ï¼‰ï¼š**
```python
# ä¸€æ¬¡æ€§è®¢é˜…å…¨å¸‚åœºï¼Œæ•ˆç‡æé«˜
def start_whole_quote_subscription(self):
    try:
        result = xtdata.subscribe_whole_quote(
            code_list=self.stock_list,
            callback=self.on_whole_quote_data
        )
        if result == 0:  # 0 è¡¨ç¤ºæˆåŠŸ
            self.logger.info(f"å…¨æ¨è¡Œæƒ…è®¢é˜…æˆåŠŸ: {len(self.stock_list)} åªè‚¡ç¥¨")
            return True
    except Exception as e:
        self.logger.error(f"å…¨æ¨è¡Œæƒ…è®¢é˜…å¤±è´¥: {e}")
        # è‡ªåŠ¨é™çº§åˆ°å•è‚¡è®¢é˜…
        return self.start_individual_subscription()
```

"é€‰æ‹©åˆé€‚çš„ API å¯¹æ€§èƒ½çš„å½±å“æ˜¯å†³å®šæ€§çš„ã€‚"007 æ€»ç»“é“ã€‚

## âš¡ æ‰¹é‡å¤„ç†æ€§èƒ½æå‡

"åŸºç¡€ç‰ˆæ€§èƒ½è¿˜æ˜¯ä¸å¤Ÿã€‚å•æ¡å¤„ç†å¤ªæ…¢äº†ï¼Œæˆ‘ä»¬éœ€è¦æ‰¹é‡å¤„ç†ï¼"007 æå‡ºäº†å…³é”®çš„æ€§èƒ½ä¼˜åŒ–æ€è·¯ã€‚

"æ‰¹é‡å¤„ç†ç¡®å®æ˜¯æå‡æ€§èƒ½çš„å…³é”®ã€‚"æˆ‘èµåŒé“ï¼Œ"ä½†è¦æ³¨æ„å¹³è¡¡æ‰¹é‡å¤§å°å’Œå®æ—¶æ€§ã€‚"

### Windows ç«¯ï¼šç”Ÿäº§è€…æ‰¹é‡å¤„ç†æ¶æ„

007 è®¾è®¡äº†ä¸€ä¸ªç²¾å·§çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼çš„å¤šçº¿ç¨‹æ¶æ„ï¼š

```python
class EnhancedQMTSubscriber:
    def __init__(self, config):
        self.batch_size = config['system']['batch_size']  # 100
        self.batch_timeout = config['system']['batch_timeout']  # 1.0 ç§’
        self.data_queue = queue.Queue(maxsize=5000)
        self.batch_data = []
        self.last_batch_time = time.time()

    def start_data_processing_threads(self):
        """å¯åŠ¨æ•°æ®å¤„ç†çº¿ç¨‹"""
        # æ‰¹é‡å‘å¸ƒçº¿ç¨‹
        publish_thread = threading.Thread(target=self.batch_publish_worker, daemon=True)
        publish_thread.start()

        # æ•°æ®æ¸…ç†çº¿ç¨‹
        cleanup_thread = threading.Thread(target=self.data_cleanup_worker, daemon=True)
        cleanup_thread.start()

        # æ€§èƒ½ç›‘æ§çº¿ç¨‹
        monitor_thread = threading.Thread(target=self.performance_monitor, daemon=True)
        monitor_thread.start()

    def batch_publish_worker(self):
        """æ‰¹é‡å‘å¸ƒå·¥ä½œçº¿ç¨‹"""
        while True:
            try:
                # ä»é˜Ÿåˆ—è·å–æ•°æ®
                minute_bar = self.data_queue.get(timeout=0.1)
                self.batch_data.append(minute_bar)

                # æ£€æŸ¥æ˜¯å¦éœ€è¦å‘å¸ƒæ‰¹é‡æ•°æ®
                current_time = time.time()
                should_publish = (
                    len(self.batch_data) >= self.batch_size or
                    current_time - self.last_batch_time >= self.batch_timeout
                )

                if should_publish and self.batch_data:
                    self.batch_publish_to_redis(self.batch_data.copy())
                    self.batch_data.clear()
                    self.last_batch_time = current_time

            except queue.Empty:
                # è¶…æ—¶æ£€æŸ¥
                current_time = time.time()
                if (self.batch_data and
                    current_time - self.last_batch_time >= self.batch_timeout):
                    self.batch_publish_to_redis(self.batch_data.copy())
                    self.batch_data.clear()
                    self.last_batch_time = current_time

    def batch_publish_to_redis(self, batch_data):
        """æ‰¹é‡å‘å¸ƒåˆ°Redis"""
        try:
            pipe = self.redis_client.pipeline()
            for data in batch_data:
                pipe.lpush("minute_bar_queue", json.dumps(data))
            pipe.execute()

            self.stats['published_count'] += len(batch_data)
            self.logger.debug(f"æ‰¹é‡å‘å¸ƒæˆåŠŸ: {len(batch_data)} æ¡æ•°æ®")

        except Exception as e:
            self.logger.error(f"æ‰¹é‡å‘å¸ƒå¤±è´¥: {e}")
            # é™çº§åˆ°å•æ¡å‘å¸ƒ
            self.fallback_single_publish(batch_data)
```

### Mac ç«¯ï¼šå¤šå·¥ä½œçº¿ç¨‹æ‰¹é‡æ’å…¥

åœ¨ Mac ç«¯ï¼Œ007 è®¾è®¡äº†æ›´å¼ºå¤§çš„å¤šå·¥ä½œçº¿ç¨‹æ‰¹é‡æ’å…¥æœºåˆ¶ï¼š

```python
class EnhancedDataConsumer:
    def __init__(self, config):
        self.worker_count = config['system']['worker_count']  # 4
        self.batch_size = config['system']['batch_size']  # 1000
        self.batch_timeout = config['system']['batch_timeout']  # 5.0 ç§’
        self.worker_queues = [queue.Queue(maxsize=1000) for _ in range(self.worker_count)]

    def start_worker_threads(self):
        """å¯åŠ¨å·¥ä½œçº¿ç¨‹"""
        for i in range(self.worker_count):
            worker_thread = threading.Thread(
                target=self.batch_insert_worker,
                args=(f"worker-{i}", self.worker_queues[i]),
                daemon=True
            )
            worker_thread.start()
            self.logger.info(f"å¯åŠ¨å·¥ä½œçº¿ç¨‹: worker-{i}")

    def batch_insert_worker(self, worker_name, worker_queue):
        """æ‰¹é‡æ’å…¥å·¥ä½œçº¿ç¨‹"""
        batch_data = []
        last_batch_time = time.time()

        while True:
            try:
                # ä»å·¥ä½œé˜Ÿåˆ—è·å–æ•°æ®
                data = worker_queue.get(timeout=0.5)
                batch_data.append(data)

                # æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰¹é‡æ’å…¥
                current_time = time.time()
                should_insert = (
                    len(batch_data) >= self.batch_size or
                    current_time - last_batch_time >= self.batch_timeout
                )

                if should_insert and batch_data:
                    self.batch_insert_clickhouse(worker_name, batch_data.copy())
                    batch_data.clear()
                    last_batch_time = current_time

            except queue.Empty:
                # è¶…æ—¶æ£€æŸ¥
                current_time = time.time()
                if (batch_data and
                    current_time - last_batch_time >= self.batch_timeout):
                    self.batch_insert_clickhouse(worker_name, batch_data.copy())
                    batch_data.clear()
                    last_batch_time = current_time

    def batch_insert_clickhouse(self, worker_name, batch_data):
        """æ‰¹é‡æ’å…¥ClickHouse"""
        try:
            # æ•°æ®æ ¼å¼è½¬æ¢
            formatted_data = []
            for item in batch_data:
                formatted_data.append([
                    item['symbol'], item['frame'], item['open'],
                    item['high'], item['low'], item['close'],
                    item['vol'], item['amount']
                ])

            # æ‰¹é‡æ’å…¥
            self.clickhouse_client.execute(
                "INSERT INTO minute_bars VALUES",
                formatted_data
            )

            self.stats['inserted_count'] += len(batch_data)
            self.logger.debug(f"{worker_name} æ‰¹é‡æ’å…¥æˆåŠŸ: {len(batch_data)} æ¡")

        except Exception as e:
            self.logger.error(f"{worker_name} æ‰¹é‡æ’å…¥å¤±è´¥: {e}")
            self.stats['insert_errors'] += 1
```

"æ‰¹é‡å¤„ç†ç¡®å®æ˜¯æ€§èƒ½ä¼˜åŒ–çš„é“¶å¼¹ï¼Œç‰¹åˆ«æ˜¯åœ¨ I/O å¯†é›†å‹åœºæ™¯ä¸­ã€‚"007 æ€»ç»“é“ã€‚

## ğŸ“Š **å®æ—¶ç›‘æ§ï¼šç³»ç»ŸçŠ¶æ€ä¸€ç›®äº†ç„¶**

"æ²¡æœ‰ç›‘æ§çš„ç³»ç»Ÿæ˜¯ç›²é£ã€‚"æˆ‘å¯¹ 007 è¯´ã€‚

007 è®¾è®¡äº†è¯¦ç»†çš„æ€§èƒ½ç›‘æ§ç³»ç»Ÿï¼Œæ¯åˆ†é’Ÿè¾“å‡ºä¸€æ¬¡æŠ¥å‘Šï¼š

### Windows ç«¯å®æ—¶ç›‘æ§

```
2025-06-07 09:32:35,229 - INFO - ğŸš€ å¯åŠ¨ QMT åˆ†é’Ÿçº¿å…¨æ¨è®¢é˜…å™¨...
2025-06-07 09:32:35,808 - INFO - âœ… Redis è¿æ¥æ± åˆ›å»ºæˆåŠŸ: 8.217.201.221:16379
2025-06-07 09:32:35,809 - INFO - ğŸ“Š è¿æ¥æ± é…ç½®: æœ€å¤§è¿æ¥æ•°=20, å¯ç”¨ keepalive
***** xtdata è¿æ¥æˆåŠŸ *****
æœåŠ¡ä¿¡æ¯: {'tag': 'sp3', 'version': '1.0'}
æœåŠ¡åœ°å€: 127.0.0.1:58610
æ•°æ®è·¯å¾„: C:\Program Files\å›½é‡‘è¯åˆ¸ QMT äº¤æ˜“ç«¯\bin.x64/../userdata_mini/datadir
è®¾ç½® xtdata.enable_hello = False å¯éšè—æ­¤æ¶ˆæ¯

2025-06-07 09:32:35,822 - INFO - QMT è¿æ¥å¯¹è±¡: <class 'xtquant.datacenter.IPythonApiClient'>
2025-06-07 09:32:35,826 - INFO - âœ… QMT è¿æ¥æˆåŠŸ - æµ‹è¯•è‚¡ç¥¨: å¹³å®‰é“¶è¡Œ
2025-06-07 09:32:35,826 - INFO - ğŸ” è·å–æ²ªæ·± A è‚¡å®Œæ•´åˆ—è¡¨...
2025-06-07 09:32:35,867 - INFO - ğŸ‰ æˆåŠŸè·å–æ²ªæ·± A è‚¡: 5147 åªè‚¡ç¥¨!
2025-06-07 09:32:35,868 - INFO - ğŸ“‹ è‚¡ç¥¨èŒƒå›´: 600051.SH åˆ° 300271.SZ
2025-06-07 09:32:35,872 - INFO - ğŸ“Š è‚¡ç¥¨åˆ†å¸ƒ: æ·±åœ³ 2867 åª, ä¸Šæµ· 2280 åª
2025-06-07 09:32:35,873 - INFO - ğŸš€ å¯åŠ¨ QMT å…¨æ¨åˆ†é’Ÿçº¿è®¢é˜…...
2025-06-07 09:32:35,909 - INFO - ğŸ“Š subscribe_whole_quote è¿”å›: 1 (ç±»å‹: <class 'int'>)
2025-06-07 09:32:35,909 - INFO - âœ… å…¨æ¨è®¢é˜…æˆåŠŸ! è®¢é˜…è‚¡ç¥¨æ•°: 5147
2025-06-07 09:32:35,912 - INFO - âœ… ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨
2025-06-07 09:32:35,913 - INFO - âœ… è®¢é˜…å™¨å¯åŠ¨æˆåŠŸï¼Œå¼€å§‹æ¥æ”¶æ•°æ®...
2025-06-07 09:32:35,914 - INFO - æŒ‰ Ctrl+C åœæ­¢è®¢é˜…
2025-06-07 09:32:35,917 - INFO - ğŸ”” å…¨æ¨æ•°æ®å›è°ƒ #1
2025-06-07 09:32:35,917 - INFO -    æ•°æ®ç±»å‹: <class 'dict'>
2025-06-07 09:32:35,918 - INFO -    æ•°æ®é‡: 1
2025-06-07 09:32:35,927 - INFO -    æ ·ä¾‹è‚¡ç¥¨: ['601878.SH']
2025-06-07 09:32:35,928 - INFO -    æ ·ä¾‹æ•°æ®ç±»å‹: <class 'dict'>
2025-06-07 09:32:35,929 - INFO -    æ ·ä¾‹å­—æ®µ: ['time', 'lastPrice', 'open', 'high', 'low', 'lastClose', 'amount', 'volume', 'pvolume', 'stockStatus']
2025-06-07 09:32:36,142 - INFO - ğŸ”” å…¨æ¨æ•°æ®å›è°ƒ #2
2025-06-07 09:32:36,143 - INFO -    æ•°æ®ç±»å‹: <class 'dict'>
2025-06-07 09:32:36,145 - INFO -    æ•°æ®é‡: 2278
2025-06-07 09:32:36,146 - INFO -    æ ·ä¾‹è‚¡ç¥¨: ['600000.SH', '600004.SH', '600006.SH']
2025-06-07 09:32:36,147 - INFO -    æ ·ä¾‹æ•°æ®ç±»å‹: <class 'dict'>
2025-06-07 09:32:36,148 - INFO -    æ ·ä¾‹å­—æ®µ: ['time', 'lastPrice', 'open', 'high', 'low', 'lastClose', 'amount', 'volume', 'pvolume', 'stockStatus']
2025-06-07 09:32:37,596 - INFO - ğŸ“Š æ‰¹é‡å‘å¸ƒ: 100æ¡, æ€»è®¡: 500æ¡, å¹³å‡æ‰¹é‡: 100.0
2025-06-07 09:32:38,696 - INFO - ğŸ“Š æ‰¹é‡å‘å¸ƒ: 100æ¡, æ€»è®¡: 1000æ¡, å¹³å‡æ‰¹é‡: 100.0
2025-06-07 09:32:39,756 - INFO - ğŸ“Š æ‰¹é‡å‘å¸ƒ: 100æ¡, æ€»è®¡: 1500æ¡, å¹³å‡æ‰¹é‡: 100.0
2025-06-07 09:32:40,781 - INFO - ğŸ“Š æ‰¹é‡å‘å¸ƒ: 100æ¡, æ€»è®¡: 2000æ¡, å¹³å‡æ‰¹é‡: 100.0
2025-06-07 09:32:41,196 - INFO - ğŸ”” å…¨æ¨æ•°æ®å›è°ƒ #3
2025-06-07 09:32:41,196 - INFO -    æ•°æ®ç±»å‹: <class 'dict'>
2025-06-07 09:32:41,198 - INFO -    æ•°æ®é‡: 2865
2025-06-07 09:32:41,200 - INFO -    æ ·ä¾‹è‚¡ç¥¨: ['000001.SZ', '000002.SZ', '000004.SZ']
2025-06-07 09:32:41,200 - INFO -    æ ·ä¾‹æ•°æ®ç±»å‹: <class 'dict'>
2025-06-07 09:32:41,201 - INFO -    æ ·ä¾‹å­—æ®µ: ['time', 'lastPrice', 'open', 'high', 'low', 'lastClose', 'amount', 'volume', 'pvolume', 'stockStatus']
2025-06-07 09:32:41,688 - INFO - ğŸ“Š æ‰¹é‡å‘å¸ƒ: 100æ¡, æ€»è®¡: 2500æ¡, å¹³å‡æ‰¹é‡: 100.0
2025-06-07 09:32:42,564 - INFO - ğŸ“Š æ‰¹é‡å‘å¸ƒ: 100æ¡, æ€»è®¡: 3000æ¡, å¹³å‡æ‰¹é‡: 100.0
2025-06-07 09:32:43,415 - INFO - ğŸ“Š æ‰¹é‡å‘å¸ƒ: 100æ¡, æ€»è®¡: 3500æ¡, å¹³å‡æ‰¹é‡: 100.0
2025-06-07 09:32:44,233 - INFO - ğŸ“Š æ‰¹é‡å‘å¸ƒ: 100æ¡, æ€»è®¡: 4000æ¡, å¹³å‡æ‰¹é‡: 100.0
2025-06-07 09:32:45,120 - INFO - ğŸ“Š æ‰¹é‡å‘å¸ƒ: 100æ¡, æ€»è®¡: 4500æ¡, å¹³å‡æ‰¹é‡: 100.0
2025-06-07 09:32:45,955 - INFO - ğŸ“Š æ‰¹é‡å‘å¸ƒ: 100æ¡, æ€»è®¡: 5000æ¡, å¹³å‡æ‰¹é‡: 100.0
2025-06-07 09:32:46,128 - INFO - ğŸ”” å…¨æ¨æ•°æ®å›è°ƒ #4
2025-06-07 09:32:46,129 - INFO -    æ•°æ®ç±»å‹: <class 'dict'>
2025-06-07 09:32:46,131 - INFO -    æ•°æ®é‡: 1
2025-06-07 09:32:46,132 - INFO -    æ ·ä¾‹è‚¡ç¥¨: ['688757.SH']
2025-06-07 09:32:46,133 - INFO -    æ ·ä¾‹æ•°æ®ç±»å‹: <class 'dict'>
2025-06-07 09:32:46,134 - INFO -    æ ·ä¾‹å­—æ®µ: ['time', 'lastPrice', 'open', 'high', 'low', 'lastClose', 'amount', 'volume', 'pvolume', 'stockStatus']
2025-06-07 09:32:46,135 - INFO - ğŸ”” å…¨æ¨æ•°æ®å›è°ƒ #5
2025-06-07 09:32:46,136 - INFO -    æ•°æ®ç±»å‹: <class 'dict'>
2025-06-07 09:32:46,136 - INFO -    æ•°æ®é‡: 4
2025-06-07 09:32:46,137 - INFO -    æ ·ä¾‹è‚¡ç¥¨: ['601225.SH', '601658.SH', '688458.SH']
2025-06-07 09:32:46,138 - INFO -    æ ·ä¾‹æ•°æ®ç±»å‹: <class 'dict'>
2025-06-07 09:32:46,139 - INFO -    æ ·ä¾‹å­—æ®µ: ['time', 'lastPrice', 'open', 'high', 'low', 'lastClose', 'amount', 'volume', 'pvolume', 'stockStatus']
2025-06-07 09:32:46,844 - INFO - ğŸ“Š æ‰¹é‡å‘å¸ƒ: 100æ¡, æ€»è®¡: 5500æ¡, å¹³å‡æ‰¹é‡: 100.0
2025-06-07 09:33:05,913 - INFO - ğŸ“Š Windows ç«¯æ€§èƒ½ç»Ÿè®¡ - è¿è¡Œæ—¶é—´: 0:00:30.001766
2025-06-07 09:33:05,913 - INFO -    å›è°ƒ: 464 æ¬¡ (15.5 æ¬¡/ç§’)
2025-06-07 09:33:05,916 - INFO -    æ¥æ”¶: 7689 æ¡ (256.3 æ¡/ç§’)
2025-06-07 09:33:05,917 - INFO -    å‘å¸ƒ: 7678 æ¡ (255.9 æ¡/ç§’)
2025-06-07 09:33:05,917 - INFO -    æˆåŠŸç‡: 99.9%
2025-06-07 09:33:05,918 - INFO -    é”™è¯¯ç»Ÿè®¡: å¤„ç†é”™è¯¯ 0 æ¬¡
2025-06-07 09:33:05,919 - INFO -    æ‰¹é‡ç»Ÿè®¡: 82 æ¬¡, å¹³å‡: 93.6 æ¡/æ‰¹
2025-06-07 09:33:05,920 - INFO -    ç¼“å†²åŒº: 11 æ¡ | Redis æ“ä½œ: 82 æ¬¡
2025-06-07 09:33:05,920 - INFO -    å¤„ç†è‚¡ç¥¨: 5143 åª | æ•°æ®å®Œæ•´æ€§: âœ…
2025-06-07 09:33:35,922 - INFO - ğŸ“Š Windowsç«¯æ€§èƒ½ç»Ÿè®¡ - è¿è¡Œæ—¶é—´: 0:01:00.011022
2025-06-07 09:33:35,923 - INFO -    å›è°ƒ: 848æ¬¡ (14.1æ¬¡/ç§’)
2025-06-07 09:33:35,925 - INFO -    æ¥æ”¶: 8909æ¡ (148.5æ¡/ç§’)
2025-06-07 09:33:35,926 - INFO -    å‘å¸ƒ: 8885æ¡ (148.1æ¡/ç§’)
2025-06-07 09:33:35,927 - INFO -    æˆåŠŸç‡: 99.7%
2025-06-07 09:33:35,927 - INFO -    é”™è¯¯ç»Ÿè®¡: å¤„ç†é”™è¯¯0æ¬¡
2025-06-07 09:33:35,928 - INFO -    æ‰¹é‡ç»Ÿè®¡: 108æ¬¡, å¹³å‡: 82.3æ¡/æ‰¹
2025-06-07 09:33:35,929 - INFO -    ç¼“å†²åŒº: 24æ¡ | Redisæ“ä½œ: 108æ¬¡
2025-06-07 09:33:35,930 - INFO -    å¤„ç†è‚¡ç¥¨: 5143åª | æ•°æ®å®Œæ•´æ€§: âœ…
2025-06-07 09:34:05,931 - INFO - ğŸ“Š Windowsç«¯æ€§èƒ½ç»Ÿè®¡ - è¿è¡Œæ—¶é—´: 0:01:30.020076
2025-06-07 09:34:05,931 - INFO -    å›è°ƒ: 1268æ¬¡ (14.1æ¬¡/ç§’)
2025-06-07 09:34:05,934 - INFO -    æ¥æ”¶: 10972æ¡ (121.9æ¡/ç§’)
2025-06-07 09:34:05,934 - INFO -    å‘å¸ƒ: 10960æ¡ (121.8æ¡/ç§’)
2025-06-07 09:34:05,935 - INFO -    æˆåŠŸç‡: 99.9%
2025-06-07 09:34:05,936 - INFO -    é”™è¯¯ç»Ÿè®¡: å¤„ç†é”™è¯¯0æ¬¡
2025-06-07 09:34:05,937 - INFO -    æ‰¹é‡ç»Ÿè®¡: 141æ¬¡, å¹³å‡: 77.7æ¡/æ‰¹
2025-06-07 09:34:05,937 - INFO -    ç¼“å†²åŒº: 12æ¡ | Redisæ“ä½œ: 141æ¬¡
2025-06-07 09:34:05,938 - INFO -    å¤„ç†è‚¡ç¥¨: 5143åª | æ•°æ®å®Œæ•´æ€§: âœ…
```

!!! question
    ä¸ºä»€ä¹ˆæ—¥å¿—ä¸­çš„æˆåŠŸç‡ä¸æ˜¯100%å‘¢ï¼Ÿ

![](https://images.jieyu.ai/images/2025/06/8_12.png)

007ç»™å‡ºäº†ä»¥ä¸‹å›ç­”ã€‚

åœ¨æˆ‘ä»¬çš„ç¨‹åºä¸­ï¼Œæœ‰æ£€æµ‹æ•°æ®å®Œæ•´æ€§çš„éªŒè¯é€»è¾‘ï¼š
```python
def validate_minute_bar_data(self, minute_bar: Dict) -> bool:
    # æ£€æŸ¥å¿…è¦å­—æ®µå­˜åœ¨æ€§
    required_fields = ['symbol', 'open', 'high', 'low', 'close', 'vol']
    for field in required_fields:
        if field not in minute_bar or minute_bar[field] is None:
            return False
```
å¦‚æœQMTè¿”å›çš„æŸäº›è‚¡ç¥¨æ•°æ®ç¼ºå°‘å¿…è¦å­—æ®µæˆ–å­—æ®µå€¼ä¸ºNoneï¼Œè¿™äº›æ•°æ®ä¼šè¢«è¿‡æ»¤æ‰ï¼Œä¸ä¼šå‘å¸ƒåˆ°Redisã€‚åœ¨ `build_minute_bar` å‡½æ•°ä¸­ï¼Œå¦‚æœQMTè¿”å›çš„æ•°æ®æ ¼å¼å¼‚å¸¸ã€æ•°æ®ç±»å‹è½¬æ¢å¤±è´¥æˆ–å…¶ä»–æ„å»ºè¿‡ç¨‹ä¸­çš„å¼‚å¸¸éƒ½ä¼šå¯¼è‡´æ•°æ®ä¸è¢«å‘å¸ƒã€‚æ­¤å¤–ï¼Œä»æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°â€œç¼“å†²åŒº: 12æ¡â€ï¼Œè¯´æ˜è¿˜æœ‰12æ¡æ•°æ®åœ¨ç­‰å¾…å‘å¸ƒï¼Œè¿™äº›æ•°æ®å·²ç»è¢«â€œæ¥æ”¶â€è®¡æ•°ï¼Œä½†è¿˜æ²¡æœ‰è¢«â€œå‘å¸ƒâ€åˆ°Redisï¼Œä¼šåœ¨ä¸‹æ¬¡æ‰¹é‡å‘å¸ƒæˆ–ç¨‹åºåœæ­¢æ—¶æ‰å‘å¸ƒã€‚

ç”±äºç»Ÿè®¡æ˜¯å®æ—¶è®¡ç®—çš„ï¼Œåœ¨æŸä¸ªæ—¶é—´ç‚¹ï¼ˆä¾‹å¦‚ 09:34:05ï¼‰ï¼š
- æ¥æ”¶è®¡æ•°ï¼š10972 æ¡ï¼ˆå·²å¤„ç†çš„è‚¡ç¥¨æ•°æ®ï¼‰
- å‘å¸ƒè®¡æ•°ï¼š10960 æ¡ï¼ˆå·²æˆåŠŸå‘å¸ƒåˆ° Redisï¼‰
- å·®å¼‚ï¼š12 æ¡ï¼ˆä¸»è¦æ˜¯ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼‰

æ€»ç»“ï¼š99.9% çš„æˆåŠŸç‡æ˜¯æ­£å¸¸çš„ï¼Œä¸»è¦åŸå› æ˜¯ç¼“å†²åŒºä¸­æœ‰å°‘é‡æ•°æ®è¿˜æœªå‘å¸ƒï¼Œä»¥åŠæå°‘æ•°æ•°æ®å› å®Œæ•´æ€§éªŒè¯å¤±è´¥è¢«è¿‡æ»¤ã€‚è¿™ä¸ªæˆåŠŸç‡è¡¨æ˜ç³»ç»Ÿè¿è¡Œè‰¯å¥½ï¼Œæ•°æ®è´¨é‡æ§åˆ¶æœ‰æ•ˆã€‚

### Mac ç«¯å®æ—¶ç›‘æ§

```
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                å¢å¼ºç‰ˆæ•°æ®æ¶ˆè´¹ç³»ç»Ÿ v2.0 - Macç«¯                 â•‘
    â•‘                                                              â•‘
    â•‘  åŸºäºæœ€ä½³å®è·µçš„é«˜æ€§èƒ½è‚¡ç¥¨æ•°æ®æ¶ˆè´¹ä¸å­˜å‚¨ç³»ç»Ÿ                     â•‘
    â•‘                                                              â•‘
    â•‘  ä¸»è¦ç‰¹æ€§:                                                    â•‘
    â•‘  â€¢ å¤šçº¿ç¨‹æ‰¹é‡æ•°æ®å¤„ç†                                         â•‘
    â•‘  â€¢ æ•°æ®è´¨é‡æ£€æŸ¥å’Œè¯„åˆ†                                         â•‘
    â•‘  â€¢ ClickHouseé«˜æ€§èƒ½å­˜å‚¨                                      â•‘
    â•‘  â€¢ å®æ—¶ç›‘æ§å’Œèµ„æºç®¡ç†                                         â•‘
    â•‘  â€¢ è‡ªåŠ¨æ•°æ®æ¸…ç†å’Œç»´æŠ¤                                         â•‘
    â•‘                                                              â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ­£åœ¨åŠ è½½é…ç½®...
============================================================
Macç«¯ç³»ç»Ÿé…ç½®ä¿¡æ¯
============================================================
æ‰¹é‡å¤§å°: 1000
æ‰¹é‡è¶…æ—¶: 5.0ç§’
å·¥ä½œçº¿ç¨‹æ•°: 4
æ•°æ®è´¨é‡æ£€æŸ¥: å¯ç”¨
æ•°æ®ä¿ç•™å¤©æ•°: 30
æ—¥å¿—çº§åˆ«: INFO
============================================================
2025-06-06 18:44:36,876 - __main__ - INFO - æ­£åœ¨åˆå§‹åŒ–å¢å¼ºç‰ˆæ•°æ®æ¶ˆè´¹å™¨...
2025-06-06 18:44:36,876 - __main__ - INFO - æ­£åœ¨å¯åŠ¨å¢å¼ºç‰ˆæ•°æ®æ¶ˆè´¹...
2025-06-06 18:44:37,404 - enhanced_data_consumer - INFO - Redis è¿æ¥æ­£å¸¸
2025-06-06 18:44:37,442 - enhanced_data_consumer - INFO - ClickHouse è¿æ¥æ­£å¸¸
2025-06-06 18:44:37,446 - enhanced_data_consumer - INFO - æ•°æ®åº“è¡¨åˆå§‹åŒ–å®Œæˆ
2025-06-06 18:44:37,449 - enhanced_data_consumer - INFO - èšåˆè¡¨åˆ›å»ºå®Œæˆ
2025-06-06 18:44:37,449 - enhanced_data_consumer - INFO - ç‰©åŒ–è§†å›¾åˆ›å»ºè·³è¿‡ï¼Œä½¿ç”¨æ‰‹åŠ¨èšåˆæ–¹å¼
2025-06-06 18:44:37,449 - enhanced_data_consumer - INFO - å¯åŠ¨æ‰¹é‡æ’å…¥å·¥ä½œçº¿ç¨‹: worker-0
2025-06-06 18:44:37,450 - enhanced_data_consumer - INFO - å¯åŠ¨æ‰¹é‡æ’å…¥å·¥ä½œçº¿ç¨‹: worker-1
2025-06-06 18:44:37,450 - enhanced_data_consumer - INFO - å¯åŠ¨æ‰¹é‡æ’å…¥å·¥ä½œçº¿ç¨‹: worker-2
2025-06-06 18:44:37,450 - enhanced_data_consumer - INFO - å¯åŠ¨æ‰¹é‡æ’å…¥å·¥ä½œçº¿ç¨‹: worker-3
2025-06-06 18:44:37,451 - enhanced_data_consumer - INFO - å¢å¼ºç‰ˆæ•°æ®æ¶ˆè´¹å™¨å¯åŠ¨æˆåŠŸ
2025-06-06 18:44:37,451 - enhanced_data_consumer - INFO - å¼€å§‹æ¶ˆè´¹ Redis æ•°æ®...
2025-06-06 18:45:39,047 - enhanced_data_consumer - INFO - ============================================================
2025-06-06 18:45:39,047 - enhanced_data_consumer - INFO - Mac ç«¯æ€§èƒ½ç›‘æ§æŠ¥å‘Š
2025-06-06 18:45:39,048 - enhanced_data_consumer - INFO - ============================================================
2025-06-06 18:45:39,048 - enhanced_data_consumer - INFO - è¿è¡Œæ—¶é—´: 0:01:02.170886
2025-06-06 18:45:39,048 - enhanced_data_consumer - INFO - æ¶ˆè´¹æ•°æ®: 363 æ¡ (5.8/ç§’)
2025-06-06 18:45:39,048 - enhanced_data_consumer - INFO - æ’å…¥æ•°æ®: 341 æ¡ (5.5/ç§’)
2025-06-06 18:45:39,049 - enhanced_data_consumer - INFO - æˆåŠŸç‡: 93.9%
2025-06-06 18:45:39,049 - enhanced_data_consumer - INFO - æ’å…¥é”™è¯¯: 0 æ¬¡
2025-06-06 18:45:39,050 - enhanced_data_consumer - INFO - è´¨é‡é”™è¯¯: 0 æ¬¡
2025-06-06 18:45:39,050 - enhanced_data_consumer - INFO - é˜Ÿåˆ—å¤§å°: 0
2025-06-06 18:45:39,050 - enhanced_data_consumer - INFO - å¤„ç†è‚¡ç¥¨: 363 åª
2025-06-06 18:45:39,050 - enhanced_data_consumer - INFO - æœ€åæ’å…¥: 2025-06-06 18:45:36.063544
2025-06-06 18:45:39,050 - enhanced_data_consumer - INFO - ============================================================
2025-06-06 18:46:44,277 - enhanced_data_consumer - INFO - ============================================================
2025-06-06 18:46:44,277 - enhanced_data_consumer - INFO - Macç«¯æ€§èƒ½ç›‘æ§æŠ¥å‘Š
2025-06-06 18:46:44,277 - enhanced_data_consumer - INFO - ============================================================
2025-06-06 18:46:44,277 - enhanced_data_consumer - INFO - è¿è¡Œæ—¶é—´: 0:02:07.400751
2025-06-06 18:46:44,278 - enhanced_data_consumer - INFO - æ¶ˆè´¹æ•°æ®: 716æ¡ (5.6/ç§’)
2025-06-06 18:46:44,278 - enhanced_data_consumer - INFO - æ’å…¥æ•°æ®: 700æ¡ (5.5/ç§’)
2025-06-06 18:46:44,278 - enhanced_data_consumer - INFO - æˆåŠŸç‡: 97.8%
2025-06-06 18:46:44,278 - enhanced_data_consumer - INFO - æ’å…¥é”™è¯¯: 0æ¬¡
2025-06-06 18:46:44,278 - enhanced_data_consumer - INFO - è´¨é‡é”™è¯¯: 0æ¬¡
2025-06-06 18:46:44,278 - enhanced_data_consumer - INFO - é˜Ÿåˆ—å¤§å°: 0
2025-06-06 18:46:44,278 - enhanced_data_consumer - INFO - å¤„ç†è‚¡ç¥¨: 716åª
2025-06-06 18:46:44,279 - enhanced_data_consumer - INFO - æœ€åæ’å…¥: 2025-06-06 18:46:41.544365
2025-06-06 18:46:44,279 - enhanced_data_consumer - INFO - ============================================================
```

## ğŸ› ï¸ **å¼€å‘è¿‡ç¨‹ä¸­çš„æŠ€æœ¯æŒ‘æˆ˜**

### æŒ‘æˆ˜ 1ï¼šQMT API çš„å…¼å®¹æ€§é—®é¢˜

åœ¨æµ‹è¯•å…¨æ¨è¡Œæƒ…è®¢é˜…æ—¶ï¼Œæˆ‘ä»¬é‡åˆ°äº† API å…¼å®¹æ€§é—®é¢˜ï¼š

```python
# ç¬¬ä¸€æ¬¡å°è¯•å¤±è´¥
try:
    result = xtdata.subscribe_whole_quote(
        code_list=self.stock_list,
        callback=self.on_whole_quote_data
    )
except Exception as e:
    self.logger.error(f"å…¨æ¨è¡Œæƒ…è®¢é˜…å¤±è´¥: {e}")
    # è‡ªåŠ¨é™çº§åˆ°å•è‚¡è®¢é˜…
    return self.start_individual_subscription()
```

007 æœºæ™ºåœ°è®¾è®¡äº†é™çº§æœºåˆ¶ï¼šå¦‚æœå…¨æ¨è¡Œæƒ…è®¢é˜…å¤±è´¥ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å•è‚¡è®¢é˜…æ¨¡å¼ï¼Œç¡®ä¿ç³»ç»Ÿçš„é²æ£’æ€§ã€‚

### æŒ‘æˆ˜ 2ï¼šæ•°æ®æ ¼å¼çš„å¤šæ ·æ€§

QMT è¿”å›çš„æ•°æ®æ ¼å¼å¹¶ä¸ç»Ÿä¸€ï¼Œæœ‰æ—¶æ˜¯å­—å…¸ï¼Œæœ‰æ—¶æ˜¯åˆ—è¡¨ï¼š

```python
def process_quote_data(self, symbol, quote_data):
    """å¤„ç†è¡Œæƒ…æ•°æ®"""
    if isinstance(quote_data, dict):
        # å­—å…¸æ ¼å¼å¤„ç†
        minute_bar = {
            "symbol": symbol,
            "open": float(quote_data.get('open', 0)),
            # ...
        }
    elif isinstance(quote_data, list) and len(quote_data) >= 6:
        # åˆ—è¡¨æ ¼å¼å¤„ç†
        minute_bar = {
            "symbol": symbol,
            "open": float(quote_data[1]) if len(quote_data) > 1 else 0,
            # ...
        }
```

007 è®¾è®¡äº†æ™ºèƒ½çš„æ•°æ®æ ¼å¼é€‚é…å™¨ï¼Œèƒ½å¤Ÿè‡ªåŠ¨è¯†åˆ«å’Œå¤„ç†ä¸åŒçš„æ•°æ®æ ¼å¼ã€‚

### ç³»ç»ŸåŠŸèƒ½éªŒè¯

å¢å¼ºç‰ˆç³»ç»Ÿè‡ªåŠ¨å®Œæˆäº†ä»¥ä¸‹åŠŸèƒ½ï¼š

- âœ… **å…¨å¸‚åœºè¦†ç›–**ï¼š1000 åªè‚¡ç¥¨å®æ—¶è®¢é˜…ï¼Œè¦†ç›–ä¸»æ¿ã€ä¸­å°æ¿ã€åˆ›ä¸šæ¿ã€ç§‘åˆ›æ¿
- âœ… **æ™ºèƒ½æ•°æ®è´¨é‡**ï¼š90% ä»¥ä¸Šçš„æ•°æ®è´¨é‡ï¼Œè‡ªåŠ¨è¿‡æ»¤å¼‚å¸¸æ•°æ®
- âœ… **æ‰¹é‡é«˜æ•ˆå¤„ç†**ï¼š6 æ¡/ç§’çš„å¤„ç†é€Ÿåº¦
- âœ… **å®æ—¶æ€§èƒ½ç›‘æ§**ï¼šæ¯åˆ†é’Ÿè¾“å‡ºè¯¦ç»†ç›‘æ§æŠ¥å‘Š
- âœ… **è‡ªåŠ¨é”™è¯¯æ¢å¤**ï¼šç½‘ç»œä¸­æ–­è‡ªåŠ¨é‡è¿ï¼ŒAPI å¤±è´¥è‡ªåŠ¨é™çº§
- âœ… **èµ„æºä¼˜åŒ–ç®¡ç†**ï¼šå†…å­˜ä½¿ç”¨ç¨³å®šï¼ŒCPU ä½¿ç”¨ç‡ä½
- âœ… **7Ã—24 å°æ—¶è¿è¡Œ**ï¼šè¿ç»­è¿è¡Œ 48 å°æ—¶æ— æ•…éšœ

### æ•°æ®å­˜å‚¨æ•ˆæœéªŒè¯

"è®©æˆ‘ä»¬å¿«é€ŸæŸ¥è¯¢ä¸€ä¸‹æœ€è¿‘ 3 åˆ†é’Ÿçš„æ•°æ®ï¼ŒéªŒè¯ç³»ç»Ÿçš„å®æ—¶æ€§ã€‚"æˆ‘æ‰“å¼€ ClickHouse å®¢æˆ·ç«¯ã€‚

```sql
-- æŸ¥è¯¢æœ€è¿‘ 3 åˆ†é’Ÿçš„æ•°æ®
SELECT
    count() as total_records,
    count(DISTINCT symbol) as unique_symbols,
    min(frame) as earliest_time,
    max(frame) as latest_time,
    round(avg(vol), 0) as avg_volume
FROM minute_bars
WHERE frame >= now() - INTERVAL 3 MINUTE;
```

![](https://images.jieyu.ai/images/2025/06/8_05.png)

"å¤ªæ£’äº†ï¼"æˆ‘å…´å¥‹åœ°æŒ‡ç€æŸ¥è¯¢ç»“æœï¼Œ"ä½ çœ‹ï¼š
- **å®æ—¶æ€§éªŒè¯**ï¼šæœ€è¿‘ 3 åˆ†é’Ÿå†…æœ‰ 5434 æ¡è®°å½•
- **ç³»ç»ŸçŠ¶æ€**ï¼šæ•°æ®æŒç»­æ›´æ–°åˆ°æœ€æ–°æ—¶é—´ï¼Œç³»ç»Ÿè¿è¡Œæ­£å¸¸"

007 ä¹Ÿå¾ˆæ»¡æ„ï¼š"æ”¶åˆ°ğŸ«¡ï¼ç®€å•çš„æŸ¥è¯¢å°±èƒ½éªŒè¯ç³»ç»Ÿçš„å®æ—¶æ€§å’Œç¨³å®šæ€§ï¼Œå¢å¼ºç‰ˆè¡¨ç°ä¼˜å¼‚ï¼"

## â“å¤š client æ¶ˆè´¹ Redis çš„æ•°æ®

!!! question
    å¦‚æœæˆ‘å¸Œæœ›æ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯ï¼ˆä¾‹å¦‚ 5 ä¸ªï¼‰åŒæ—¶æ¶ˆè´¹ç›¸åŒçš„ Redis æ•°æ®ï¼Œåº”è¯¥æ€ä¹ˆè®¾è®¡æ–¹æ¡ˆå‘¢ï¼Ÿ

![](https://images.jieyu.ai/images/2025/06/8_11.png)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®ç”Ÿäº§è€…     â”‚â”€â”€â”€â–¶â”‚  Redis Streams  â”‚â”€â”€â”€â–¶â”‚   æ¶ˆè´¹è€…ç»„      â”‚
â”‚  (QMT Windows)  â”‚    â”‚                 â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚                                â”‚                                â”‚
                       â–¼                                â–¼                                â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   æ¶ˆè´¹è€…å®¢æˆ·ç«¯ 1  â”‚              â”‚   æ¶ˆè´¹è€…å®¢æˆ·ç«¯ 2  â”‚               â”‚   æ¶ˆè´¹è€…å®¢æˆ·ç«¯ N  â”‚
              â”‚   (Mac ç«¯)      â”‚              â”‚   (Linux ç«¯)    â”‚              â”‚   (å…¶ä»–ç«¯)      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚                                â”‚                                â”‚
                       â–¼                                â–¼                                â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  ClickHouse DB  â”‚              â”‚  ClickHouse DB  â”‚              â”‚  å…¶ä»–å­˜å‚¨ç³»ç»Ÿ     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

![](https://images.jieyu.ai/images/2025/06/8_06.png)

007 éå¸¸è´´å¿ƒåœ°ç»™å‡ºäº†ä»¥ä¸‹çš„æ–¹æ¡ˆï¼š

### æ–¹æ¡ˆè®¾è®¡
#### æ–¹æ¡ˆä¸€ï¼šå‘å¸ƒ/è®¢é˜…æ¨¡å¼ï¼ˆPub/Subï¼‰- æ¨è
```
æ•°æ®ç”Ÿäº§è€… â†’ Redis Pub/Sub Channel â†’ å¤šä¸ªæ¶ˆè´¹è€…å®¢æˆ·ç«¯
```
ä¼˜ç‚¹ï¼š
- å¤©ç„¶æ”¯æŒå¤šä¸ªè®¢é˜…è€…
- å®æ—¶æ€§å¥½
- å®ç°ç®€å•

ç¼ºç‚¹ï¼š
- æ¶ˆæ¯ä¸æŒä¹…åŒ–ï¼Œå®¢æˆ·ç«¯ç¦»çº¿æ—¶ä¼šä¸¢å¤±æ•°æ®
- æ— æ³•ä¿è¯æ¶ˆæ¯é€è¾¾

#### æ–¹æ¡ˆäºŒï¼šRedis Streams + æ¶ˆè´¹è€…ç»„ - æœ€ä½³æ–¹æ¡ˆ
```
æ•°æ®ç”Ÿäº§è€… â†’ Redis Stream â†’ æ¶ˆè´¹è€…ç»„ â†’ å¤šä¸ªæ¶ˆè´¹è€…å®¢æˆ·ç«¯
```
ä¼˜ç‚¹ï¼š
- æ¶ˆæ¯æŒä¹…åŒ–
- æ”¯æŒæ¶ˆè´¹è€…ç»„ï¼Œè‡ªåŠ¨è´Ÿè½½å‡è¡¡
- æ”¯æŒæ¶ˆæ¯ç¡®è®¤æœºåˆ¶
- æ”¯æŒæ•…éšœæ¢å¤

#### æ–¹æ¡ˆä¸‰ï¼šå¤šé˜Ÿåˆ—åˆ†ç‰‡æ¨¡å¼
```
æ•°æ®ç”Ÿäº§è€… â†’ å¤šä¸ª Redis é˜Ÿåˆ— â†’ å¤šä¸ªæ¶ˆè´¹è€…å®¢æˆ·ç«¯ï¼ˆæ¯ä¸ªå®¢æˆ·ç«¯æ¶ˆè´¹æ‰€æœ‰é˜Ÿåˆ—ï¼‰
```

### å…·ä½“å®ç°

ğŸ—ï¸ æ¶æ„è®¾è®¡
- åŸºäº Redis Streams + æ¶ˆè´¹è€…ç»„ï¼šè¿™æ˜¯æœ€ä½³æ–¹æ¡ˆï¼Œæ”¯æŒæ¶ˆæ¯æŒä¹…åŒ–ã€è‡ªåŠ¨è´Ÿè½½å‡è¡¡å’Œæ•…éšœæ¢å¤
- æ”¯æŒ 3 ç§æ¶ˆè´¹æ¨¡å¼ï¼š
    - å¹¿æ’­æ¨¡å¼ï¼šæ¯ä¸ªå®¢æˆ·ç«¯æ¥æ”¶æ‰€æœ‰æ•°æ®å‰¯æœ¬
    - åˆ†ç‰‡æ¨¡å¼ï¼šæ•°æ®æŒ‰è§„åˆ™åˆ†ç‰‡ï¼Œå®¢æˆ·ç«¯å¤„ç†ä¸åŒæ•°æ®å­é›†
    - æ··åˆæ¨¡å¼ï¼šç»“åˆå¹¿æ’­å’Œåˆ†ç‰‡çš„ä¼˜åŠ¿

ğŸ“ å®ç°æ–‡ä»¶
- `multi_client_design.md` - å®Œæ•´çš„æ¶æ„è®¾è®¡æ–‡æ¡£
- `multi_client_consumer.py` - å¤šå®¢æˆ·ç«¯æ¶ˆè´¹å™¨æ ¸å¿ƒå®ç°
- `multi_client_config.yaml` - è¯¦ç»†çš„é…ç½®æ–‡ä»¶æ¨¡æ¿
- `multi_client_main.py` - ä¸»ç¨‹åºå’Œç®¡ç†ç•Œé¢
- `stream_producer_example.py` - ç”Ÿäº§è€…ç«¯ç¤ºä¾‹ä»£ç 

Redis Streams æ•°æ®ç»“æ„ï¼š
```
Stream Key: minute_bar_stream
æ¶ˆæ¯æ ¼å¼: {
    "symbol": "000001.SZ",
    "frame": "2025-06-05 10:30:00",
    "open": 10.50,
    "high": 10.80,
    "low": 10.45,
    "close": 10.75,
    "vol": 1000000,
    "amount": 10750000,
    "timestamp": 1733356200.123,
    "quality_score": 0.95
}
```

æ¶ˆè´¹è€…ç»„é…ç½®ï¼š
```
æ¶ˆè´¹è€…ç»„å: minute_bar_consumers
æ¶ˆè´¹è€…ID: client_mac_001, client_linux_002, etc.
```


æ¶ˆè´¹è€…ç«¯çš„æ¶æ„ï¼š
```python
class MultiClientDataConsumer:
    def __init__(self, client_id, consumer_group="minute_bar_consumers"):
        self.client_id = client_id
        self.consumer_group = consumer_group
        self.stream_key = "minute_bar_stream"

    def start_consumption(self):
        # åˆ›å»ºæ¶ˆè´¹è€…ç»„
        self.create_consumer_group()

        # å¼€å§‹æ¶ˆè´¹æ•°æ®
        self.consume_stream_data()

    def create_consumer_group(self):
        try:
            self.redis_client.xgroup_create(
                self.stream_key,
                self.consumer_group,
                id='0',
                mkstream=True
            )
        except redis.ResponseError:
            # æ¶ˆè´¹è€…ç»„å·²å­˜åœ¨
            pass

    def consume_stream_data(self):
        while self.is_running:
            # ä»Streamè¯»å–æ•°æ®
            messages = self.redis_client.xreadgroup(
                self.consumer_group,
                self.client_id,
                {self.stream_key: '>'},
                count=100,
                block=1000
            )

            for stream, msgs in messages:
                for msg_id, fields in msgs:
                    self.process_message(msg_id, fields)

    def process_message(self, msg_id, fields):
        try:
            # å¤„ç†æ•°æ®
            self.handle_minute_bar_data(fields)

            # ç¡®è®¤æ¶ˆæ¯å¤„ç†å®Œæˆ
            self.redis_client.xack(
                self.stream_key,
                self.consumer_group,
                msg_id
            )
        except Exception as e:
            self.logger.error(f"å¤„ç†æ¶ˆæ¯å¤±è´¥: {e}")
            # å¯ä»¥é€‰æ‹©é‡è¯•æˆ–æ”¾å…¥æ­»ä¿¡é˜Ÿåˆ—
```

### å®ç°æ•ˆæœ

æˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ªå¤šå®¢æˆ·ç«¯æ¶ˆè´¹å™¨ç®¡ç†é¡µé¢ï¼Œåœ¨æ²¡æœ‰ä»»ä½•è¾“å…¥çš„æ—¶å€™ä¼šè¿”å›å¹³å®‰é“¶è¡Œçš„å®æ—¶ä»·æ ¼ï¼š
![](https://images.jieyu.ai/images/2025/06/8_10.png)

#### 1. æŸ¥çœ‹æ¶ˆè´¹è€…çŠ¶æ€
![](https://images.jieyu.ai/images/2025/06/8_07.png)

#### 2. æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
![](https://images.jieyu.ai/images/2025/06/8_08.png)

#### 3. åœæ­¢æ¶ˆè´¹è€…

![](https://images.jieyu.ai/images/2025/06/8_09.png)

### æ€»ç»“

"007ï¼Œè¿™æ¬¡çš„å¢å¼ºç‰ˆå¼€å‘çœŸçš„å¾ˆæ£’ï¼ä»åŸºç¡€ç‰ˆçš„åŸå‹éªŒè¯åˆ°å¢å¼ºç‰ˆçš„æ€§èƒ½é£è·ƒï¼Œå¹¶ä¸”ç»™æˆ‘æä¾›äº†å¤š Client é—®é¢˜çš„æ–¹æ¡ˆï¼Œä½ çš„è¡¨ç°è¶…å‡ºäº†æˆ‘çš„é¢„æœŸã€‚"æˆ‘ç”±è¡·åœ°èµå¹ã€‚

"è°¢è°¢ä½ çš„è®¤å¯ï¼è¿™å¾—ç›Šäºæˆ‘ä»¬å›¢é˜Ÿçš„åˆä½œå’Œä¸æ–­çš„å­¦ä¹ ã€‚"007 è°¦è™šåœ°è¯´ã€‚

ä¸‹ä¸€èŠ‚ï¼Œæˆ‘å’Œ 007 å°†ç»§ç»­è§£å†³åˆ†é’Ÿçº¿åˆæˆçš„é—®é¢˜ï¼Œå¹¶ä¸”å¯¹æˆ‘ä»¬çš„ç³»ç»Ÿé€»è¾‘è¿›ä¸€æ­¥ä¿®æ”¹å’Œå®Œå–„ã€‚