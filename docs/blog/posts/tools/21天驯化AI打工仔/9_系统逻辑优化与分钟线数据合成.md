# 21 å¤©é©¯åŒ– AI æ‰“å·¥ä»”ï¼šå¼€å‘é‡åŒ–äº¤æ˜“ç³»ç»Ÿï¼ˆä¹ï¼‰ç³»ç»Ÿé€»è¾‘ä¼˜åŒ–ä¸åˆ†é’Ÿçº¿æ•°æ®åˆæˆï¼šå½“æ•°æ®æµé‡ä¸Šæ™ºèƒ½åˆæˆ

> å½“åˆ†ç¬”æ•°æ®å¦‚æ½®æ°´èˆ¬æ¶Œæ¥ï¼Œå¦‚ä½•è®©ç³»ç»Ÿæ™ºèƒ½åœ°å°†å®ƒä»¬åˆæˆä¸ºæœ‰ä»·å€¼çš„åˆ†é’Ÿçº¿æ•°æ®ï¼Ÿæœ¬æ–‡å¸¦ä½ æ·±å…¥é‡åŒ–äº¤æ˜“ç³»ç»Ÿçš„æ ¸å¿ƒâ€”â€”æ•°æ®åˆæˆä¸ç³»ç»Ÿæ¶æ„ä¼˜åŒ–çš„ä¸–ç•Œï¼

"007ï¼Œæˆ‘ä»¬çš„å®æ—¶åˆ†ç¬”æ•°æ®è®¢é˜…ç³»ç»Ÿå·²ç»åŸºæœ¬å®Œæˆï¼Œä½†ç°åœ¨æˆ‘é‡åˆ°äº†ä¸€ä¸ªæ–°çš„æŒ‘æˆ˜ã€‚"æˆ‘ä¸€è¾¹æŸ¥çœ‹ç€ Redis ä¸­å †ç§¯å¦‚å±±çš„åˆ†ç¬”æ•°æ®ï¼Œä¸€è¾¹å¯¹æˆ‘çš„ AI åŠ©æ‰‹è¯´é“ã€‚

"ä»€ä¹ˆæŒ‘æˆ˜ï¼Ÿ"007 ç«‹åˆ»å›åº”é“ã€‚

"æˆ‘ä»¬ç°åœ¨æœ‰äº†æµ·é‡çš„åˆ†ç¬”æ•°æ®ï¼Œä½†é‡åŒ–ç­–ç•¥éœ€è¦çš„æ˜¯åˆ†é’Ÿçº¿æ•°æ®ã€‚è€Œä¸”ï¼Œæˆ‘å¸Œæœ›ç³»ç»Ÿèƒ½å¤Ÿæ™ºèƒ½åœ°å¤„ç†å½“æ—¥æ•°æ®å’Œå†å²æ•°æ®ï¼Œè®©å¤šä¸ªå®¢æˆ·ç«¯èƒ½å¤Ÿæ— ç¼æŸ¥è¯¢ã€‚"æˆ‘æŒ‡ç€å±å¹•ä¸Šå¯†å¯†éº»éº»çš„æ•°æ®è¯´é“ã€‚

è¿™æ˜¯æˆ‘ä»¬é‡åŒ–äº¤æ˜“ç³»ç»Ÿå¼€å‘çš„ç¬¬ 9 å¤©ã€‚å‰é¢å‡ å¤©ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸæ­å»ºäº†ä» Tushare è·å–æ•°æ®çš„åŸºç¡€æ¶æ„ï¼Œä¹Ÿå®ç°äº† QMT å®æ—¶åˆ†ç¬”æ•°æ®çš„è®¢é˜…ã€‚ä½†åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œæˆ‘å‘ç°äº†ä¸€ä¸ªå…³é”®é—®é¢˜ï¼š**åˆ†ç¬”æ•°æ®è™½ç„¶ç²¾ç¡®ï¼Œä½†å¯¹äºå¤§å¤šæ•°é‡åŒ–ç­–ç•¥æ¥è¯´ï¼Œåˆ†é’Ÿçº¿æ•°æ®æ‰æ˜¯çœŸæ­£éœ€è¦çš„**ã€‚

æ›´é‡è¦çš„æ˜¯ï¼Œæˆ‘éœ€è¦ä¸€ä¸ªæ™ºèƒ½çš„ç³»ç»Ÿæ¶æ„ï¼Œèƒ½å¤Ÿï¼š
- å®æ—¶å°†åˆ†ç¬”æ•°æ®åˆæˆä¸ºå¤šå‘¨æœŸåˆ†é’Ÿçº¿æ•°æ®
- æ™ºèƒ½åŒºåˆ†å½“æ—¥æ•°æ®å’Œå†å²æ•°æ®çš„å­˜å‚¨ä¸æŸ¥è¯¢
- æ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶æŸ¥è¯¢ï¼Œè€Œä¸å½±å“ç³»ç»Ÿæ€§èƒ½
- ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§


## ğŸ¯ éœ€æ±‚åˆ†æï¼šæ„å»ºæ™ºèƒ½æ•°æ®åˆæˆç³»ç»Ÿ

"åœ¨å¼€å§‹ç¼–ç ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®ç³»ç»Ÿçš„æ ¸å¿ƒéœ€æ±‚ã€‚"æˆ‘å¯¹ 007 è¯´é“ã€‚

ç»è¿‡æ·±å…¥æ€è€ƒï¼Œæˆ‘æ¢³ç†å‡ºäº†ä»¥ä¸‹å…³é”®ç³»ç»Ÿæ¶æ„ï¼š

![](https://fastly.jsdelivr.net/gh/bucketio/img12@main/2025/06/12/1749717184302-d34decba-a685-40fa-91a8-93c018f4a1d1.png)

æ³¨æ„ï¼š
- æ‰€æœ‰çš„åˆ†é’Ÿçº¿æ•°æ®ï¼ˆä¸è®ºæ˜¯å½“æ—¥åˆæˆçš„æ•°æ®è¿˜æ˜¯è®¢é˜…çš„å†å²åˆ†é’Ÿçº¿æ•°æ®ï¼‰éƒ½å¿…é¡»æ˜¯**äº¤æ˜“æ—¶é—´å†…**çš„æ•°æ®ã€‚ä¸ç„¶æ²¡æœ‰æ„ä¹‰ã€‚
- å½“æ—¥åˆæˆçš„åˆ†é’Ÿçº¿æ•°æ®æ˜¯ä¿å­˜åœ¨Redisä¸­çš„ï¼Œä¸è¦å­˜å…¥Clickhouseã€‚
- åªæœ‰ä»QMTè®¢é˜…çš„å†å²çš„åˆ†é’Ÿçº¿æ•°æ®æ˜¯é€šè¿‡Redisä¿å­˜åœ¨Clickhouseä¸­çš„ï¼Œè¯·æ³¨æ„ä¸å½“æ—¥åˆæˆçš„åˆ†é’Ÿçº¿æ•°æ®è¿›è¡ŒåŒºåˆ†ã€‚

å‚è€ƒå†…å®¹ï¼š[**Clickhouse çš„ Redis æ’ä»¶**](https://clickhouse.com/docs/zh/engines/table-engines/integrations/redis) å’Œ [**Clickhouse çš„ç‰©åŒ–è§†å›¾**](https://clickhouse.com/docs/zh/engines/table-engines/integrations/materialized-postgresql)ã€‚

"è¿™ä¸ªæ¶æ„çœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œç‰¹åˆ«æ˜¯æ•°æ®åˆæˆçš„éƒ¨åˆ†ã€‚"æˆ‘æœ‰äº›æ‹…å¿ƒåœ°è¯´é“ã€‚

"æ²¡å…³ç³»ï¼æˆ‘ä»¬å¯ä»¥åˆ†æ­¥å®ç°ã€‚å…ˆæ­å»ºåŸºç¡€æ¶æ„ï¼Œç„¶åé€æ­¥ä¼˜åŒ–æ•°æ®åˆæˆç®—æ³•ã€‚"007 ä¿¡å¿ƒæ»¡æ»¡åœ°å›ç­”ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡ï¼šä¸‰ç«¯åˆ†ç¦»çš„æ™ºèƒ½æ¶æ„

"æˆ‘ä»¬éœ€è¦è®¾è®¡ä¸€ä¸ªçœŸæ­£æ™ºèƒ½çš„ä¸‰ç«¯åˆ†ç¦»æ¶æ„ã€‚"007 å¼€å§‹äº†æ¶æ„è®¾è®¡ã€‚

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Windowsç«¯     â”‚    â”‚    è¿œç¨‹Redis     â”‚    â”‚    Macç«¯        â”‚
â”‚   æ•°æ®ç”Ÿäº§è€…     â”‚â”€â”€â”€â–¶â”‚   æ¶ˆæ¯é˜Ÿåˆ—+ç¼“å­˜   â”‚â”€â”€â”€â–¶â”‚   æ•°æ®æ¶ˆè´¹è€…     â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â€¢ QMTåˆ†ç¬”è®¢é˜…    â”‚    â”‚ â€¢ åˆ†ç¬”æ•°æ®é˜Ÿåˆ—   â”‚    â”‚ â€¢ å†å²æ•°æ®å­˜å‚¨   â”‚
â”‚ â€¢ åˆ†é’Ÿçº¿åˆæˆ     â”‚    â”‚ â€¢ å½“æ—¥åˆ†é’Ÿçº¿ç¼“å­˜ â”‚    â”‚ â€¢ ClickHouseç®¡ç† â”‚
â”‚ â€¢ äº¤æ˜“æ—¶é—´éªŒè¯   â”‚    â”‚ â€¢ æ•°æ®è·¯ç”±       â”‚    â”‚ â€¢ æ•°æ®æ¸…ç†       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   å¤šClientç«¯    â”‚
                       â”‚   æ•°æ®æŸ¥è¯¢è€…     â”‚
                       â”‚                 â”‚
                       â”‚ â€¢ WebæŸ¥è¯¢ç•Œé¢   â”‚
                       â”‚ â€¢ æ™ºèƒ½æ•°æ®è·¯ç”±   â”‚
                       â”‚ â€¢ 24å°æ—¶åˆ¶æ—¶é—´   â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµè®¾è®¡

"æ•°æ®æµçš„è®¾è®¡æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒã€‚"æˆ‘å¯¹ 007 å¼ºè°ƒé“ã€‚

**æ•°æ®æµå‘ï¼š**
1. **åˆ†ç¬”æ•°æ®æµ**ï¼šQMT â†’ Windowsç«¯ â†’ Redisé˜Ÿåˆ—
2. **å½“æ—¥åˆ†é’Ÿçº¿æµ**ï¼šWindowsç«¯åˆæˆ â†’ Redisç¼“å­˜ â†’ Clientç«¯æŸ¥è¯¢
3. **å†å²åˆ†é’Ÿçº¿æµ**ï¼šMacç«¯å¤„ç† â†’ ClickHouseå­˜å‚¨ â†’ Clientç«¯æŸ¥è¯¢
4. **æ··åˆæŸ¥è¯¢æµ**ï¼šClientç«¯ â†’ Redis+ClickHouse â†’ æ•°æ®åˆå¹¶ â†’ è¿”å›ç»“æœ

## ğŸ”§ Windows ç«¯çš„å®ç°

"Windows ç«¯æ˜¯æ•´ä¸ªç³»ç»Ÿçš„å¿ƒè„ï¼Œè´Ÿè´£æ•°æ®çš„å®æ—¶åˆæˆã€‚"007 å¼€å§‹äº† Windows ç«¯çš„è®¾è®¡ã€‚

### åˆ†ç¬”æ•°æ®å¦‚ä½•åˆæˆåˆ†é’Ÿçº¿æ•°æ®ï¼Ÿ

007 è®¾è®¡äº†ä¸€ä¸ªç²¾å·§çš„æ•°æ®åˆæˆå¼•æ“ï¼š

```python
class BarDataSynthesizer:
    """åˆ†é’Ÿçº¿æ•°æ®åˆæˆå™¨"""

    def __init__(self):
        # å­˜å‚¨å„ä¸ªè‚¡ç¥¨çš„åˆ†ç¬”æ•°æ®ç¼“å­˜
        self.tick_cache: Dict[str, List[TickData]] = defaultdict(list)
        # å­˜å‚¨å„ä¸ªå‘¨æœŸçš„åˆ†é’Ÿçº¿ç¼“å­˜
        self.bar_cache: Dict[int, Dict[str, List[BarData]]] = {
            1: defaultdict(list),
            5: defaultdict(list),
            15: defaultdict(list),
            30: defaultdict(list)
        }
        # äº¤æ˜“æ—¶é—´éªŒè¯å™¨
        self.trading_validator = TradingTimeValidator()

    def add_tick_data(self, tick_data: TickData):
        """æ·»åŠ åˆ†ç¬”æ•°æ®å¹¶è§¦å‘åˆæˆ"""
        # éªŒè¯äº¤æ˜“æ—¶é—´
        if not self.trading_validator.validate_tick_data(tick_dict):
            return

        # ç¼“å­˜åˆ†ç¬”æ•°æ®
        self.tick_cache[tick_data.symbol].append(tick_data)

        # åˆæˆ1åˆ†é’Ÿçº¿
        bar_1min = self._synthesize_1min_bar(tick_data.symbol)
        if bar_1min:
            self.bar_cache[1][tick_data.symbol].append(bar_1min)

            # åŸºäº1åˆ†é’Ÿçº¿åˆæˆå…¶ä»–å‘¨æœŸ
            for period in [5, 15, 30]:
                bar = self._synthesize_multi_min_bar(tick_data.symbol, period)
                if bar:
                    self.bar_cache[period][tick_data.symbol].append(bar)
```

**1åˆ†é’Ÿçº¿åˆæˆï¼š**
```python
def _synthesize_1min_bar(self, symbol: str) -> BarData:
    """åˆæˆ1åˆ†é’Ÿçº¿"""
    ticks = self.tick_cache[symbol]
    if not ticks:
        return None

    # è·å–å½“å‰åˆ†é’Ÿçš„å¼€å§‹æ—¶é—´
    current_time = ticks[-1].time
    minute_start = current_time.replace(second=0, microsecond=0)
    minute_end = minute_start + timedelta(minutes=1)

    # ç­›é€‰å½“å‰åˆ†é’Ÿçš„åˆ†ç¬”æ•°æ®
    minute_ticks = [
        tick for tick in ticks
        if minute_start <= tick.time < minute_end
    ]

    if not minute_ticks:
        return None

    # è®¡ç®—OHLCV
    prices = [tick.price for tick in minute_ticks]
    volumes = [tick.volume for tick in minute_ticks]
    amounts = [tick.amount for tick in minute_ticks]

    return BarData(
        symbol=symbol,
        frame=minute_start,
        open=prices[0],
        high=max(prices),
        low=min(prices),
        close=prices[-1],
        vol=sum(volumes),
        amount=sum(amounts)
    )
```

**å¤šå‘¨æœŸåˆæˆï¼š**
```python
def _synthesize_multi_min_bar(self, symbol: str, period: int) -> BarData:
    """åˆæˆå¤šåˆ†é’Ÿçº¿ï¼ˆ5åˆ†é’Ÿã€15åˆ†é’Ÿã€30åˆ†é’Ÿï¼‰"""
    bars_1min = self.bar_cache[1][symbol]
    if not bars_1min:
        return None

    # è·å–å½“å‰å‘¨æœŸçš„å¼€å§‹æ—¶é—´
    current_time = bars_1min[-1].frame
    period_start = self._get_period_start(current_time, period)
    period_end = period_start + timedelta(minutes=period)

    # ç­›é€‰å½“å‰å‘¨æœŸçš„1åˆ†é’Ÿçº¿æ•°æ®
    period_bars = [
        bar for bar in bars_1min
        if period_start <= bar.frame < period_end
    ]

    if len(period_bars) == 0:
        return None

    # åˆæˆå¤šåˆ†é’Ÿçº¿
    return BarData(
        symbol=symbol,
        frame=period_start,
        open=period_bars[0].open,
        high=max(bar.high for bar in period_bars),
        low=min(bar.low for bar in period_bars),
        close=period_bars[-1].close,
        vol=sum(bar.vol for bar in period_bars),
        amount=sum(bar.amount for bar in period_bars)
    )
```

æˆ‘ä»¬çš„åˆæˆæ–¹æ³•æ˜¯ï¼šå…ˆåˆæˆ1åˆ†é’Ÿçº¿ï¼Œå†åŸºäº1åˆ†é’Ÿçº¿åˆæˆå…¶ä»–å‘¨æœŸï¼Œç¡®ä¿äº†æ•°æ®çš„ä¸€è‡´æ€§ã€‚

### Windows ç«¯ç›‘æ§é¡µé¢

![](https://fastly.jsdelivr.net/gh/bucketio/img13@main/2025/06/12/1749714849593-db73da45-d171-4961-9231-ba394dee4eeb.png)

![](https://fastly.jsdelivr.net/gh/bucketio/img13@main/2025/06/12/1749714863971-cb979cbd-9222-4553-a13a-3df5d4cbd97e.png)

![](https://fastly.jsdelivr.net/gh/bucketio/img9@main/2025/06/12/1749714871938-f310dc4d-e9d6-4462-a6b7-9b2d2d6a613c.png)

ä½†æ˜¯æˆ‘è§‰å¾—è¿™ä¸ªç›‘æ§é¡µé¢çš„æ’ç‰ˆå¸ƒå±€å¤ªç®€é™‹äº†ï¼Œäºæ˜¯ï¼Œæˆ‘ä¾¿è®© 007 å¸®æˆ‘è®¾è®¡ä¸€ä¸ªæ–°çš„å‰ç«¯é¡µé¢ä»¥æ›´å¥½åœ°å‘ˆç°ç›‘æ§æƒ…å†µã€‚

![](https://fastly.jsdelivr.net/gh/bucketio/img5@main/2025/06/12/1749715131310-b459702b-c11d-4e84-9f8b-7ee00f319081.png)

![](https://fastly.jsdelivr.net/gh/bucketio/img13@main/2025/06/12/1749715137990-e43e1496-2fb7-481d-85b6-6bfcd3886b42.png)

## ğŸ Mac ç«¯çš„å®ç°

### æ•°æ®æ¶ˆè´¹ä¸å­˜å‚¨

Mac ç«¯çš„æ ¸å¿ƒèŒè´£æ˜¯å°† Redis ä¸­çš„å†å²æ•°æ®è½¬ç§»åˆ° ClickHouseï¼š

```python
class MacDataService:
    """Macç«¯æ•°æ®æœåŠ¡"""

    def __init__(self):
        self.redis_manager = RedisManager()
        self.clickhouse_manager = ClickHouseManager()

    def consume_historical_data(self):
        """æ¶ˆè´¹å†å²æ•°æ®"""
        while self.is_running:
            try:
                # ä»Redisè·å–å†å²åˆ†é’Ÿçº¿æ•°æ®
                for period in [1, 5, 15, 30]:
                    queue_name = f"historical_bar_data_{period}min"
                    data = self.redis_manager.client.brpop(queue_name, timeout=1)

                    if data:
                        bar_data = BarData(**json.loads(data[1]))

                        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                        if not self.clickhouse_manager.data_exists(bar_data, period):
                            # æ’å…¥ClickHouse
                            self.clickhouse_manager.insert_bar_data(bar_data, period)
                        else:
                            # æ•°æ®å·²å­˜åœ¨ï¼Œç›´æ¥åˆ é™¤Redisä¸­çš„æ•°æ®
                            self.logger.info(f"æ•°æ®å·²å­˜åœ¨ï¼Œè·³è¿‡: {bar_data.symbol} {bar_data.frame}")

            except Exception as e:
                self.logger.error(f"æ•°æ®æ¶ˆè´¹é”™è¯¯: {e}")
                time.sleep(5)
```

### å‡Œæ™¨2ç‚¹çš„ç‰¹æ®Šå¤„ç†

"ç³»ç»Ÿéœ€è¦åœ¨å‡Œæ™¨2ç‚¹è¿›è¡Œç‰¹æ®Šçš„æ•°æ®æ¸…ç†ã€‚"æˆ‘å¯¹ 007 è¯´æ˜äº†éœ€æ±‚ã€‚

```python
def handle_cleanup_time(self):
    """å¤„ç†å‡Œæ™¨2ç‚¹çš„æ•°æ®æ¸…ç†"""
    try:
        # 1. å¤„ç†å‰ä¸€å¤©çš„å†å²æ•°æ®
        self.process_previous_day_data()

        # 2. æ¸…ç†Redisçš„è®¢é˜…æ¶ˆæ¯é˜Ÿåˆ—
        self.cleanup_redis_queues()

        # 3. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
        self.verify_data_integrity()

        self.logger.info("å‡Œæ™¨2ç‚¹æ•°æ®æ¸…ç†å®Œæˆ")

    except Exception as e:
        self.logger.error(f"æ•°æ®æ¸…ç†é”™è¯¯: {e}")
```

### Mac ç«¯çš„ç›‘æ§é¡µé¢

ä¸ºäº†æ£€æŸ¥Rediså’ŒClickhouseä¹‹é—´çš„æ•°æ®ä¼ é€æ˜¯æ­£å¸¸çš„ï¼Œå¹¶ä¸”èƒ½å®æ—¶ç›‘æ§æ•°æ®ä¼ è¾“çš„é€Ÿåº¦å’Œè¿›åº¦ï¼Œæˆ‘è¦æ±‚ 007 è®¾è®¡ä¸€ä¸ª Mac ç«¯ç«¯ç›‘æ§é¡µé¢ï¼š

![](https://fastly.jsdelivr.net/gh/bucketio/img10@main/2025/06/12/1749715408878-86df1766-52e1-492f-829c-037625aebdef.png)


## ğŸ’» Client ç«¯çš„å®ç°

"Client ç«¯æ˜¯ç”¨æˆ·ç›´æ¥æ¥è§¦çš„ç•Œé¢ï¼Œå¿…é¡»åšåˆ°å®Œç¾ã€‚"æˆ‘å¯¹ 007 å¼ºè°ƒé“ã€‚

ä½†æ˜¯ï¼Œåœ¨ Client ç«¯çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é‡åˆ°äº†ä¸€ç³»åˆ—æŒ‘æˆ˜...

### ç¬¬ä¸€æ¬¡å°è¯•ï¼šå¤æ‚çš„è°ƒè¯•ç³»ç»Ÿ

æœ€åˆï¼Œ007 ä¸º Client ç«¯è®¾è®¡äº†ä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œçš„è°ƒè¯•ç³»ç»Ÿï¼š

```python
# å¤æ‚çš„è°ƒè¯•é€»è¾‘
def query_bar_data(self, symbol: str, start_time: datetime, end_time: datetime, period: int):
    debug_info = []
    debug_info.append(f"æŸ¥è¯¢å‚æ•°: {symbol}, {period}åˆ†é’Ÿ, {start_time} åˆ° {end_time}")
    debug_info.append(f"ä»Šå¤©: {today}, æŸ¥è¯¢æ—¥æœŸèŒƒå›´: {start_date} åˆ° {end_date}")

    # å¤§é‡çš„è°ƒè¯•ä¿¡æ¯...
    if len(all_redis_data) > 0 and len(redis_data) == 0:
        debug_info.append(f"âš ï¸ æ—¶é—´è¿‡æ»¤å¯¼è‡´æ•°æ®ä¸ºç©º")
        debug_info.append(f"æ•°æ®æ ·æœ¬æ—¶é—´: {sample_bar.frame}")
        # æ›´å¤šè°ƒè¯•ä¿¡æ¯...
```

"è¿™ä¸ªè°ƒè¯•ç³»ç»Ÿå¤ªå¤æ‚äº†ï¼"æˆ‘çœ‹ç€æ»¡å±çš„è°ƒè¯•ä»£ç ï¼Œæœ‰äº›å¤´ç–¼ã€‚

### ç¬¬äºŒæ¬¡å°è¯•ï¼šæ—¶é—´æ ¼å¼çš„å™©æ¢¦

æ¥ç€ï¼Œæˆ‘ä»¬é‡åˆ°äº†æ—¶é—´æ ¼å¼çš„é—®é¢˜ã€‚ç”¨æˆ·æŠ±æ€¨ Web ç•Œé¢æ˜¾ç¤ºçš„æ˜¯ AM/PM æ ¼å¼ï¼š

"æˆ‘è¦24å°æ—¶æ—¶é—´åˆ¶æŸ¥è¯¢ï¼Œæ€ä¹ˆå‰ç«¯è¿˜æœ‰AMå’ŒPMï¼Œæˆ‘ä¸è¦AMå’ŒPMï¼Œæ°”æ­»äº†ï¼"

007 ç«‹åˆ»è¿›è¡Œäº†ä¿®å¤ï¼Œå°† `datetime-local` è¾“å…¥æ¡†æ›¿æ¢ä¸ºåˆ†ç¦»çš„æ—¶é—´è¾“å…¥ï¼š

```html
<!-- 24å°æ—¶åˆ¶æ—¶é—´è¾“å…¥ -->
<div class="col-md-3">
    <label for="start_time" class="form-label">å¼€å§‹æ—¶é—´ (24å°æ—¶åˆ¶)</label>
    <div class="row g-1">
        <div class="col-6">
            <input type="date" class="form-control" id="start_date" required>
        </div>
        <div class="col-3">
            <input type="number" class="form-control" id="start_hour" min="0" max="23" placeholder="æ—¶" required>
        </div>
        <div class="col-3">
            <input type="number" class="form-control" id="start_minute" min="0" max="59" placeholder="åˆ†" required>
        </div>
    </div>
</div>
```

### ç¬¬ä¸‰æ¬¡å°è¯•ï¼šJSONåºåˆ—åŒ–çš„é™·é˜±

ç„¶åï¼Œæˆ‘ä»¬é‡åˆ°äº† JSON åºåˆ—åŒ–é”™è¯¯ï¼š

```
æŸ¥è¯¢å¤±è´¥: è¯·æ±‚å¤„ç†é”™è¯¯: Object of type datetime is not JSON serializable
```

"è¿™ä¸ªé”™è¯¯å¾ˆå¸¸è§ï¼Œdatetime å¯¹è±¡æ— æ³•ç›´æ¥åºåˆ—åŒ–ã€‚"007 è§£é‡Šé“ã€‚

æˆ‘ä»¬å°è¯•äº†å¤šç§è§£å†³æ–¹æ¡ˆï¼Œæœ€ç»ˆé‡‡ç”¨äº†æ‰‹åŠ¨åºåˆ—åŒ–ï¼š

```python
# æ‰‹åŠ¨åºåˆ—åŒ–ï¼Œç¡®ä¿datetimeæ­£ç¡®è½¬æ¢
data_list = []
for bar in result.data:
    data_list.append({
        "symbol": bar.symbol,
        "frame": bar.frame.isoformat(),  # æ‰‹åŠ¨è½¬æ¢datetimeä¸ºå­—ç¬¦ä¸²
        "open": float(bar.open),
        "high": float(bar.high),
        "low": float(bar.low),
        "close": float(bar.close),
        "vol": float(bar.vol),
        "amount": float(bar.amount)
    })
```

### æœ€ç»ˆé‡æ„ï¼šç®€æ´è€Œå¼ºå¤§

"007ï¼æˆ‘è§‰å¾—ä½ æŠŠClientçš„æŸ¥è¯¢ä»£ç æ”¹çš„ä¹±ä¸ƒå…«ç³Ÿçš„ï¼Œä½ åº”è¯¥å…¨éƒ¨æ¨ç¿»ï¼ŒæŒ‰ç…§Windowså’ŒMacçš„é€»è¾‘é‡æ–°å†™æŸ¥è¯¢ã€‚"æˆ‘ç»ˆäºå¿ä¸ä½äº†ã€‚

007 ç«‹åˆ»è¿›è¡Œäº†å½»åº•é‡æ„ï¼ŒæŒ‰ç…§ç³»ç»Ÿæ¶æ„çš„åŸå§‹è®¾è®¡é‡æ–°ç¼–å†™ï¼š

```python
def query_bar_data(self, symbol: str, start_time: datetime, end_time: datetime, period: int) -> QueryResponse:
    """
    æŸ¥è¯¢åˆ†é’Ÿçº¿æ•°æ®

    æŒ‰ç…§ç³»ç»Ÿæ¶æ„ï¼š
    1. å¦‚æœæŸ¥è¯¢çš„åˆ†é’Ÿçº¿æ•°æ®æ˜¯å½“æ—¥çš„ï¼Œåˆ™ç›´æ¥ä»Redisä¸­è¯»å–åˆæˆçš„åˆ†é’Ÿçº¿æ•°æ®
    2. å¦‚æœæŸ¥è¯¢çš„åˆ†é’Ÿçº¿æ•°æ®æ˜¯å†å²çš„ï¼Œåˆ™ç›´æ¥ä»ClickHouseä¸­è¯»å–
    3. å¦‚æœæŸ¥è¯¢çš„åˆ†é’Ÿçº¿æ•°æ®æ˜¯æ—¢æœ‰å½“æ—¥çš„åˆæœ‰å†å²çš„ï¼Œåˆ™åˆå¹¶æ•°æ®è¿”å›ç»™Client
    """
    try:
        today = date.today()
        start_date = start_time.date()
        end_date = end_time.date()

        redis_data = []
        clickhouse_data = []

        # 1. æŸ¥è¯¢å½“æ—¥æ•°æ®ï¼ˆä»Redisè¯»å–ï¼‰
        if end_date >= today:
            redis_data = self.redis_manager.get_current_bar_data(period, symbol)
            # è¿‡æ»¤æ—¶é—´èŒƒå›´
            redis_data = [bar for bar in redis_data if start_time <= bar.frame <= end_time]

        # 2. æŸ¥è¯¢å†å²æ•°æ®ï¼ˆä»ClickHouseè¯»å–ï¼‰
        if start_date < today:
            # é¿å…ä¸å½“æ—¥æ•°æ®é‡å¤ï¼Œå†å²æ•°æ®æŸ¥è¯¢åˆ°ä»Šå¤©ä¹‹å‰
            hist_end_time = min(end_time, datetime.combine(today, datetime.min.time()))
            if start_time < hist_end_time:
                clickhouse_data = self.clickhouse_manager.query_bar_data(
                    symbol, start_time, hist_end_time, period
                )

        # 3. åˆå¹¶æ•°æ®
        merged_data = self.data_merger.merge_bar_data(redis_data, clickhouse_data)

        return QueryResponse(
            success=True,
            message=f"å½“æ—¥æ•°æ®: {len(redis_data)} æ¡ï¼Œå†å²æ•°æ®: {len(clickhouse_data)} æ¡ï¼Œåˆå¹¶å: {len(merged_data)} æ¡",
            data=merged_data,
            total_count=len(merged_data)
        )

    except Exception as e:
        return QueryResponse(
            success=False,
            message=f"æŸ¥è¯¢å¤±è´¥: {str(e)}",
            data=[],
            total_count=0
        )
```

### Client ç«¯çš„æŸ¥è¯¢é¡µé¢

ä¸ºäº†æ˜“äºæŸ¥è¯¢ï¼Œä¸”å¯è§†åŒ–æŸ¥è¯¢ç»“æœï¼Œæˆ‘è®© 007 ç»™ Client ç«¯è®¾è®¡äº†ä¸€ä¸ªæŸ¥è¯¢é¡µé¢ï¼š

![](https://fastly.jsdelivr.net/gh/bucketio/img10@main/2025/06/12/1749715483781-6db01c3d-cbd2-4527-8ea7-f5c081810f1c.png)

## âš ï¸ è¯·æ³¨æ„ï¼šæ•°æ®åˆå¹¶å’Œäº¤æ˜“æ—¶é—´éªŒè¯

###  æ•°æ®åˆå¹¶ï¼šç¡®ä¿æŸ¥è¯¢ç»“æœçš„å‡†ç¡®æ€§

å¦‚æœç”¨æˆ·éœ€è¦æŸ¥è¯¢çš„æ—¥æœŸæ—¢æœ‰å†å²åˆ†é’Ÿçº¿æ•°æ®åˆæœ‰å½“æ—¥åˆ†é’Ÿçº¿æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦å¯¹ Redis å’Œ  Clickhouse çš„æ•°æ®è¿›è¡Œåˆå¹¶ã€‚

```python
class DataMerger:
    """æ•°æ®åˆå¹¶å™¨ - åˆå¹¶Rediså½“æ—¥æ•°æ®å’ŒClickHouseå†å²æ•°æ®"""

    @staticmethod
    def merge_bar_data(redis_data: List[BarData], clickhouse_data: List[BarData]) -> List[BarData]:
        """åˆå¹¶åˆ†é’Ÿçº¿æ•°æ®"""
        # åˆå¹¶æ•°æ®å¹¶æŒ‰æ—¶é—´æ’åº
        all_data = redis_data + clickhouse_data

        # å»é‡ï¼ˆä»¥frameå’Œsymbolä¸ºé”®ï¼‰
        unique_data = {}
        for bar in all_data:
            key = (bar.symbol, bar.frame)
            unique_data[key] = bar

        # æŒ‰æ—¶é—´æ’åº
        merged_data = list(unique_data.values())
        merged_data.sort(key=lambda x: x.frame)

        return merged_data
```


### äº¤æ˜“æ—¶é—´éªŒè¯ï¼šç¡®ä¿æ•°æ®è´¨é‡

"æ‰€æœ‰çš„åˆ†é’Ÿçº¿æ•°æ®éƒ½å¿…é¡»æ˜¯äº¤æ˜“æ—¶é—´å†…çš„æ•°æ®ï¼Œä¸ç„¶æ²¡æœ‰æ„ä¹‰ã€‚"æˆ‘å¯¹ 007 å¼ºè°ƒäº†æ•°æ®è´¨é‡çš„é‡è¦æ€§ã€‚

007 è®¾è®¡äº†ä¸€ä¸ªä¸“é—¨çš„äº¤æ˜“æ—¶é—´éªŒè¯å™¨ï¼š

```python
class TradingTimeValidator:
    """äº¤æ˜“æ—¶é—´éªŒè¯å™¨"""

    def __init__(self):
        self.trading_hours = {
            'morning_start': '09:30:00',
            'morning_end': '11:30:00',
            'afternoon_start': '13:00:00',
            'afternoon_end': '15:00:00'
        }

    def is_trading_time(self, dt: datetime) -> bool:
        """æ£€æŸ¥æ˜¯å¦ä¸ºäº¤æ˜“æ—¶é—´"""
        time_obj = dt.time()

        morning_start = dt_time.fromisoformat(self.trading_hours['morning_start'])
        morning_end = dt_time.fromisoformat(self.trading_hours['morning_end'])
        afternoon_start = dt_time.fromisoformat(self.trading_hours['afternoon_start'])
        afternoon_end = dt_time.fromisoformat(self.trading_hours['afternoon_end'])

        return (
            (morning_start <= time_obj <= morning_end) or
            (afternoon_start <= time_obj <= afternoon_end)
        )

    def validate_tick_data(self, tick_dict: dict) -> bool:
        """éªŒè¯åˆ†ç¬”æ•°æ®"""
        return self.is_trading_time(tick_dict['time'])

    def validate_bar_data(self, bar_dict: dict) -> bool:
        """éªŒè¯åˆ†é’Ÿçº¿æ•°æ®"""
        return self.is_trading_time(bar_dict['frame'])
```

## ğŸ¯ ç³»ç»Ÿæµ‹è¯•

"ç³»ç»Ÿæ­å»ºå®Œæˆï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹æ•ˆæœã€‚"æˆ‘æ»¡æ€€æœŸå¾…åœ°è¯´é“ã€‚

### å†å²åˆ†é’Ÿçº¿æ•°æ®çš„è·å–

Windows ç«¯è¿è¡Œæ•ˆæœï¼š

![](https://fastly.jsdelivr.net/gh/bucketio/img9@main/2025/06/12/1749715933648-bb8342e7-4ea5-4561-b9e5-f876898354be.png)

Mac ç«¯è¿è¡Œæ•ˆæœï¼š

![](https://fastly.jsdelivr.net/gh/bucketio/img0@main/2025/06/12/1749716036473-615cc55f-d15b-4ee0-99fb-de521449b403.png)

å¯ä»¥æ³¨æ„åˆ° Mac ç«¯çš„ Redis é˜Ÿåˆ—ä¸­çš„å…ƒç´ æ­£åœ¨å‡å°‘ï¼ŒClickhouseHouse å­˜å‚¨çš„æ•°æ®æ­£åœ¨å¢åŠ ã€‚

æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹Clickhouseï¼š

![](https://fastly.jsdelivr.net/gh/bucketio/img4@main/2025/06/12/1749716123001-c4e597cf-8750-4626-8aa5-b5f946ee978c.png)

å¯ä»¥å‘ç°å†å²æ•°æ®å·²ç»å­˜å…¥Clickhouseä¸­ï¼ˆè€Œä¸”éƒ½æ˜¯ç¬¦åˆåœ¨äº¤æ˜“æ—¶é—´å†…è¿™ä¸€è¦æ±‚ï¼‰ã€‚

### å½“æ—¥åˆ†é’Ÿçº¿æ•°æ®çš„è·å–

åœ¨äº¤æ˜“æ—¶é—´å¯åŠ¨ Windows å’Œ Mac ç«¯ï¼Œå¯ä»¥çœ‹åˆ° Redis ä¸­ä¿å­˜ç€åˆ†ç¬”æ•°æ®å’Œåˆæˆçš„å½“æ—¥åˆ†é’Ÿçº¿æ•°æ®ã€‚ï¼ˆè¿™äº›æ•°æ®åˆ°å‡Œæ™¨2ç‚¹ä¼šç»Ÿä¸€æ¸…é™¤ï¼‰

Redisï¼š

![](https://fastly.jsdelivr.net/gh/bucketio/img16@main/2025/06/12/1749716373402-40f71928-e695-4ae8-9243-cd2a9b7c860b.png)

æˆ‘ä»¬å¯ä»¥é€šè¿‡ Client å»æŸ¥è¯¢å½“æ—¥çš„åˆ†é’Ÿçº¿æ•°æ®ï¼ˆä»¥ 15min ä¸ºä¾‹ï¼‰ï¼š

![](https://fastly.jsdelivr.net/gh/bucketio/img10@main/2025/06/12/1749716531014-1653aad3-3745-4d4e-86e0-0aaa36ba57b0.png)

![](https://fastly.jsdelivr.net/gh/bucketio/img18@main/2025/06/12/1749716589899-f0cab646-9b99-4ab5-9f25-6df60c6ad3de.png)

## ğŸ“ æ€»ç»“

é€šè¿‡è¿™æ¬¡ç³»ç»Ÿé€»è¾‘ä¼˜åŒ–ä¸åˆ†é’Ÿçº¿æ•°æ®åˆæˆçš„å¼€å‘ï¼Œæˆ‘å’Œ 007 æˆåŠŸæ„å»ºäº†ä¸€ä¸ªæ™ºèƒ½ã€é«˜æ•ˆã€ç¨³å®šçš„é‡åŒ–äº¤æ˜“æ•°æ®å¤„ç†ç³»ç»Ÿã€‚ä»æœ€åˆçš„å¤æ‚è®¾è®¡åˆ°æœ€ç»ˆçš„ç®€æ´å®ç°ï¼Œæˆ‘ä»¬ä¸ä»…è§£å†³äº†æŠ€æœ¯éš¾é¢˜ï¼Œæ›´é‡è¦çš„æ˜¯å»ºç«‹äº†ä¸€å¥—å¯æ‰©å±•ã€å¯ç»´æŠ¤çš„ç³»ç»Ÿæ¶æ„ã€‚

21 å¤©çš„æŒ‘æˆ˜å·²ç»è¿‡å»äº† 9 å¤©ï¼Œæˆ‘ä»¬çš„é‡åŒ–äº¤æ˜“ç³»ç»Ÿæ­£åœ¨å˜å¾—è¶Šæ¥è¶Šå¼ºå¤§ã€‚ä»æœ€åˆçš„ç®€å•æ•°æ®è·å–ï¼Œåˆ°ç°åœ¨çš„æ™ºèƒ½æ•°æ®åˆæˆï¼Œæ¯ä¸€æ­¥éƒ½å……æ»¡äº†æŒ‘æˆ˜å’Œæ”¶è·ã€‚

007 çš„è¡¨ç°å†æ¬¡è®©æˆ‘åˆ®ç›®ç›¸çœ‹ï¼Œä»æ¶æ„è®¾è®¡åˆ°ä»£ç å®ç°ï¼Œä»é—®é¢˜è¯Šæ–­åˆ°ç³»ç»Ÿä¼˜åŒ–ï¼Œå®ƒéƒ½å±•ç°å‡ºäº†ä¸“ä¸šçš„æŠ€æœ¯èƒ½åŠ›ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå®ƒèƒ½å¤Ÿåœ¨æˆ‘çš„æŒ‡å¯¼ä¸‹å¿«é€Ÿè°ƒæ•´æ–¹å‘ï¼Œæœ€ç»ˆå®ç°äº†ä¸€ä¸ªç®€æ´è€Œå¼ºå¤§çš„ç³»ç»Ÿã€‚

ç‰¹åˆ«æ˜¯åœ¨ Client ç«¯çš„é‡æ„è¿‡ç¨‹ä¸­ï¼Œ007 å±•ç°äº†å¾ˆå¼ºçš„å­¦ä¹ èƒ½åŠ›ã€‚å½“æˆ‘æŒ‡å‡ºä»£ç è¿‡äºå¤æ‚æ—¶ï¼Œå®ƒèƒ½å¤Ÿç«‹åˆ»ç†è§£é—®é¢˜æ‰€åœ¨ï¼Œå¹¶æŒ‰ç…§ç³»ç»Ÿæ¶æ„çš„åŸå§‹è®¾è®¡è¿›è¡Œå½»åº•é‡æ„ã€‚è¿™ç§å¿«é€Ÿå“åº”å’Œè‡ªæˆ‘çº æ­£çš„èƒ½åŠ›ï¼Œæ­£æ˜¯ä¸€ä¸ªä¼˜ç§€çš„ AI åŠ©æ‰‹åº”è¯¥å…·å¤‡çš„å“è´¨ã€‚

ä½†æ˜¯ï¼Œæˆ‘ä»¬çš„åˆ†é’ŸåˆæˆçœŸçš„åˆç†å—ï¼Ÿæˆ‘ä»¬åœ¨ä¸‹ä¸€ç« èŠ‚ï¼Œå°†é‡‡ç”¨ Tushare å’Œ Akshare å¯¹æˆ‘ä»¬åˆæˆçš„å½“æ—¥å®æ—¶åˆ†é’Ÿçº¿çš„å‡†ç¡®æ€§è¿›è¡ŒéªŒè¯ã€‚å¯¹äºå¤šClienté—®é¢˜ï¼Œæˆ‘ä»¬ä¹Ÿå°†é‡‡ç”¨å¤šä¸ªClientæœºå™¨å¯¹ç³»ç»Ÿè¿›è¡Œæµ‹è¯•ã€‚æ•¬è¯·æœŸå¾…ï¼

![](https://fastly.jsdelivr.net/gh/bucketio/img18@main/2025/06/12/1749716838032-b7b7400b-c7ac-4aaa-a022-6202f518a895.jpg)
