---
title: "[1013] QuanTide Weekly"
date: 2024-10-13
category: others
slug: quantide-weekly-1013
img: https://images.jieyu.ai/images/university/toronto.webp
stamp_width: 60%
stamp_height: 60%
tags: [others, weekly, numpy, pandas]
seq: ç¬¬ 12 æœŸ
fonts:
    sans: 'ZhuqueFangsong, sans-serif'
---

### æœ¬å‘¨è¦é—»
* 10æœˆ25æ—¥èµ·ï¼Œå­˜é‡æˆ¿è´·ç»Ÿä¸€ä¸‹è°ƒï¼
* Robotaxi Dayè‰è‰æ”¶åœºï¼Œç‰¹æ–¯æ‹‰æš´è·Œ
* ä¸€æ½å­å¢é‡è´¢æ”¿ç­–ç•¥è¶…é¢„æœŸï¼Œè§„æ¨¡æˆ–åœ¨5ä¸‡äº¿ä»¥ä¸Š
* åŒ–å€ºæ¦‚å¿µå‡ºç‚‰ï¼


### ä¸‹å‘¨çœ‹ç‚¹
* å‘¨æ—¥ï¼š9æœˆPPIå’ŒCPIæŒ‡æ•°å…¬å¸ƒ
* å‘¨ä¸€ï¼ˆ10æœˆ14æ—¥ï¼‰å›½æ–°åŠå°±å‰ä¸‰å­£åº¦è¿›å‡ºå£æ•°æ®ä¸¾åŠæ–°é—»å‘å¸ƒä¼š

### æœ¬å‘¨ç²¾é€‰

* è¿è½½ï¼é‡åŒ–äººå¿…ä¼šçš„ Numpy ç¼–ç¨‹(6)

---

* å·¥å•†é“¶è¡Œå‘å¸ƒå­˜é‡æˆ¿è´·åˆ©ç‡è°ƒæ•´å¸¸è§é—®ç­”ï¼Œé€éœ²å­˜é‡ä½æˆ¿è´·æ¬¾éƒ½å¯ä»¥è°ƒæ•´ä¸ºä¸ä½äºLPR-30BPï¼ˆé™¤äº¬æ²ªæ·±äºŒå¥—å¤–ï¼‰ï¼Œå¹¶åœ¨10æœˆ25æ—¥ç»Ÿä¸€æ‰¹é‡è°ƒæ•´ã€‚ä»¥100ä¸‡ã€25å¹´æœŸã€ç­‰é¢æœ¬æ¯è®¡ï¼Œè°ƒæ•´åæ¯æœˆå¯çœæ”¯å‡º469å…ƒï¼Œå…±èŠ‚çœåˆ©æ¯14.06ä¸‡å…ƒã€‚
* We Robotå‘å¸ƒä¼šå¬å¼€ï¼Œæ­¤å‰é©¬æ–¯å…‹ç§°å…¶ä¸ºè½½å…¥å²å†Œï¼Œä½†ç­‰åˆ°å¤§å¹•æ‹‰å¼€ï¼Œå´åªæœ‰çŸ­çŸ­20å¤šåˆ†é’Ÿçš„ä¸»é¢˜ä»‹ç»ï¼Œé‡è¦æŠ€æœ¯æŒ‡æ ‡å’Œå‚æ•°å‡æœªå…¬å¸ƒã€‚éšåç‰¹æ–¯æ‹‰å¤§è·Œ8.78%ï¼Œå…¶å¯¹æ‰‹è±ç¦ç‰¹(Lyft)åˆ™å¤§æ¶¨9.59%ã€‚
* è´¢æ”¿éƒ¨å‘¨å…­å¬å¼€å‘å¸ƒä¼šï¼Œä¸€æ½å­å¢é‡è´¢æ”¿æ”¿ç­–è½åœ°ï¼Œæœ‰åˆ†æå¸ˆè®¤ä¸ºï¼Œä¿å®ˆä¼°è®¡ï¼Œæœ¬æ¬¡ä¸€æ½å­å¢é‡è´¢æ”¿æ”¿ç­–è§„æ¨¡æˆ–åœ¨5ä¸‡äº¿å…ƒä»¥ä¸Šï¼Œé‡ç‚¹æ˜¯åŒ–å€ºå’ŒåŸºå±‚ä¸‰ä¿ã€‚
* ç´§éšè´¢æ”¿éƒ¨å‘å¸ƒï¼ŒåŒ–å€ºæ¦‚å¿µå—åˆ°å¸‚åœºçƒ­è®®ã€‚è¯åˆ¸æ—¶æŠ¥.æ•°æ®å®æ¢³ç†ï¼ŒAMCã€åŸæŠ•å¹³å°ã€PPPæ¦‚å¿µå’ŒREITsæ¦‚å¿µå…±çº¦37å®¶å…¬å¸å¯èƒ½å—ç›Šã€‚åœ¨å‘¨äº”å¤§è·Œä¸­ï¼Œè¿™äº›å…¬å¸å¤šæ•°é€†å¸‚å¤§æ¶¨æˆ–è€…è·‘èµ¢å¤§ç›˜ã€‚

<claimer>æ¶ˆæ¯æ¥æºï¼šä¸œæ–¹è´¢å¯Œ</claimer>

---

# Numpyé‡åŒ–åº”ç”¨æ¡ˆä¾‹[3]
## å‘é‡åŒ–åˆä¸€ä¾‹: å¤šèµ„äº§ä¸­ä½æ•°å»æå€¼

å»æå€¼æ˜¯é‡åŒ–åˆ†æé¢„å¤„ç†ä¸­çš„å¸¸è§æ­¥éª¤ï¼Œåœ¨æœºå™¨å­¦ä¹ ä¸­ä¹Ÿå¾ˆå¸¸è§ã€‚åœ¨å„ç§å»æå€¼æ–¹æ³•ä¸­ï¼Œä¸­ä½æ•°æ‹‰å›æ˜¯å¯¹æ•°æ®åˆ†å¸ƒç‰¹æ€§é€‚åº”æ€§æœ€å¹¿ã€æœ€é²æ£’çš„ä¸€ç§ã€‚

æˆ‘ä»¬å…ˆä»‹ç»ç»å¯¹ä¸­ä½å·®ï¼ˆmedian absolute deviationï¼‰çš„æ¦‚å¿µï¼š

$$MAD = median(|X_i - median(X)|)$$

ä¸ºäº†èƒ½å°† MAD å½“æˆä¸æ ‡å‡†å·®$\sigma$ç›¸ä¸€è‡´çš„ä¼°è®¡é‡ï¼Œå³
$$\hat{\sigma} = k. MAD$$

è¿™é‡Œ k ä¸ºæ¯”ä¾‹å› å­å¸¸é‡ï¼Œå¦‚æœåˆ†å¸ƒæ˜¯æ­£æ€åˆ†å¸ƒï¼Œå¯ä»¥è®¡ç®—å‡ºï¼š
$$
k = \frac{1}{(\Phi^{-1}(\frac{3}{4}))} \approx 1.4826
$$

---

åŸºäºè¿™ä¸ª k å€¼ï¼Œå– 3 å€åˆ™è¿‘ä¼¼äº 5ã€‚


ä»£ç å®ç°å¦‚ä¸‹ï¼š


```python
from numpy.typing import ArrayLike

def mad_clip(arr: ArrayLike, k: int = 3):
    med = np.median(arr)
    mad = np.median(np.abs(arr - med))
    
    return np.clip(arr, med - k * mad, med + k * mad)

np.random.seed(78)
arr = np.append(np.random.randint(1, 4, 20), [15, -10])
mad_clip(arr, 3)
```

è¿™æ®µä»£ç åªèƒ½å¯¹å•ä¸€èµ„äº§è¿›è¡Œmad_clipã€‚å¦‚æœè¦åŒæ—¶å¯¹Aè‚¡æ‰€æœ‰èµ„äº§çš„æŸç§æŒ‡æ ‡å»æå€¼ï¼Œä¸Šè¿°æ–¹æ³•éœ€è¦å¾ªç¯5000å¤šæ¬¡ï¼Œæ˜¾ç„¶é€Ÿåº¦è¾ƒæ…¢ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•ï¼š

```python
def mad_clip(df: Union[NDArray, pd.DataFrame], k: int = 3, axis=1):
    """ä½¿ç”¨ MAD 3 å€æˆªæ–­æ³•å»æå€¼"""
    
    med = np.median(df, axis=axis).reshape(df.shape[0], -1)
    mad = np.median(np.abs(df - med), axis=axis)

    magic = 1.4826
    offset = k * magic * mad
    med = med.flatten()
    return np.clip(df.T, med - offset, med + offset).T
```

---

è¿™ä¸€ç‰ˆçš„ mad_clip å¯ä»¥æ¥å— numpy ndarray å’Œ pandas dataframe ä½œä¸ºå‚æ•°ã€‚è¾“å…¥çš„æ•°æ®æ ¼å¼æ˜¯ä»€ä¹ˆï¼Œå®ƒè¿”å›çš„æ•°æ®æ ¼å¼å°±æ˜¯ä»€ä¹ˆã€‚

æˆ‘ä»¬åœ¨np.medianè°ƒç”¨ä¸­ï¼Œä¼ å…¥äº† axiså‚æ•°ã€‚å¦‚æœaxis=0, è¡¨æ˜æŒ‰åˆ—çš„æ–¹å‘éå†ï¼Œå› æ­¤æ˜¯æŒ‰è¡Œå–ä¸­ä½æ•°ï¼›axis=1,è¡¨æ˜æŒ‰è¡Œçš„æ–¹å‘éå†ï¼Œå› æ­¤æ˜¯æŒ‰åˆ—å–ä¸­ä½æ•°ã€‚

æˆ‘ä»¬ä½¿ç”¨çœŸå®æ•°æ®æµ‹è¯•ä¸€ä¸‹ï¼š

```python
# åŠ è½½æµ‹è¯•æ•°æ®
start = datetime.date(2023, 1, 1)
end = datetime.date(2023, 12, 29)
barss = load_bars(start, end, 7)

closes = barss["close"].unstack("asset").iloc[-5:]
closes
```

è¾“å‡ºæ•°æ®ä¸ºï¼š

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>asset/date</th>
      <th>002095.XSHE</th>
      <th>003042.XSHE</th>
      <th>300099.XSHE</th>
      <th>301060.XSHE</th>
      <th>601689.XSHG</th>
      <th>603255.XSHG</th>
      <th>688669.XSHG</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-12-25</th>
      <td>23.400000</td>
      <td>18.090000</td>
      <td>6.10</td>
      <td>13.00</td>
      <td>73.910004</td>
      <td>36.799999</td>
      <td>18.080000</td>
    </tr>
    <tr>
      <th>2023-12-26</th>
      <td>21.059999</td>
      <td>17.520000</td>
      <td>5.94</td>
      <td>12.83</td>
      <td>72.879997</td>
      <td>37.000000</td>
      <td>18.080000</td>
    </tr>
    <tr>
      <th>2023-12-27</th>
      <td>20.070000</td>
      <td>17.590000</td>
      <td>6.04</td>
      <td>12.84</td>
      <td>72.000000</td>
      <td>36.840000</td>
      <td>18.049999</td>
    </tr>
    <tr>
      <th>2023-12-28</th>
      <td>20.010000</td>
      <td>18.139999</td>
      <td>6.11</td>
      <td>13.14</td>
      <td>72.199997</td>
      <td>38.150002</td>
      <td>18.440001</td>
    </tr>
    <tr>
      <th>2023-12-29</th>
      <td>20.270000</td>
      <td>18.580000</td>
      <td>6.19</td>
      <td>13.29</td>
      <td>73.500000</td>
      <td>37.299999</td>
      <td>18.740000</td>
    </tr>
  </tbody>
</table>
</div>

---

ä¸ºäº†æµ‹è¯•æ•ˆæœï¼Œæˆ‘ä»¬å°†kè®¾ç½®ä¸ºè¾ƒå°çš„å€¼ï¼Œä»¥è§‚å¯Ÿå…¶æ•ˆæœï¼š

```python
mad_clip(closes,k=1)
```

<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>asset/date</th>
      <th>002095.XSHE</th>
      <th>003042.XSHE</th>
      <th>300099.XSHE</th>
      <th>301060.XSHE</th>
      <th>601689.XSHG</th>
      <th>603255.XSHG</th>
      <th>688669.XSHG</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-12-25</th>
      <td>23.400000</td>
      <td>18.090000</td>
      <td>10.217396</td>
      <td>13.00</td>
      <td>25.962605</td>
      <td>25.962605</td>
      <td>18.080000</td>
    </tr>
    <tr>
      <th>2023-12-26</th>
      <td>21.059999</td>
      <td>17.520000</td>
      <td>10.296350</td>
      <td>12.83</td>
      <td>25.863649</td>
      <td>25.863649</td>
      <td>18.080000</td>
    </tr>
    <tr>
      <th>2023-12-27</th>
      <td>20.070000</td>
      <td>17.590000</td>
      <td>10.325655</td>
      <td>12.84</td>
      <td>25.774343</td>
      <td>25.774343</td>
      <td>18.049999</td>
    </tr>
    <tr>
      <th>2023-12-28</th>
      <td>20.010000</td>
      <td>18.139999</td>
      <td>10.582220</td>
      <td>13.14</td>
      <td>26.297781</td>
      <td>26.297781</td>
      <td>18.440001</td>
    </tr>
    <tr>
      <th>2023-12-29</th>
      <td>20.270000</td>
      <td>18.580000</td>
      <td>10.659830</td>
      <td>13.29</td>
      <td>26.820169</td>
      <td>26.820169</td>
      <td>18.740000</td>
    </tr>
  </tbody>
</table>
</div>

æˆ‘ä»¬çœ‹åˆ°ï¼ŒåŸå§‹æ•°æ®ä¸­çš„73.9è¢«æ‹‰å›åˆ°25.9ï¼Œ6.1è¢«æ‹‰å›åˆ°10.2(ä»¥ç¬¬ä¸€è¡Œä¸ºä¾‹)ï¼Œå¹¶ä¸”éƒ½æ˜¯ä»¥è¡Œä¸ºå•ä½è®¡ç®—çš„ã€‚


## min_range: å¤šå°‘å‘¨æœŸä»¥æ¥çš„æœ€å°å€¼ï¼Ÿ

è¿™æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„éœ€æ±‚ï¼Œæ¯”å¦‚ï¼Œæœ‰è‚¡è°šè¯­äº‘ï¼Œå¤©é‡è§å¤©ä»·ï¼Œåœ°é‡è§åœ°ä»·ã€‚å½“è¡Œæƒ…å¤„åœ¨é«˜ä½ï¼Œæˆäº¤é‡åˆ›å‡ºä¸€æ®µæ—¶é—´ä»¥æ¥çš„å¤©é‡ä¹‹åï¼Œåç»­æˆäº¤é‡å°†éš¾ä»¥ä¸ºç»§ï¼Œå®¹æ˜“å¼•èµ·ä¸‹è·Œï¼›å½“è¡Œæƒ…å¤„åœ¨ä½ä½ï¼Œæˆäº¤é‡åˆ›å‡ºä¸€æ®µæ—¶é—´ä»¥æ¥çš„åœ°é‡ä¹‹åï¼Œè¡¨æ˜å¸‚åœºäººæ°”æåº¦ä½è¿·ï¼Œæ­¤æ—¶ä»·æ ¼å®¹æ˜“è¢«æ“çºµï¼Œä»è€Œå¼•æ¥æŠ•æœºç›˜ã€‚

---

åœ¨é€šè¾¾ä¿¡å…¬å¼ä¸­æœ‰æ­¤å‡½æ•°ï¼Œåœ¨éº¦è¯­è¨€ä¸­ï¼Œå¯¹åº”çš„æ–¹æ³•å¯èƒ½æ˜¯LOWRANGEã€‚ä»¥ä¸‹æ˜¯myTTä¸­LowRangeå‡½æ•°çš„å®ç°ï¼š

```python
def LOWRANGE(S):                       
    # LOWRANGE(LOW)è¡¨ç¤ºå½“å‰æœ€ä½ä»·æ˜¯è¿‘å¤šå°‘å‘¨æœŸå†…æœ€ä½ä»·çš„æœ€å°å€¼ by jqz1226
    rt = np.zeros(len(S))
    for i in range(1,len(S)):  rt[i] = np.argmin(np.flipud(S[:i]>S[i]))
    return rt.astype('int')
```

è¿™æ˜¯ä¸€ä¸ªçœ‹ä¼¼ç®€å•ï¼Œä½†å®é™…ä¸Šæ¯”è¾ƒéš¾å®ç°çš„åŠŸèƒ½ã€‚å¦‚æœæˆ‘ä»¬å¯¹ä¸Šè¿°å‡½æ•°è¿›è¡Œæµ‹è¯•ï¼Œä¼šå‘ç°å®ƒä¸ä¸€å®šå®ç°äº†éœ€æ±‚ï¼ˆä¹Ÿå¯èƒ½æ˜¯æœ¬æ–‡ä½œè€…å¯¹æ­¤å‡½æ•°ç†è§£æœ‰è¯¯ï¼‰ã€‚

```python
s = [ 1, 2, 2, 1, 3, 0]

LOWRANGE(np.array(s))
```

åœ¨ä¸Šè¿°æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›å¾—åˆ°çš„è¾“å‡ºæ˜¯[1, 1, 1, 3, 1, 6]ï¼Œä½†LOWRANGå°†ç»™å‡ºä»¥ä¸‹è¾“å‡ºï¼š

```
array([0, 0, 0, 2, 0, 0])
```

ä¸‹é¢ï¼Œæˆ‘ä»¬ç»™å‡ºè¯¥å‡½æ•°çš„å‘é‡åŒ–å®ç°ã€‚

!!! warning
    è¯¥å‡½æ•°åœ¨å¼€å¤´çš„å‡ ä¸ªè¾“å‡ºä¸­ï¼Œå­˜åœ¨å‡ºé”™å¯èƒ½ã€‚å› ä¸å½±å“å› å­åˆ†æï¼Œæš‚æœªä¿®å¤ã€‚

---

```python
def min_range(s):
    """è®¡ç®—åºåˆ—sä¸­ï¼Œå…ƒç´ iæ˜¯æ­¤å‰å¤šå°‘ä¸ªå‘¨æœŸä»¥æ¥çš„æœ€å°å€¼

    æ­¤æ–¹æ³•åœ¨ä¸ªåˆ«æ•°å­—ä¸Šæœ‰bug

    Example:
        >>> s = np.array([5, 7, 7, 6, 5, 8, 2])
        >>> min_range(s)
        array([1, 2, 1, 2, 3, 1, 6])
    """
    n = len(s)

    # handle nan
    filled = np.where(np.isnan(s), -np.inf, s)
    diff = filled[:,None] - filled
    mask = np.triu(np.ones((n, n), dtype=bool), k=1)
    masked = np.ma.array(diff, mask=mask)

    rng = np.arange(n)
    ret = rng - np.argmax(np.ma.where(masked > 0, rng, -1), axis=1)
    ret[0] = 1
    if filled[1] <= filled[0]:
        ret[1] = 2
    return ret

s = np.array([5, 7, 7, 6, 5, 8, 2])
min_range(s)
```

æœ€ç»ˆè¾“å‡ºçš„ç»“æœæ˜¯ï¼š

```
array([1, 1, 2, 3, 4, 1, 6])
```

åœ¨ç¬¬2ä¸ª7çš„ä½ç½®ï¼Œè¾“å‡ºä¸æœŸæœ›ä¸ä¸€è‡´ï¼Œä½†æ­¤åè®¡ç®—éƒ½æ­£ç¡®ã€‚è¿™ä¸ªå®ç°éå¸¸æœ‰æŠ€å·§ï¼Œè¿ç”¨äº†ä¸‰è§’çŸ©é˜µåšmask arrayï¼Œä»è€Œæ¶ˆè§£äº†å¾ªç¯ã€‚

---


## å‡çº¿è®¡ç®—ï¼šSMAå’Œåˆ†æ—¶å‡çº¿

ä½¿ç”¨numpyè®¡ç®—ç§»åŠ¨å‡çº¿éå¸¸ç®€å•ï¼Œä½¿ç”¨np.convolve()å³å¯ã€‚

```python
def moving_average(ts: ArrayLike, win: int, padding=True)->np.ndarray:
    kernel = np.ones(win) / win

    arr = np.convolve(ts, kernel, 'valid')
    if padding:
        return np.insert(arr, 0, [np.nan] * (win - 1))
    else:
        return arr

moving_average(np.arange(5), 3)
```

è¾“å‡ºç»“æœä¸º`array([nan, nan,  1.,  2.,  3.])`

ç§»åŠ¨å‡çº¿æ˜¯åªè€ƒè™‘ä»·æ ¼ä¿¡æ¯çš„ä¸€ç§å‡çº¿ã€‚åˆ†æ—¶å‡ä»·çº¿åˆ™åˆ™åŒæ—¶çº³å…¥æˆäº¤é‡å’Œæˆäº¤ä»·ä¿¡æ¯çš„å‡çº¿ï¼Œåœ¨æ—¥å†…äº¤æ˜“ä¸­æœ‰ç‰¹åˆ«é‡è¦çš„å«ä¹‰ã€‚æ¯”å¦‚ï¼Œåœ¨å¸‚åœºä¸å¥½çš„æƒ…å†µä¸‹ï¼Œå¦‚æœä¸ªè‚¡ä»·æ ¼ä½äºåˆ†æ—¶å‡çº¿ä¸‹æ–¹ï¼Œæ­¤å‰ä¸¤æ¬¡ä¸Šå†²å‡çº¿å¤±è´¥ï¼Œé‚£ä¹ˆï¼Œä¸€æ—¦å†²ç¬¬ä¸‰æ¬¡å¤±è´¥ï¼Œä¸€èˆ¬è®¤ä¸ºè¦å°½å¿«å–å‡ºã€‚åä¹‹äº¦ç„¶ã€‚

å‡ä»·çº¿çš„è®¡ç®—å¦‚ä¸‹ï¼š

---

å¦‚æœå½“å‰æ—¶åˆ»ä¸ºtï¼Œåˆ™ç”¨å¼€ç›˜ä»¥æ¥ï¼Œç›´åˆ°æ—¶åˆ»tä¸ºæ­¢çš„æˆäº¤é‡‘é¢é™¤ä»¥æˆäº¤é‡ï¼Œå³å¾—åˆ°è¯¥æ—¶åˆ»çš„ç´¯ç§¯æˆäº¤å‡ä»·ã€‚å°†æ‰€æœ‰æ—¶åˆ»çš„æˆäº¤å‡ä»·è¿æ¥èµ·æ¥ï¼Œå³æ„æˆäº†åˆ†æ—¶å‡ä»·çº¿ã€‚

è¿™ä¸ªåŠŸèƒ½çœ‹ä¼¼å¤æ‚ï¼Œä½†ç”±äºnumpyæä¾›äº†cumsumå‡½æ•°ï¼Œå› æ­¤å®é™…ä¸Šè®¡ç®—éå¸¸ç®€å•ï¼š

```python
def intraday_moving_average(bars: DataFrame)->np.ndarray:
    acc_vol = bars["volume"].cumsum()
    acc_money = barss["amount"].cumsum()

    return acc_money / acc_vol
```

åœ¨æœ¬ç¯å¢ƒä¸­ï¼Œåªæä¾›äº†æ—¥çº¿æ•°æ®ï¼Œæˆ‘ä»¬ä»¥æ—¥çº¿ä»£æ›¿åˆ†é’Ÿçº¿è¿›è¡Œæµ‹è¯•ï¼š

```python
start = datetime.date(2023, 1, 1)
end = datetime.date(2023, 12, 29)
barss = load_bars(start, end, 1)

intraday_moving_average(barss)
```

## è®¡ç®—æœ€å¤§å›æ’¤

æœ€å¤§å›æ’¤ï¼ˆMDDï¼‰æ˜¯æŒ‡æŠ•èµ„ç»„åˆä»æœ€é«˜ç‚¹åˆ°æœ€ä½ç‚¹çš„æœ€å¤§è§‚å¯ŸæŸå¤±ï¼Œç›´åˆ°è¾¾åˆ°æ–°çš„æœ€é«˜ç‚¹ã€‚æœ€å¤§å›æ’¤æ˜¯ä¸€å®šæ—¶é—´å‘¨æœŸå†…çš„ä¸‹è¡Œé£é™©æŒ‡æ ‡ã€‚

---

$$
MDD = \frac{Trough Value - Peak Value}{Peak Value}
$$

max drawdownæ˜¯è¡¡é‡æŠ•èµ„ç­–ç•¥é£é™©çš„é‡è¦æŒ‡æ ‡ï¼Œå› æ­¤ï¼Œåœ¨empyricalåº“ä¸­æœ‰å®ç°ã€‚ä¸è¿‡ï¼Œä½œä¸ºç­–ç•¥é£é™©è¯„ä¼°æŒ‡æ ‡ï¼Œempyricalæ²¡å¿…è¦è¿”å›durationç­‰ä¿¡æ¯ï¼Œä¹Ÿæ²¡æœ‰å®ç°æ»‘åŠ¨çª—å£ä¸‹çš„mddã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°±æ¥å®ç°æ»‘åŠ¨ç‰ˆæœ¬ã€‚

```python
# https://stackoverflow.com/a/21059308
from numpy.lib.stride_tricks import as_strided
import matplotlib.pyplot as plt

def windowed_view(x, window_size):
    """Creat a 2d windowed view of a 1d array.

    `x` must be a 1d numpy array.

    `numpy.lib.stride_tricks.as_strided` is used to create the view.
    The data is not copied.

    Example:

    >>> x = np.array([1, 2, 3, 4, 5, 6])
    >>> windowed_view(x, 3)
    array([[1, 2, 3],
           [2, 3, 4],
           [3, 4, 5],
           [4, 5, 6]])
    """
    y = as_strided(x, shape=(x.size - window_size + 1, window_size),
                   strides=(x.strides[0], x.strides[0]))
    return y
```

---

```python
def rolling_max_dd(x, window_size, min_periods=1):
    """Compute the rolling maximum drawdown of `x`.

    `x` must be a 1d numpy array.
    `min_periods` should satisfy `1 <= min_periods <= window_size`.

    Returns an 1d array with length `len(x) - min_periods + 1`.
    """
    if min_periods < window_size:
        pad = np.empty(window_size - min_periods)
        pad.fill(x[0])
        x = np.concatenate((pad, x))
    y = windowed_view(x, window_size)
    running_max_y = np.maximum.accumulate(y, axis=1)
    dd = y - running_max_y
    return dd.min(axis=1)


np.random.seed(0)
n = 100
s = np.random.randn(n).cumsum()
win = 20

mdd = rolling_max_dd(s, win, min_periods=1)

plt.plot(s, 'b')
plt.plot(mdd, 'g.')

plt.show()
```

æµ‹è¯•è¡¨æ˜ï¼Œå½“æ—¶åºsé•¿åº¦ä¸º1000æ—¶ï¼Œrolling_max_ddçš„è®¡ç®—è€—æ—¶ä¸º100ğœ‡Sã€‚

æ»‘åŠ¨çª—å£ä¸‹ï¼Œç”Ÿæˆçš„mddä¸åŸåºåˆ—å¯¹ç…§å›¾å¦‚ä¸‹ï¼š

---

![](https://images.jieyu.ai/images/2024/10/rolling-mdd.png)


è¯¥æ–¹æ³•ä¸­ï¼Œè¿˜ç®€å•åœ°å°è£…äº†ä¸€ä¸ªå°†ä¸€ç»´æ•°ç»„è½¬æ¢ä¸ºæ»‘åŠ¨çª—å£è§†å›¾çš„å‡½æ•°ï¼Œå¯ä»¥åœ¨å…¶å®ƒåœ°æ–¹ä½¿ç”¨ã€‚

## å¯»æ‰¾è‡ªé€‚åº”å‚æ•°

å¾ˆå¤šåŸºäºæŠ€æœ¯æŒ‡æ ‡çš„äº¤æ˜“ç­–ç•¥å¾€å¾€æŒ‡å®šäº†å›ºå®šçš„é˜ˆå€¼ã€‚æ¯”å¦‚ï¼Œä¸€äº›äººä¼šåœ¨RSI 80ä»¥ä¸Šåšç©ºï¼Œåœ¨RSI 20ä»¥ä¸‹åšå¤šã€‚å³ä½¿æ˜¯ç”¨åœ¨æŒ‡æ•°å’Œè¡Œä¸šæ¿å—ä¸Šï¼Œè¿™æ ·çš„æŒ‡æ ‡ä»ç„¶ä¸å¤Ÿç²¾ç¡®ï¼Œå› ä¸ºåœ¨ä¸Šè¡Œé€šé“ä¸­ï¼ŒRSIçš„é¡¶ç‚¹ä¼šé«˜äºä¸‹è¡Œé€šé“ä¸­çš„RSIé¡¶ç‚¹ï¼›åœ¨ä¸‹è¡Œé€šé“ä¸­ï¼ŒRSIçš„åº•éƒ¨åˆ™ä¼šæ¯”ä¸Šè¡Œé€šé“ä¸­çš„RSIåº•éƒ¨ä½å¾ˆå¤šã€‚

---

æ­¤å¤–ï¼Œä¸åŒçš„æ ‡çš„ï¼ŒRSIå–å€¼èŒƒå›´ä¹Ÿä¸ä¸€æ ·ã€‚ä¸ä»…ä»…æ˜¯RSIï¼Œè®¸å¤šæŠ€æœ¯æŒ‡æ ‡éƒ½å­˜åœ¨éœ€è¦æ ¹æ®å½“å‰çš„å¸‚åœºç¯å¢ƒå’Œæ ‡çš„ï¼Œé‡‡ç”¨è‡ªé€‚åº”å‚æ•°çš„æƒ…å†µã€‚

å…¶ä¸­ä¸€ä¸ªæ–¹æ¡ˆæ˜¯ä½¿ç”¨ç±»ä¼¼äºå¸ƒæ—å¸¦çš„æ–¹æ¡ˆï¼Œä½¿ç”¨æŒ‡æ ‡å‡å€¼çš„æ ‡å‡†å·®ä¸Šä¸‹ç•Œã€‚ä½†è¿™ä¸ªæ–¹æ¡ˆéšå«äº†æŠ€æœ¯æŒ‡æ ‡å‡å€¼çš„æ•°æ®åˆ†å¸ƒæœä»æ­£æ€åˆ†å¸ƒçš„æ¡ä»¶ã€‚

æˆ‘ä»¬å¯ä»¥æ”¾å®½è¿™ä¸ªæ¡ä»¶ï¼Œæ”¹ç”¨åˆ†ä½æ•°ï¼Œå³numpyçš„percentileæ¥ç¡®å®šå‚æ•°é˜ˆå€¼ã€‚

```python
%precision 2

from IPython.core.interactiveshell import InteractiveShell
InteractiveShell.ast_node_interactivity = "all"

np.random.seed(78)
s = np.random.randn(100)

hbound = np.percentile(s, 95)
lbound = np.percentile(s, 5)

s[s> hbound]
s[s< lbound]
```

é€šè¿‡percentileæ‰¾å‡ºæ¥è¶…è¿‡ä¸Šä¸‹ç•Œçš„æ•°æ®ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š

```
array([2.09, 2.27, 2.21, 2.12, 2.19])
array([-1.68, -2.4 , -1.97, -1.7 , -1.46])
```

---

ä¸€æ—¦æŒ‡æ ‡è¶…è¿‡95%çš„åˆ†ä½æ•°ï¼ˆhboundï¼‰ï¼Œæˆ‘ä»¬å°±åšç©ºï¼›ä¸€æ—¦æŒ‡æ ‡ä½äº5%çš„åˆ†ä½æ•°ï¼ˆlboundï¼‰ï¼Œæˆ‘ä»¬å°±åšå¤šã€‚

è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸­ä½æ•°æå€¼æ³•ã€‚ä¸€æ—¦æŒ‡æ ‡è¶…è¿‡ä¸­ä½æ•°MADå€¼çš„3å€ï¼Œå°±å‘å‡ºäº¤æ˜“ä¿¡å· ã€‚

<about/>

---

## ã€Šå› å­æŠ•èµ„ä¸æœºå™¨å­¦ä¹ ç­–ç•¥ã€‹å¼€è¯¾å•¦ï¼

![](https://images.jieyu.ai/images/hot/course/factor-ml/1.png)

---

## ç›®æ ‡æ¸…æ™° è·å¾—æ„Ÿå¼º

![](https://images.jieyu.ai/images/hot/course/factor-ml/2.png)

---

## ä¸ºä»€ä¹ˆä½ å€¼å¾—QuanTideçš„è¯¾ç¨‹ï¼Ÿ

![](https://images.jieyu.ai/images/hot/course/factor-ml/3.png)

