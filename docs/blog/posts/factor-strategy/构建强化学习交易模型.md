
å¼ºåŒ–å­¦ä¹ ï¼ˆRLï¼‰è¿™ä¸ªåå­—ï¼Œç¬¬ä¸€æ¬¡é—¯å…¥å¤§ä¼—è§†é‡ï¼Œè¿˜è¦è¿½æº¯åˆ°AlphaGoä¸æä¸–çŸ³é‚£åœºè½½å…¥å²å†Œçš„äººæœºå¤§æˆ˜ã€‚ä¸€æˆ˜æˆååï¼Œå®ƒä¼¼ä¹åˆå›å½’äº†å­¦æœ¯çš„è±¡ç‰™å¡”ï¼Œç›´åˆ°æœ€è¿‘ï¼Œéšç€DeepSeekç­‰æ¨¡å‹çš„æƒŠè‰³äº®ç›¸ï¼ŒRLä»¥å…¶å¼ºå¤§çš„æ¨ç†èƒ½åŠ›ï¼Œå†æ¬¡è¢«æ¨åˆ°äº†èšå…‰ç¯ä¸‹ã€‚

å…¶å®ï¼Œå¼ºåŒ–å­¦ä¹ åœ¨é‡åŒ–æŠ•èµ„ä¸­æ—©æœ‰å®é™…çš„åº”ç”¨ã€‚å°½ç®¡ä¸€äº›é¡¶å°–çš„æŠ•èµ„å…¬å¸çš„å½“å®¶ç­–ç•¥ä¸ä¼šè½»æ˜“é€éœ²å‡ºæ¥ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ‰¾åˆ°äº†ä¸€äº›æ¡ˆä¾‹ï¼Œè¡¨æ˜åå°”è¡—çš„é¡¶çº§ç©å®¶ä»¬æ—©å·²å¼€å§‹ä½¿ç”¨å¼ºåŒ–å­¦ä¹ ã€‚

æ¯”å¦‚ï¼Œ2017å¹´å‰åï¼Œå…¨çƒé¡¶çº§çš„æŠ•èµ„é“¶è¡Œæ‘©æ ¹å¤§é€šï¼ˆJ.P. Morganï¼‰å°±æ¨å‡ºäº†ä¸€ä¸ªåä¸ºLOXM<sup>1</sup>çš„â€œè§…å½±â€äº¤æ˜“æ‰§è¡Œå¹³å°ã€‚è€Œé©±åŠ¨è¿™ä¸ªå¹³å°çš„ã€ç§˜å¯†æ­¦å™¨ã€ï¼Œæ­£æ˜¯æˆ‘ä»¬ä»Šå¤©çš„ä¸»è§’â€”â€”å¼ºåŒ–å­¦ä¹ ï¼ˆReinforcement Learning, RLï¼‰ã€‚

LOXMçš„ç›®æ ‡éå¸¸æ˜ç¡®ï¼šåœ¨æ‰§è¡Œå¤§é¢è‚¡ç¥¨è®¢å•æ—¶ï¼Œåƒä¸€ä¸ªé¡¶çº§äº¤æ˜“å‘˜ä¸€æ ·ï¼Œæ™ºèƒ½åœ°å°†å¤§å•æ‹†åˆ†æˆæ— æ•°å°å•ï¼Œåœ¨å¤æ‚çš„å¸‚åœºå¾®è§‚ç»“æ„ä¸­ç©¿æ¢­ï¼Œä»¥æœ€ä½çš„å†²å‡»æˆæœ¬å’Œæœ€å¿«çš„é€Ÿåº¦å®Œæˆäº¤æ˜“ã€‚è¿™å·²ç»ä¸æ˜¯ç®€å•åœ°é¢„æµ‹æ¶¨è·Œï¼Œè€Œæ˜¯åœ¨åŠ¨æ€çš„å¸‚åœºåšå¼ˆä¸­ï¼Œå­¦ä¹ â€œå¦‚ä½•äº¤æ˜“â€è¿™é—¨è‰ºæœ¯ã€‚

## ç©¶ç«Ÿä»€ä¹ˆæ˜¯å¼ºåŒ–å­¦ä¹ ï¼Ÿ
é‚£ä¹ˆï¼Œè¿™ä¸ªå¬èµ·æ¥å¦‚æ­¤é«˜å¤§ä¸Šçš„å¼ºåŒ–å­¦ä¹ ï¼Œåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ

æ ¹æ®ã€ŠReinforcement Learning for Quantitative Tradingã€‹è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºä¸€ä¸ªç»Ÿä¸€çš„æ¡†æ¶æ¥ç†è§£å®ƒã€‚

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ­£åœ¨ç©ä¸€ä¸ªç”µå­æ¸¸æˆï¼Œä½ çš„ç›®æ ‡æ˜¯è·å¾—å°½å¯èƒ½é«˜çš„åˆ†æ•°ã€‚åœ¨è¿™ä¸ªæ¸¸æˆé‡Œï¼š

- ä½ ï¼Œå°±æ˜¯ä»£ç†ï¼ˆAgentï¼‰ã€‚åœ¨é‡åŒ–äº¤æ˜“ä¸­ï¼Œè¿™ä¸ªä»£ç†å°±æ˜¯ä½ çš„äº¤æ˜“ç®—æ³•ã€‚
- æ¸¸æˆä¸–ç•Œï¼Œå°±æ˜¯ç¯å¢ƒï¼ˆEnvironmentï¼‰ã€‚åœ¨äº¤æ˜“ä¸­ï¼Œè¿™å°±æ˜¯ç¬æ¯ä¸‡å˜çš„é‡‘èå¸‚åœºã€‚
- ä½ åœ¨æ¸¸æˆä¸­çœ‹åˆ°çš„ç”»é¢å’ŒçŠ¶æ€ï¼ˆæ¯”å¦‚ä½ çš„è¡€é‡ã€ä½ç½®ã€æ•Œäººçš„æ•°é‡ï¼‰ï¼Œå°±æ˜¯çŠ¶æ€ï¼ˆStateï¼‰ã€‚åœ¨äº¤æ˜“ä¸­ï¼Œè¿™å¯ä»¥æ˜¯è‚¡ä»·ã€æˆäº¤é‡ã€æŠ€æœ¯æŒ‡æ ‡ã€å®è§‚æ•°æ®ç­‰ç­‰ã€‚
- ä½ æŒ‰ä¸‹çš„æ¯ä¸€ä¸ªæ“ä½œï¼ˆå‰è¿›ã€åé€€ã€å¼€ç«ï¼‰ï¼Œå°±æ˜¯è¡ŒåŠ¨ï¼ˆActionï¼‰ ã€‚åœ¨äº¤æ˜“ä¸­ï¼Œè¿™å¯¹åº”ç€ä¹°å…¥ã€å–å‡ºæˆ–æŒæœ‰ã€‚
- ä½ æ¯æ¬¡è¡ŒåŠ¨åè·å¾—æˆ–å¤±å»çš„åˆ†æ•° ï¼Œå°±æ˜¯å¥–åŠ±ï¼ˆRewardï¼‰ã€‚åœ¨äº¤æ˜“ä¸­ï¼Œè¿™é€šå¸¸æ˜¯ä½ çš„æŠ•èµ„ç»„åˆçš„æ”¶ç›Šæˆ–æŸå¤±ã€‚
å¼ºåŒ–å­¦ä¹ çš„æ ¸å¿ƒæ€æƒ³ï¼Œå°±æ˜¯è®©ä»£ç†ï¼ˆäº¤æ˜“ç®—æ³•ï¼‰åœ¨è¿™ä¸ªç¯å¢ƒï¼ˆé‡‘èå¸‚åœºï¼‰ä¸­ä¸æ–­åœ°â€œè¯•é”™â€ï¼ˆtake actionsï¼‰ï¼Œæ ¹æ®æ¯æ¬¡è¯•é”™åå¾—åˆ°çš„å¥–åŠ±ï¼ˆæ”¶ç›Šæˆ–äºæŸï¼‰ï¼Œæ¥å­¦ä¹ ä¸€å¥—æœ€ä¼˜çš„ç­–ç•¥ï¼ˆPolicyï¼‰ï¼Œä»è€Œåœ¨é•¿æœŸå†…å®ç°ç´¯è®¡å¥–åŠ±çš„æœ€å¤§åŒ–ï¼ˆé•¿æœŸæ”¶ç›Šæœ€å¤§åŒ–ï¼‰ã€‚å®ƒä¸æ˜¯åœ¨å­¦ä¹ â€œå¸‚åœºä¸‹ä¸€ç§’ä¼šæ€æ ·â€ï¼Œè€Œæ˜¯åœ¨å­¦ä¹ **ã€é¢å¯¹å½“å‰çš„å¸‚åœºï¼Œæˆ‘è¯¥æ€ä¹ˆåšæ‰æ˜¯æœ€ä¼˜çš„ã€**ã€‚

## å¼ºåŒ–å­¦ä¹ å¼ºåœ¨å“ªå„¿ï¼Ÿ

çœ‹åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šé—®ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†ç›‘ç£å­¦ä¹ ï¼ˆæ¯”å¦‚é¢„æµ‹è‚¡ä»·æ¶¨è·Œï¼‰å’Œæ— ç›‘ç£å­¦ä¹ ï¼ˆæ¯”å¦‚èšç±»å‘ç°å¸‚åœºé£æ ¼ï¼‰ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦å¼ºåŒ–å­¦ä¹ ï¼Ÿå®ƒåˆ°åº•å¼ºåœ¨å“ªï¼Ÿ

å¼ºåŒ–å­¦ä¹ ä¸ä¸ç›‘ç£/æ— ç›‘ç£å­¦ä¹ çš„æ ¹æœ¬åŒºåˆ«åœ¨äºå­¦ä¹ èŒƒå¼ã€‚ç›‘ç£å­¦ä¹ åƒæ˜¯åœ¨èƒŒä¸€æœ¬æ ‡å‡†ç­”æ¡ˆä¹¦ã€‚ä½ ç»™å®ƒä¸€å¼ å†å²Kçº¿å›¾ï¼ˆè¾“å…¥ç‰¹å¾ï¼‰ï¼Œå‘Šè¯‰å®ƒç¬¬äºŒå¤©æ˜¯æ¶¨è¿˜æ˜¯è·Œï¼ˆæ ‡ç­¾ï¼‰ï¼Œå®ƒå­¦ä¹ çš„æ˜¯ä¸€ç§é™æ€çš„"çœ‹å›¾è¯†å­—"èƒ½åŠ›ã€‚æ— ç›‘ç£å­¦ä¹ åˆ™æ˜¯åœ¨æ²¡æœ‰ç­”æ¡ˆçš„æƒ…å†µä¸‹ï¼Œè‡ªå·±åœ¨ä¸€å †æ•°æ®é‡Œæ‰¾è§„å¾‹ï¼Œæ¯”å¦‚æŠŠç›¸ä¼¼çš„è‚¡ç¥¨è‡ªåŠ¨å½’ä¸ºä¸€ç±»ã€‚å®ƒä»¬éƒ½åœ¨è¯•å›¾å›ç­”"æ˜¯ä»€ä¹ˆ"çš„é—®é¢˜ã€‚

è€Œå¼ºåŒ–å­¦ä¹ ï¼Œåˆ™æ˜¯åœ¨å­¦ä¹ ä¸€å¥—å†³ç­–æµç¨‹ã€‚å®ƒæ²¡æœ‰"æ ‡å‡†ç­”æ¡ˆ"å¯èƒŒã€‚å¸‚åœºä¸ä¼šå‘Šè¯‰ä½ "åœ¨æ­¤æ—¶æ­¤åˆ»ä¹°å…¥å°±æ˜¯å”¯ä¸€æ­£ç¡®çš„ç­”æ¡ˆ"ã€‚RLé¢å¯¹çš„æ˜¯ä¸€ç³»åˆ—çš„å†³ç­–ï¼Œæ¯ä¸ªå†³ç­–éƒ½ä¼šå½±å“åˆ°æœªæ¥çš„çŠ¶æ€å’Œå¯èƒ½çš„æ”¶ç›Šã€‚å®ƒè¦å›ç­”çš„æ˜¯"è¯¥åšä»€ä¹ˆ"çš„é—®é¢˜ã€‚è¿™æ˜¯ä¸€ä¸ªåŠ¨æ€çš„ã€æœ‰å› æœé“¾æ¡çš„ã€é¢å‘æœªæ¥çš„å­¦ä¹ è¿‡ç¨‹ã€‚

æœ‰äººä¼šè¯´ï¼Œæˆ‘å¯ä»¥ç”¨ç›‘ç£å­¦ä¹ æ¨¡å‹ï¼Œç„¶åä¸æ–­åœ°ç”¨æ–°çš„æ•°æ®å»æŒç»­è®­ç»ƒå’Œé¢„æµ‹ï¼ˆå³åœ¨çº¿å­¦ä¹ ï¼Œlive learningï¼‰ï¼Œè¿™å’Œå¼ºåŒ–å­¦ä¹ æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

è¡¨é¢ä¸Šçœ‹ï¼Œä¸¤è€…éƒ½åœ¨ä¸æ–­é€‚åº”æ–°æ•°æ®ï¼Œä½†å†…æ ¸å®Œå…¨ä¸åŒã€‚è€Œå¼ºåŒ–å­¦ä¹ çš„æ ¸å¿ƒä¼˜åŠ¿åœ¨äºä¸¤ä¸ªç›‘ç£å­¦ä¹ æ— æ³•ä¼åŠçš„ç»´åº¦ï¼š

!!! tip æ¢ç´¢ä¸åˆ©ç”¨ï¼ˆExploration vs. Exploitationï¼‰
    è¿™æ˜¯RLçš„çµé­‚ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œä½ å¸¸å»çš„ä¸€å®¶é¤å…å‘³é“ä¸é”™ï¼ˆåˆ©ç”¨ï¼‰ï¼Œä½†ä½ å¶å°”ä¹Ÿä¼šæƒ³è¯•è¯•æ–°é¦†å­ï¼Œä¸‡ä¸€æœ‰æƒŠå–œå‘¢ï¼ˆæ¢ç´¢ï¼‰ï¼ŸRLä»£ç†åœ¨è®­ç»ƒæ—¶ï¼Œä¹Ÿä¼šåœ¨"æ‰§è¡Œå·²çŸ¥çš„æœ€ä¼˜ç­–ç•¥"å’Œ"å°è¯•æœªçŸ¥çš„ã€å¯èƒ½æœ‰æ›´é«˜å›æŠ¥çš„ç­–ç•¥"ä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚è¿™ç§æ¢ç´¢ç²¾ç¥ï¼Œä½¿å¾—RLæœ‰å¯èƒ½å‘ç°äººç±»äº¤æ˜“å‘˜æˆ–ç›‘ç£å­¦ä¹ æ¨¡å‹ä»æœªæƒ³è¿‡çš„ã€æ›´ä¼˜çš„äº¤æ˜“æ¨¡å¼ã€‚è€Œç›‘ç£å­¦ä¹ åªä¼šå‘Šè¯‰ä½ ï¼Œæ ¹æ®å†å²ç»éªŒï¼Œå»é‚£å®¶è€é¤å…æ˜¯"æ­£ç¡®ç­”æ¡ˆ"ã€‚
  
  
!!! tip å­¦ä¹ åŠ¨æ€å› æœå…³ç³»
    å¼ºåŒ–å­¦ä¹ å…³æ³¨çš„æ˜¯ä¸€ä¸ªè¡ŒåŠ¨åºåˆ—ï¼ˆæ¯”å¦‚ï¼Œå…ˆä¹°å…¥Aï¼Œå†å–å‡ºBï¼‰ä¸æœ€ç»ˆç»“æœä¹‹é—´çš„å› æœè”ç³»ã€‚å®ƒèƒ½ç†è§£ï¼Œæœ‰æ—¶å€™ä¸€ä¸ªçŸ­æœŸçš„äºæŸï¼ˆæ¯”å¦‚ä¸ºäº†å»ºä»“æ‹‰ä½æˆæœ¬è€Œä¸»åŠ¨æ‰¿å—æµ®äºï¼‰æ˜¯ä¸ºäº†ä¸€ä¸ªæ›´å¤§çš„é•¿æœŸç›®æ ‡ã€‚è€Œç›‘ç£å­¦ä¹ ä¸€æ¬¡åªçœ‹ä¸€ä¸ª"æ—¶é—´åˆ‡ç‰‡"ï¼Œå®ƒå¾ˆéš¾ç†è§£è¿™ç§è·¨æ—¶é—´çš„ã€å…·æœ‰å»¶è¿Ÿæ•ˆåº”çš„å› æœé€»è¾‘ã€‚

ç”±äºå¼ºåŒ–å­¦ä¹ çš„è¿™ä¸¤ä¸ªç‰¹ç‚¹ï¼Œæ‰€ä»¥ï¼Œæ¯”èµ·ç›‘ç£å­¦ä¹ ï¼Œå®ƒèƒ½æ›´å¥½åœ°å¯¹æŠ—é‡‘èå™ªå£° -- ä¼—æ‰€å‘¨çŸ¥ï¼Œæ·±åº¦å­¦ä¹ åœ¨é‡‘èæŠ•èµ„é¢†åŸŸæŠ˜æˆŸæ²‰æ²™ï¼Œä¸»è¦å°±æ˜¯å› ä¸ºé‡‘èæ•°æ®å™ªå£°å¤ªå¤§çš„åŸå› ã€‚

é‡‘èæ•°æ®ä»¥ä½ä¿¡å™ªæ¯”è‘—ç§°ï¼Œå……æ»¡äº†éšæœºæ³¢åŠ¨å’Œ"å‡ä¿¡å·"ã€‚å¼ºåŒ–å­¦ä¹ ä¹‹æ‰€ä»¥åœ¨è¿™æ ·çš„ç¯å¢ƒä¸­æ›´å…·ä¼˜åŠ¿ï¼Œä¸»è¦æºäºå…¶ç‹¬ç‰¹çš„è®¾è®¡ï¼š

- å…³æ³¨é•¿æœŸå›æŠ¥ï¼Œå®¹å¿çŸ­æœŸé˜µç—›ï¼šç›‘ç£å­¦ä¹ æ¨¡å‹è¿½æ±‚çš„æ˜¯åœ¨æ¯ä¸ªæ—¶é—´ç‚¹ä¸Šé¢„æµ‹çš„å‡†ç¡®ç‡ã€‚å¦‚æœå¸‚åœºå™ªéŸ³è®©å®ƒåšå‡ºäº†ä¸€ä¸ªé”™è¯¯çš„é¢„æµ‹ï¼Œå®ƒå°±ä¼šè¢«"æƒ©ç½š"ã€‚è€ŒRLçš„ç›®æ ‡æ˜¯æœ€å¤§åŒ–æ•´ä¸ªäº¤æ˜“è¿‡ç¨‹çš„ç´¯è®¡å›æŠ¥ã€‚è¿™æ„å‘³ç€ï¼Œå®ƒå¯ä»¥æœ‰æ„è¯†åœ°æ‰§è¡Œä¸€ä¸ªçŸ­æœŸçœ‹èµ·æ¥ä¼šäºé’±çš„åŠ¨ä½œï¼ˆæ¯”å¦‚ï¼Œåœ¨ä¸€ä¸ªçœ‹ä¼¼è¦ä¸‹è·Œçš„æ—¶åˆ»ä¹°å…¥ï¼‰ï¼Œå¦‚æœè¿™ä¸ªåŠ¨ä½œæ˜¯å…¶é•¿æœŸåˆ¶èƒœç­–ç•¥çš„ä¸€éƒ¨åˆ†ï¼ˆæ¯”å¦‚ï¼Œå®ƒåˆ¤æ–­è¿™æ˜¯ä¸€ä¸ªä¸»åŠ›æ´—ç›˜çš„å‡æ‘”ï¼‰ã€‚è¿™ç§"å»¶è¿Ÿæ»¡è¶³"çš„ç‰¹æ€§ï¼Œè®©å®ƒå¯¹çŸ­æœŸå¸‚åœºå™ªéŸ³æœ‰æ›´å¼ºçš„å…ç–«åŠ›ã€‚

- åŠ¨æ€é€‚åº”ï¼Œè€Œéåˆ»èˆŸæ±‚å‰‘ï¼šå¸‚åœºé£æ ¼æ˜¯ä¼šåˆ‡æ¢çš„ï¼Œæ˜¨å¤©æœ‰æ•ˆçš„å› å­ï¼Œä»Šå¤©å¯èƒ½å°±å¤±æ•ˆäº†ã€‚ç›‘ç£å­¦ä¹ æ¨¡å‹ä¸€æ—¦è®­ç»ƒå¥½ï¼Œå…¶æ¨¡å¼å°±ç›¸å¯¹å›ºå®šï¼Œåƒä¸€ä¸ªåˆ»èˆŸæ±‚å‰‘çš„å‚»ç“œã€‚è€ŒRLä»£ç†çš„ç­–ç•¥æœ¬èº«å°±æ˜¯çŠ¶æ€çš„å‡½æ•°ï¼Œå®ƒè¢«è®¾è®¡ä¸ºæ ¹æ®ç¯å¢ƒçš„å˜åŒ–è€ŒåŠ¨æ€è°ƒæ•´è‡ªå·±çš„è¡Œä¸ºã€‚å½“å¸‚åœºä»ç‰›å¸‚è½¬å‘ç†Šå¸‚ï¼ŒRLä»£ç†èƒ½å¤Ÿé€šè¿‡ä¸ç¯å¢ƒçš„æŒç»­äº¤äº’ï¼Œæ„ŸçŸ¥åˆ°è¿™ç§å˜åŒ–ï¼Œå¹¶ç›¸åº”åœ°è°ƒæ•´å…¶äº¤æ˜“ç­–ç•¥ï¼Œä»æ¿€è¿›åšå¤šè½¬ä¸ºä¿å®ˆç”šè‡³åšç©ºã€‚è¿™ç§ä¸ç”Ÿä¿±æ¥çš„é€‚åº”æ€§ï¼Œæ˜¯å…¶å¯¹æŠ—éå¹³ç¨³å¸‚åœºçš„å…³é”®ã€‚

```python
from pathlib import Path
data_home = Path("~/workspace/data").expanduser()
```

## ä»"è¿½æ¶¨æ€è·Œ"çš„AlphaStockè¯´èµ·

é¡¶çº§æœºæ„çš„é‡åŒ–ç­–ç•¥éƒ½æ˜¯ç§˜è€Œä¸å®£çš„ï¼Œå³ä½¿æ˜¯æ‘©æ ¹å¤§é€šçš„LOXMè¿™ç§å…¬å¼€å‡ºåœˆçš„æ¨¡å‹ï¼Œå…¶æ„å»ºä¸è¿è¡Œæœºåˆ¶å¯¹æ™®é€šäººæ¥è®²ï¼Œä¹Ÿä»ç„¶æ˜¯æ— æ³•æ¥è§¦çš„ã€‚é‚£ä¹ˆï¼Œä½œä¸ºé‡åŒ–äº¤æ˜“è€…ï¼Œæˆ‘ä»¬è¦å¦‚ä½•æ„å»ºè‡ªå·±çš„å¼ºåŒ–å­¦ä¹ äº¤æ˜“æ¨¡å‹å‘¢ï¼Ÿ

2019å¹´ï¼Œæ¥è‡ªæ¸…åå¤§å­¦å’Œå¾®è½¯äºšæ´²ç ”ç©¶é™¢çš„å›¢é˜Ÿå¼€å‘äº†ä¸€ä¸ªåä¸º AlphaStock<sup>1</sup> çš„æ¨¡å‹ã€‚è¿™ä¸ªæ¨¡å‹å·§å¦™åœ°å°†å¼ºåŒ–å­¦ä¹ ä¸æ³¨æ„åŠ›æœºåˆ¶ï¼ˆAttention Mechanismï¼Œæ²¡é”™ï¼Œå°±æ˜¯Transformeræ¨¡å‹çš„æ ¸å¿ƒï¼‰ç›¸ç»“åˆï¼Œä¸“é—¨ç”¨æ¥ä¼˜åŒ–ä¸€ä¸ªå¤è€è€Œæœ‰æ•ˆçš„ç­–ç•¥â€”â€”è¿½æ¶¨æ€è·Œï¼ˆå³åŠ¨é‡äº¤æ˜“ï¼‰ã€‚

ä¼ ç»Ÿçš„åŠ¨é‡ç­–ç•¥å¾ˆç®€å•ï¼šä¹°å…¥è¿‡å»è¡¨ç°å¥½çš„è‚¡ç¥¨ï¼Œå–å‡ºè¿‡å»è¡¨ç°å·®çš„ã€‚ä½†é—®é¢˜æ˜¯ï¼ŒåŠ¨é‡ä»€ä¹ˆæ—¶å€™ä¼šæŒç»­ï¼Ÿä»€ä¹ˆæ—¶å€™ä¼šåè½¬ï¼ŸAlphaStockçš„èªæ˜ä¹‹å¤„åœ¨äºï¼Œå®ƒä¸ä¾èµ–äºå›ºå®šçš„è§„åˆ™ï¼Œè€Œæ˜¯è®©RLä»£ç†å»å­¦ä¹ ã€‚ä»£ç†è§‚å¯Ÿå¸‚åœºä¸Šæ•°ç™¾åªè‚¡ç¥¨çš„ä»·æ ¼å’Œæˆäº¤é‡æ•°æ®ï¼ˆçŠ¶æ€ï¼‰ï¼Œç„¶åå†³å®šåœ¨å“ªäº›è‚¡ç¥¨ä¸Šåˆ†é…å¤šå°‘èµ„é‡‘ï¼ˆè¡ŒåŠ¨ï¼‰ã€‚å¦‚æœè¿™ä¸ªå†³ç­–åœ¨æœªæ¥ä¸€æ®µæ—¶é—´å¸¦æ¥äº†æ­£æ”¶ç›Šï¼Œå®ƒå°±è·å¾—æ­£å¥–åŠ±ï¼Œåä¹‹äº¦ç„¶ã€‚é€šè¿‡æµ·é‡å†å²æ•°æ®çš„å›æµ‹è®­ç»ƒï¼ŒAlphaStockæœ€ç»ˆå°±èƒ½ä¼šäº†å¦‚ä½•åŠ¨æ€åœ°è¯†åˆ«å’Œåˆ©ç”¨å¸‚åœºä¸­çš„åŠ¨é‡æ•ˆåº”ï¼Œç”šè‡³èƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šè§„é¿åŠ¨é‡åè½¬çš„é£é™©ã€‚è¿™å°±åƒä¸€ä¸ªæ­¦æ—é«˜æ‰‹ï¼Œé€šè¿‡æ— æ•°æ¬¡å®æˆ˜ï¼Œæœ€ç»ˆç»ƒå°±äº†å¯¹æˆ˜å±€çš„æ•é”ç›´è§‰ã€‚

## Get Hands Dirty!åŠ¨æ‰‹ç»ƒä¸€ä¸‹ï¼

ç†è®ºå¬èµ·æ¥å¾ˆç¾ï¼Œä½†å¦‚ä½•ä»˜è¯¸å®è·µï¼Ÿæˆ‘ä»¬è‡ªå·±èƒ½å¦åšå‡ºæ¥ä¸€ä¸ªæœ‰ç”¨çš„å¼ºåŒ–å­¦ä¹ æ¨¡å‹ï¼Ÿæ¥ä¸‹æ¥ï¼Œæˆ‘å°±æ¼”ç¤ºå¦‚ä½•åšå‡ºä¸€ä¸ª

å¯¹äºé‚£äº›å¯ä»¥ã€æ— é™ã€ï¼ˆå³ä¸å—é™ï¼‰è®¿é—®yfinanceåŠalpaca_trade_apiçš„åŒå­¦ï¼Œæˆ‘å¼ºçƒˆæ¨èä» FinRL è¿™ä¸ªå¼€æºåº“å¼€å§‹ã€‚å®ƒè¢«èª‰ä¸º"é‡‘èé¢†åŸŸçš„OpenAI Gym"ï¼Œæå¤§åœ°é™ä½äº†å…¥é—¨é—¨æ§›ã€‚

### å®‰è£… FinRL

é¦–å…ˆï¼Œç¡®ä¿ä½ æœ‰ä¸€ä¸ªPythonç¯å¢ƒï¼ˆæ¨èä½¿ç”¨Anacondaæˆ–venvåˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼‰ï¼Œç„¶åé€šè¿‡pipå®‰è£…FinRLåŠå…¶ä¾èµ–ã€‚

```bash
pip install finrl
```

ä½†æ˜¯ï¼Œæˆ‘ä»¬çš„è¯»è€…å¯èƒ½å¤šæ•°æ— æ³•ä½¿ç”¨yfinanceåŠalpaca_trade_apiåº“ã€‚è¿™æ ·ï¼Œä½ å¯èƒ½å°±ä¸å¾—ä¸ä½¿ç”¨Gymnasiumåº“ï¼Œè‡ªå·±åšå¤šä¸€ç‚¹å·¥ä½œã€‚

!!! tip
    Gymnasium æ˜¯ OpenAI Gym çš„ç»§ä»»è€…ï¼Œæ˜¯ç”¨äºå¼€å‘å’Œæ¯”è¾ƒå¼ºåŒ–å­¦ä¹ ç®—æ³•çš„å¼€æºå·¥å…·åŒ…ã€‚å®ƒæä¾›äº†æ ‡å‡†åŒ–çš„ç¯å¢ƒæ¥å£ï¼Œè®©ç ”ç©¶è€…å’Œå¼€å‘è€…èƒ½å¤Ÿæ›´æ–¹ä¾¿åœ°æµ‹è¯•ç®—æ³•æ€§èƒ½ã€‚

### å®‰è£… Gymnasiumå’ŒSB3ï¼

å¦‚æœä¸ç”¨FinRLï¼Œæˆ‘ä»¬å°±è¦å®‰è£…ä¸¤ä¸ªåå­—å¥‡å¥‡æ€ªæ€ªçš„å¼ºåŒ–å­¦ä¹ åº“ã€‚

!!! tip
    â€œGymnasiumâ€ ä¸€è¯æºäºå¤å¸Œè…Šè¯­ â€œÎ³Ï…Î¼Î½Î¬ÏƒÎ¹Î¿Î½â€ï¼ˆgymnasionï¼‰ï¼Œå­—é¢æ„æ€æ˜¯ â€œè£¸ä½“é”»ç‚¼çš„åœ°æ–¹â€ã€‚ç°ä»£è‹±è¯­ä¸­ï¼Œå¸¸æŒ‡å¥èº«æˆ¿ã€‚ä½†åœ¨å¾·è¯­ä¸­ï¼Œä¹ŸæŒ‡åˆçº§ä¸­å­¦ã€‚

SB3å³æ˜¯Stable-Baselines3ï¼Œæ˜¯å¼ºåŒ–å­¦ä¹ é¢†åŸŸçš„ä¸»æµåº“ä¹‹ä¸€ï¼Œå‡­å€Ÿå…¶é«˜æ•ˆæ€§ã€æ˜“ç”¨æ€§å’Œä¸°å¯Œçš„ç®—æ³•æ”¯æŒï¼Œæˆä¸ºå­¦æœ¯ç ”ç©¶å’Œå·¥ä¸šåº”ç”¨çš„é¦–é€‰å·¥å…·ã€‚

è¿™ä¸¤ä¸ªåº“ä¸­ï¼ŒGymæ˜¯æ¥å£ï¼Œè€ŒSB3æä¾›äº†å„ç§ç®—æ³•ã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œå°†ä½¿ç”¨å®ƒæä¾›çš„PPOç®—æ³•ã€‚ä¸‹é¢æ˜¯å®‰è£…è¿™ä¸¤ä¸ªåº“çš„æŒ‡å—ã€‚

```bash
pip install gymnasium
pip install stable_baselines3
```

æ¥ä¸‹æ¥ï¼Œéœ€è¦è·å–æ•°æ®ã€‚è¿™éƒ¨åˆ†æ²¡æœ‰å•¥è¥å…»ï¼Œæˆ‘ä»¬å°±ä¸æ”¾ä»£ç å‡ºæ¥äº†ï¼Œä»¥å…å ç”¨å¤ªå¤šä½ çš„é˜…è¯»æ—¶é—´ã€‚ä½ å¯ä»¥ä½¿ç”¨ä»»ä½•å–œæ¬¢çš„æ•°æ®æºï¼Œæœ€ç»ˆéœ€è¦å¾—åˆ°ä¸€ä¸ªä»¥ dataå’Œassetä¸ºåŒé‡ç´¢å¼•çš„DataFrameï¼Œå¹¶ä¸”åˆ—åè‡³å°‘åŒ…å«ï¼šopen,high,low,close,volumeã€‚

!!! tip
    å¦‚æœä½ ä¸æƒ³å†™ä»£ç ï¼Œå¯ä»¥æŠ¥åæˆ‘ä»¬çš„è¯¾ç¨‹ã€Šå› å­æŒ–æ˜ä¸æœºå™¨å­¦ä¹ ç­–ç•¥ã€‹ï¼Œè·å–å¯è¿è¡Œçš„ç¤ºä¾‹ã€‚æœ¬ç¤ºä¾‹å¯ä»¥åœ¨æœ¬åœ°è¿è¡Œã€‚


<!--PAID CONTENT START-->
```python
import pandas as pd
import numpy as np
import talib
import datetime
import warnings
warnings.filterwarnings('ignore')

# å‚æ•°è®¾ç½®
N_STOCKS = 9  # è‚¡ç¥¨æ•°é‡ï¼Œå¯ä»¥è°ƒæ•´è¿›è¡Œå¤šæ¬¡éšæœºæµ‹è¯•
DATA_START_DATE = datetime.date(2019, 1, 1)
DATA_END_DATE = datetime.date(2021, 10, 31)

# æ•°æ®åˆ’åˆ†æ¯”ä¾‹ (train:test)
TRAIN_RATIO = 0.8
TEST_RATIO = 0.2
```
<!--PAID CONTENT END-->

<!--PAID CONTENT START-->
åœ¨ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ç¼“å­˜æ•°æ®ã€‚å¦‚æœä½ è¦åœ¨æœ¬åœ°è¿è¡Œè¿™ä¸ªç¤ºä¾‹ï¼Œä½ å¯ä»¥é€šè¿‡tushareæ¥è·å–æ•°æ®ï¼Œä»¥ä¸‹ä¸ºç¤ºä¾‹ï¼š
```python
def get_stock_data_tushare(asset_list, start_date, end_date):
    """ä½¿ç”¨tushareè·å–è‚¡ç¥¨æ•°æ®ï¼ˆå…¼å®¹æ–¹æ³•ï¼Œè¿”å›ä¸load_barsç›¸åŒæ ¼å¼ï¼‰"""
    all_data = []

    # è½¬æ¢æ—¥æœŸæ ¼å¼ä¸ºå­—ç¬¦ä¸²
    start_str = start_date.strftime("%Y%m%d")
    end_str = end_date.strftime("%Y%m%d")

    for asset in asset_list:
        try:
            # è·å–æ—¥çº¿æ•°æ®
            df_stock = pro.daily(ts_code=asset,
                                start_date=start_str,
                                end_date=end_str)

            if not df_stock.empty:
                # é‡å‘½ååˆ—ä»¥åŒ¹é…load_barsæ ¼å¼
                df_stock = df_stock.rename(columns={
                    'trade_date': 'date',
                    'vol': 'volume'
                })

                # è½¬æ¢æ—¥æœŸæ ¼å¼
                df_stock['date'] = pd.to_datetime(df_stock['date'])

                # æ·»åŠ assetåˆ—
                df_stock['asset'] = asset

                # æŒ‰æ—¥æœŸæ’åºï¼ˆtushareè¿”å›çš„æ•°æ®æ˜¯å€’åºçš„ï¼‰
                df_stock = df_stock.sort_values('date').reset_index(drop=True)

                # é€‰æ‹©éœ€è¦çš„åˆ—
                df_stock = df_stock[['date', 'asset', 'open', 'high', 'low', 'close', 'volume']]

                all_data.append(df_stock)
                print(f"æˆåŠŸè·å– {asset} çš„æ•°æ®ï¼Œå…± {len(df_stock)} æ¡è®°å½•")
            else:
                print(f"è­¦å‘Šï¼š{asset} æ²¡æœ‰æ•°æ®")

        except Exception as e:
            print(f"è·å– {asset} æ•°æ®æ—¶å‡ºé”™: {e}")

    if all_data:
        # åˆå¹¶æ‰€æœ‰è‚¡ç¥¨æ•°æ®
        df_combined = pd.concat(all_data, ignore_index=True)

        # è®¾ç½®åŒé‡ç´¢å¼•ä»¥åŒ¹é…load_barsæ ¼å¼
        df_combined = df_combined.set_index(['date', 'asset']).sort_index()

        return df_combined
    else:
        return pd.DataFrame()
```
<!--PAID CONTENT END-->


åœ¨é‡åŒ–äº¤æ˜“ä¸­ï¼Œæˆ‘ä»¬ä»æ¥æ²¡æœ‰è§è¿‡ç«¯åˆ°ç«¯çš„äººå·¥æ™ºèƒ½æ¨¡å‹èƒ½å¤ŸæˆåŠŸçš„ã€‚åŸºæœ¬ä¸Šï¼Œæˆ‘ä»¬æ€»æ˜¯ä»ç‰¹å¾å·¥ç¨‹å¼€å§‹ï¼Œç„¶åæ‰æ„å»ºæœºå™¨å­¦ä¹ æ¨¡å‹ã€‚å› æ­¤ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªFeatureEngineerç±»ï¼Œç”¨äºå¤„ç†ç‰¹å¾å·¥ç¨‹ã€‚
```python
class FeatureEngineer:
    def __init__(self, use_technical_indicator=True, tech_indicator_list=None):
        self.use_technical_indicator = use_technical_indicator
        self.tech_indicator_list = tech_indicator_list or [
            'macd', 'rsi', 'sma', 'bbands'
        ]

    def preprocess_data(self, df):
        df_reset = df.reset_index()

        processed_stocks = []

        for asset in df_reset["asset"].unique():
            stock_data = df_reset[df_reset["asset"] == asset].copy().sort_values('date')

            close = stock_data['close'].values.astype(float)

            if 'macd' in self.tech_indicator_list:
                macd, macd_signal, macd_hist = talib.MACD(close)
                stock_data['macd'] = macd
                stock_data['macd_signal'] = macd_signal
                stock_data['macd_hist'] = macd_hist

            if 'rsi' in self.tech_indicator_list:
                stock_data['rsi_14'] = talib.RSI(close, timeperiod=14)

            if 'sma' in self.tech_indicator_list:
                stock_data['close_20_sma'] = talib.SMA(close, timeperiod=20)

            if 'bbands' in self.tech_indicator_list:
                bb_upper, bb_middle, bb_lower = talib.BBANDS(close, timeperiod=20)
                stock_data['boll_ub'] = bb_upper
                stock_data['boll_lb'] = bb_lower
                stock_data['boll_middle'] = bb_middle

            # æ·»åŠ åŸºç¡€æŒ‡æ ‡
            stock_data['returns'] = stock_data['close'].pct_change()
            stock_data['log_volume'] = np.log(stock_data['volume'] + 1)

            processed_stocks.append(stock_data)

        df_processed = pd.concat(processed_stocks, ignore_index=True)

        # åˆ é™¤åŒ…å«NaNçš„è¡Œ
        before_count = len(df_processed)
        df_processed = df_processed.dropna().reset_index(drop=True)
        after_count = len(df_processed)

        print(f"âœ… æŠ€æœ¯æŒ‡æ ‡è®¡ç®—å®Œæˆ: {before_count} -> {after_count} æ¡è®°å½•")

        # æ˜¾ç¤ºæ–°å¢çš„åˆ—
        original_cols = df.reset_index().columns
        new_columns = [col for col in df_processed.columns if col not in original_cols]
        print(f"æ–°å¢æŒ‡æ ‡: {new_columns}")

        df_processed = df_processed.set_index(['date', "asset"]).sort_index()

        return df_processed
```
ä¸ºäº†è¿›è¡Œè®­ç»ƒï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ•°æ®é›†è¿›è¡Œtrain/teståˆ’åˆ†ã€‚åœ¨PPOå¼ºåŒ–å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡æ¯”ä¾‹æ¥åˆ’åˆ†æ•°æ®ï¼Œç¡®ä¿æ—¶é—´åºåˆ—çš„è¿ç»­æ€§ï¼š

```python
def split_data_by_ratio(df, train_ratio=0.8, test_ratio=0.2):
    """
    æŒ‰æ¯”ä¾‹åˆ’åˆ†æ•°æ®é›†ä¸ºè®­ç»ƒé›†å’Œæµ‹è¯•é›†

    Args:
        df: è¾“å…¥çš„DataFrameï¼Œå¿…é¡»æœ‰dateå’Œassetçš„åŒé‡ç´¢å¼•
        train_ratio: è®­ç»ƒé›†æ¯”ä¾‹
        test_ratio: æµ‹è¯•é›†æ¯”ä¾‹

    Returns:
        tuple: (train_data, test_data)
    """
    # éªŒè¯æ¯”ä¾‹æ€»å’Œ
    if abs(train_ratio + test_ratio - 1.0) > 1e-6:
        raise ValueError(f"æ¯”ä¾‹æ€»å’Œå¿…é¡»ä¸º1.0ï¼Œå½“å‰ä¸º: {train_ratio + test_ratio}")

    # è·å–æ‰€æœ‰å”¯ä¸€æ—¥æœŸå¹¶æ’åº
    all_dates = sorted(df.index.get_level_values('date').unique())
    total_days = len(all_dates)

    # è®¡ç®—åˆ†å‰²ç‚¹
    train_end_idx = int(total_days * train_ratio)

    # åˆ†å‰²æ—¥æœŸ
    train_dates = all_dates[:train_end_idx]
    test_dates = all_dates[train_end_idx:]

    print(f"ğŸ“… æ•°æ®åˆ’åˆ†ä¿¡æ¯:")
    print(f"   æ€»äº¤æ˜“æ—¥æ•°: {total_days}")
    print(f"   è®­ç»ƒé›†: {len(train_dates)} å¤© ({len(train_dates)/total_days:.1%})")
    print(f"   æµ‹è¯•é›†: {len(test_dates)} å¤© ({len(test_dates)/total_days:.1%})")
    print(f"   è®­ç»ƒæœŸé—´: {train_dates[0]} è‡³ {train_dates[-1]}")
    print(f"   æµ‹è¯•æœŸé—´: {test_dates[0]} è‡³ {test_dates[-1]}")

    # æŒ‰æ—¥æœŸç­›é€‰æ•°æ®
    train_data = df[df.index.get_level_values('date').isin(train_dates)].copy()
    test_data = df[df.index.get_level_values('date').isin(test_dates)].copy()

    # è·å–ä¸¤ä¸ªæ•°æ®é›†ä¸­éƒ½å­˜åœ¨çš„è‚¡ç¥¨
    train_assets = set(train_data.index.get_level_values('asset').unique())
    test_assets = set(test_data.index.get_level_values('asset').unique())

    # æ‰¾åˆ°ä¸¤ä¸ªæ•°æ®é›†çš„äº¤é›†
    common_assets = train_assets.intersection(test_assets)

    if len(common_assets) < len(train_assets):
        print(f"âš ï¸ åŸå§‹æ•°æ®é›†è‚¡ç¥¨æ•°é‡ä¸ä¸€è‡´ï¼Œä½¿ç”¨å…±åŒè‚¡ç¥¨")
        print(f"   è®­ç»ƒé›†: {len(train_assets)} åªè‚¡ç¥¨")
        print(f"   æµ‹è¯•é›†: {len(test_assets)} åªè‚¡ç¥¨")
        print(f"   å…±åŒè‚¡ç¥¨: {len(common_assets)} åª")

        # è¿‡æ»¤æ•°æ®ï¼Œåªä¿ç•™å…±åŒçš„è‚¡ç¥¨
        train_data = train_data[train_data.index.get_level_values('asset').isin(common_assets)]
        test_data = test_data[test_data.index.get_level_values('asset').isin(common_assets)]

    # æœ€ç»ˆéªŒè¯
    final_train_assets = len(train_data.index.get_level_values('asset').unique())
    final_test_assets = len(test_data.index.get_level_values('asset').unique())

    if final_train_assets != final_test_assets:
        raise ValueError(f"æ•°æ®åˆ’åˆ†åè‚¡ç¥¨æ•°é‡ä¸ä¸€è‡´: è®­ç»ƒ{final_train_assets}, æµ‹è¯•{final_test_assets}")

    print(f"\nâœ… æ•°æ®åˆ’åˆ†å®Œæˆ:")
    print(f"   ğŸ“ˆ è®­ç»ƒæ•°æ®: {train_data.shape} ({final_train_assets} åªè‚¡ç¥¨)")
    print(f"   ğŸ“Š æµ‹è¯•æ•°æ®: {test_data.shape} ({final_test_assets} åªè‚¡ç¥¨)")

    return train_data, test_data


# åˆ›å»ºç‰¹å¾å·¥ç¨‹å™¨
fe = FeatureEngineer(
    use_technical_indicator=True,
    tech_indicator_list=['macd', 'rsi', 'sma', 'bbands']
)

# è·å–æ•°æ®å¹¶å¤„ç†ç‰¹å¾
raw_data = load_bars(DATA_START_DATE, DATA_END_DATE, N_STOCKS)
processed_data = fe.preprocess_data(raw_data)

# éªŒè¯å¤„ç†åçš„æ•°æ®
if processed_data.empty:
    raise ValueError("æ•°æ®å¤„ç†åä¸ºç©ºï¼Œè¯·æ£€æŸ¥æŠ€æœ¯æŒ‡æ ‡è®¡ç®—")

# æŒ‰æ¯”ä¾‹åˆ’åˆ†æ•°æ®é›†
train_data, test_data = split_data_by_ratio(
    processed_data,
    train_ratio=TRAIN_RATIO,
    test_ratio=TEST_RATIO
)

# æ˜¾ç¤ºå¤„ç†åçš„æ•°æ®æ ·ä¾‹
print("\nå¤„ç†åçš„æ•°æ®é¢„è§ˆ:")
print(train_data.head())
```
### å®šä¹‰ç¯å¢ƒ

é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬è¦å®šä¹‰ç¯å¢ƒå’ŒAgentï¼Œä½†æ˜¯ï¼Œåœ¨ä½¿ç”¨SB3ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨PPOæ¨¡å‹ï¼Œä»è€Œæ— é¡»å®šä¹‰Agentï¼Œå› ä¸ºPPOæœ¬èº«å°±æ˜¯Agentï¼Œæ‰€ä»¥ï¼ŒAgentçš„å®šä¹‰å’Œæ¨¡å‹è®­ç»ƒæ˜¯ä¸€ä½“çš„ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬å…ˆç”¨gymæ¥å®šä¹‰ç¯å¢ƒï¼š
```python
import gymnasium as gym
from gymnasium import spaces

class StockTradingEnv(gym.Env):
    """
    åŸºäºGymnasiumçš„è‚¡ç¥¨äº¤æ˜“ç¯å¢ƒï¼Œé€‚é…åŒé‡ç´¢å¼•DataFrame

    åŠ¨ä½œç©ºé—´: è¿ç»­åŠ¨ä½œï¼Œæ¯åªè‚¡ç¥¨çš„ä¹°å–æ¯”ä¾‹ [-1, 1]
    çŠ¶æ€ç©ºé—´: [ç°é‡‘æ¯”ä¾‹, æŒä»“æ¯”ä¾‹..., æŠ€æœ¯æŒ‡æ ‡...]
    """

    def __init__(self, data, initial_amount=100000, transaction_cost=0.001):
        super().__init__()

        self.data = data.copy()
        self.initial_amount = initial_amount
        self.transaction_cost = transaction_cost

        # è·å–è‚¡ç¥¨åˆ—è¡¨å’Œæ—¥æœŸ
        self.stock_list = sorted(data.index.get_level_values('asset').unique())
        self.dates = sorted(data.index.get_level_values('date').unique())
        self.data_reset = data.reset_index()

        self.stock_dim = len(self.stock_list)

        # æŠ€æœ¯æŒ‡æ ‡åˆ—è¡¨
        self.tech_indicators = ['macd', 'rsi_14', 'close_20_sma', 'boll_ub', 'boll_lb']

        # å®šä¹‰åŠ¨ä½œå’Œè§‚å¯Ÿç©ºé—´
        # åŠ¨ä½œ: æ¯åªè‚¡ç¥¨çš„ä¹°å–æ¯”ä¾‹ [-1, 1]
        self.action_space = spaces.Box(
            low=-1, high=1, shape=(self.stock_dim,), dtype=np.float32
        )

        # è§‚å¯Ÿç©ºé—´: [ç°é‡‘æ¯”ä¾‹] + [æŒä»“æ¯”ä¾‹...] + [æŠ€æœ¯æŒ‡æ ‡...]
        obs_dim = 1 + self.stock_dim + len(self.tech_indicators) * self.stock_dim
        self.observation_space = spaces.Box(
            low=-np.inf, high=np.inf, shape=(obs_dim,), dtype=np.float32
        )

        print(f"ğŸ—ï¸  ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ:")
        print(f"   è‚¡ç¥¨æ•°é‡: {self.stock_dim}")
        print(f"   äº¤æ˜“æ—¥æ•°: {len(self.dates)}")
        print(f"   åŠ¨ä½œç»´åº¦: {self.action_space.shape}")
        print(f"   çŠ¶æ€ç»´åº¦: {self.observation_space.shape}")

        self.reset()
    
    def reset(self, seed=None, options=None):
        super().reset(seed=seed)
        
        self.day = 0
        self.cash = self.initial_amount
        self.holdings = np.zeros(self.stock_dim)
        self.portfolio_value = self.initial_amount
        self.portfolio_history = [self.initial_amount]
        
        observation = self._get_observation()
        info = {}
        
        return observation, info
    
    def step(self, actions):
        # æ£€æŸ¥æ˜¯å¦ç»“æŸ
        if self.day >= len(self.dates) - 1:
            return self._get_observation(), 0, True, True, {}

        # è·å–å½“å‰ä»·æ ¼ - æ·»åŠ é”™è¯¯å¤„ç†
        current_date = self.dates[self.day]
        current_data = self.data_reset[self.data_reset["date"] == current_date]

        if current_data.empty:
            print(f"è­¦å‘Šï¼šæ—¥æœŸ {current_date} æ²¡æœ‰æ•°æ®ï¼Œè·³è¿‡äº¤æ˜“")
            self.day += 1
            return self._get_observation(), 0, self.day >= len(self.dates) - 1, False, {
                'portfolio_value': self.portfolio_value,
                'cash': self.cash,
                'holdings': self.holdings.copy()
            }

        prices = []
        for stock in self.stock_list:
            stock_data = current_data[current_data["asset"] == stock]
            if not stock_data.empty and 'close' in stock_data.columns:
                prices.append(stock_data['close'].iloc[0])
            else:
                prices.append(0)  # å¦‚æœæ²¡æœ‰ä»·æ ¼æ•°æ®ï¼Œä½¿ç”¨0
        prices = np.array(prices)

        # æ‰§è¡Œäº¤æ˜“
        self._execute_trades(actions, prices)

        # ç§»åŠ¨åˆ°ä¸‹ä¸€å¤©
        self.day += 1

        # è®¡ç®—æ–°çš„æŠ•èµ„ç»„åˆä»·å€¼
        if self.day < len(self.dates):
            next_date = self.dates[self.day]
            next_data = self.data_reset[self.data_reset["date"] == next_date]

            if not next_data.empty:
                next_prices = []
                for stock in self.stock_list:
                    stock_data = next_data[next_data["asset"] == stock]
                    if not stock_data.empty and 'close' in stock_data.columns:
                        next_prices.append(stock_data['close'].iloc[0])
                    else:
                        next_prices.append(0)
                next_prices = np.array(next_prices)
                new_portfolio_value = self.cash + np.sum(self.holdings * next_prices)
            else:
                new_portfolio_value = self.cash + np.sum(self.holdings * prices)
        else:
            new_portfolio_value = self.cash + np.sum(self.holdings * prices)

        # è®¡ç®—å¥–åŠ±
        reward = (new_portfolio_value - self.portfolio_value) / self.portfolio_value if self.portfolio_value > 0 else 0
        self.portfolio_value = new_portfolio_value
        self.portfolio_history.append(self.portfolio_value)

        # æ£€æŸ¥æ˜¯å¦ç»“æŸ
        terminated = self.day >= len(self.dates) - 1
        truncated = False

        info = {
            'portfolio_value': self.portfolio_value,
            'cash': self.cash,
            'holdings': self.holdings.copy()
        }

        return self._get_observation(), reward, terminated, truncated, info
    
    def _execute_trades(self, actions, prices):
        """
        æ‰§è¡Œäº¤æ˜“åŠ¨ä½œ
        """
        # è®¡ç®—ç›®æ ‡æŒä»“ä»·å€¼
        total_value = self.cash + np.sum(self.holdings * prices)
        
        for i, action in enumerate(actions):
            if abs(action) < 0.01:  # å¿½ç•¥å¾ˆå°çš„åŠ¨ä½œ
                continue
                
            current_value = self.holdings[i] * prices[i]
            target_value = total_value * max(0, action)  # åªå…è®¸æ­£æŒä»“
            trade_value = target_value - current_value
            
            if trade_value > 0:  # ä¹°å…¥
                cost = trade_value * (1 + self.transaction_cost)
                if cost <= self.cash:
                    shares_to_buy = trade_value / prices[i]
                    self.holdings[i] += shares_to_buy
                    self.cash -= cost
            elif trade_value < 0:  # å–å‡º
                shares_to_sell = abs(trade_value) / prices[i]
                if shares_to_sell <= self.holdings[i]:
                    self.holdings[i] -= shares_to_sell
                    self.cash += abs(trade_value) * (1 - self.transaction_cost)
    
    def _get_observation(self):
        """
        è·å–å½“å‰çŠ¶æ€è§‚å¯Ÿ
        """
        if self.day >= len(self.dates):
            # è¿”å›æœ€åä¸€å¤©çš„è§‚å¯Ÿ
            self.day = len(self.dates) - 1

        current_date = self.dates[self.day]
        current_data = self.data_reset[self.data_reset["date"] == current_date]

        # éªŒè¯å½“å‰æ—¥æœŸæ˜¯å¦æœ‰æ•°æ®
        if current_data.empty:
            print(f"è­¦å‘Šï¼šæ—¥æœŸ {current_date} æ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é›¶å€¼è§‚å¯Ÿ")
            # è¿”å›é›¶å€¼è§‚å¯Ÿ
            obs_dim = 1 + self.stock_dim + len(self.tech_indicators) * self.stock_dim
            return np.zeros(obs_dim, dtype=np.float32)

        # ç°é‡‘æ¯”ä¾‹
        cash_ratio = self.cash / self.portfolio_value if self.portfolio_value > 0 else 0

        # æŒä»“æ¯”ä¾‹ - æ·»åŠ é”™è¯¯å¤„ç†
        prices = []
        for stock in self.stock_list:
            stock_data = current_data[current_data["asset"] == stock]
            if not stock_data.empty and 'close' in stock_data.columns:
                prices.append(stock_data['close'].iloc[0])
            else:
                print(f"è­¦å‘Šï¼šè‚¡ç¥¨ {stock} åœ¨æ—¥æœŸ {current_date} æ²¡æœ‰ä»·æ ¼æ•°æ®ï¼Œä½¿ç”¨0")
                prices.append(0)

        prices = np.array(prices)
        holdings_value = self.holdings * prices
        holdings_ratio = holdings_value / self.portfolio_value if self.portfolio_value > 0 else np.zeros_like(holdings_value)

        # æŠ€æœ¯æŒ‡æ ‡ - æ·»åŠ é”™è¯¯å¤„ç†
        tech_values = []
        for stock in self.stock_list:
            stock_data = current_data[current_data["asset"] == stock]
            for indicator in self.tech_indicators:
                if not stock_data.empty and indicator in stock_data.columns:
                    try:
                        value = stock_data[indicator].iloc[0]
                        # æ ‡å‡†åŒ–æŠ€æœ¯æŒ‡æ ‡
                        if indicator == 'rsi_14':
                            value = (value - 50) / 50  # RSIæ ‡å‡†åŒ–åˆ°[-1, 1]
                        elif 'macd' in indicator:
                            value = np.tanh(value / 100)  # MACDä½¿ç”¨tanhæ ‡å‡†åŒ–
                        else:
                            close_price = stock_data['close'].iloc[0] if 'close' in stock_data.columns else 1
                            value = np.tanh(value / close_price) if close_price != 0 else 0
                        tech_values.append(value if not np.isnan(value) else 0)
                    except (IndexError, KeyError):
                        tech_values.append(0)
                else:
                    tech_values.append(0)

        # ç»„åˆè§‚å¯Ÿå‘é‡
        observation = np.concatenate([
            [cash_ratio],
            holdings_ratio,
            tech_values
        ])

        return observation.astype(np.float32)

# åˆ›å»ºç¯å¢ƒå‰å…ˆéªŒè¯æ•°æ®
print("ğŸ” éªŒè¯æ•°æ®ç»“æ„...")
print(f"è®­ç»ƒæ•°æ®å½¢çŠ¶: {train_data.shape}")
print(f"æµ‹è¯•æ•°æ®å½¢çŠ¶: {test_data.shape}")

print(f"è®­ç»ƒæ•°æ® - è‚¡ç¥¨æ•°é‡: {len(train_data.index.get_level_values('asset').unique())}")
print(f"è®­ç»ƒæ•°æ® - æ—¥æœŸæ•°é‡: {len(train_data.index.get_level_values('date').unique())}")
print(f"æµ‹è¯•æ•°æ® - è‚¡ç¥¨æ•°é‡: {len(test_data.index.get_level_values('asset').unique())}")
print(f"æµ‹è¯•æ•°æ® - æ—¥æœŸæ•°é‡: {len(test_data.index.get_level_values('date').unique())}")

# åˆ›å»ºç¯å¢ƒ
print("\nğŸ—ï¸  åˆ›å»ºäº¤æ˜“ç¯å¢ƒ...")

train_env = StockTradingEnv(train_data, initial_amount=100000)
print("âœ… è®­ç»ƒç¯å¢ƒåˆ›å»ºæˆåŠŸ")

test_env = StockTradingEnv(test_data, initial_amount=100000)
print("âœ… æµ‹è¯•ç¯å¢ƒåˆ›å»ºæˆåŠŸ")

print("\nâœ… ç¯å¢ƒåˆ›å»ºå®Œæˆï¼")

# æµ‹è¯•ç¯å¢ƒé‡ç½®
print("\nğŸ”„ æµ‹è¯•ç¯å¢ƒé‡ç½®...")
train_obs, _ = train_env.reset()
print(f"è®­ç»ƒç¯å¢ƒè§‚å¯Ÿå‘é‡å½¢çŠ¶: {train_obs.shape}")

test_obs, _ = test_env.reset()
print(f"æµ‹è¯•ç¯å¢ƒè§‚å¯Ÿå‘é‡å½¢çŠ¶: {test_obs.shape}")
```
## å®šä¹‰AgentåŠè®­ç»ƒ
```python
from stable_baselines3 import PPO

model = PPO(
    "MlpPolicy",
    train_env,
    verbose=1,
    learning_rate=0.0003,
    n_steps=2048,
    batch_size=64,
    n_epochs=10,
    gamma=0.99,
    gae_lambda=0.95,
    clip_range=0.2,
    ent_coef=0.01,
    vf_coef=0.5,
    max_grad_norm=0.5,
    seed=42
)

print("ğŸš€ å¼€å§‹è®­ç»ƒ...")
model.learn(total_timesteps=10000, progress_bar=True)
print("âœ… è®­ç»ƒå®Œæˆï¼")

# ä¿å­˜æ¨¡å‹
# model.save("ppo_trading_model")
```
### å›æµ‹ä¸ç»“æœ

ç°åœ¨ï¼Œæˆ‘ä»¬å¼€å§‹å›æµ‹ï¼Œå¹¶ä½¿ç”¨quantstatsç”Ÿæˆæ ‡å‡†åŒ–çš„æŠ•èµ„ç»„åˆåˆ†ææŠ¥è¡¨ã€‚
```python
import quantstats as qs
import matplotlib.pyplot as plt

print("ğŸ“Š å¼€å§‹å›æµ‹...")
obs, _ = test_env.reset()
done = False
total_reward = 0
step_count = 0
portfolio_values = []
dates = []


test_dates = sorted(test_data.index.get_level_values('date').unique())

while not done:
    action, _ = model.predict(obs, deterministic=True)
    obs, reward, terminated, truncated, info = test_env.step(action)
    done = terminated or truncated
    total_reward += reward
    portfolio_values.append(info['portfolio_value'])

    # è®°å½•å¯¹åº”çš„æ—¥æœŸ
    if step_count < len(test_dates):
        dates.append(test_dates[step_count])

    step_count += 1

    if step_count % 20 == 0:
        print(f"æ­¥éª¤ {step_count}: æŠ•èµ„ç»„åˆä»·å€¼ = Â¥{info['portfolio_value']:,.2f}")

print(f"\nğŸ“ˆ å›æµ‹å®Œæˆ!")
print(f"æ€»æ­¥æ•°: {step_count}")
print(f"æ€»å¥–åŠ±: {total_reward:.4f}")
print(f"æœ€ç»ˆæŠ•èµ„ç»„åˆä»·å€¼: Â¥{portfolio_values[-1]:,.2f}")
print(f"æ€»æ”¶ç›Šç‡: {(portfolio_values[-1] / 100000 - 1) * 100:.2f}%")

# åˆ›å»ºæŠ•èµ„ç»„åˆæ”¶ç›Šç‡åºåˆ—
portfolio_df = pd.DataFrame({
    'date': dates[:len(portfolio_values)],
    'portfolio_value': portfolio_values
})
portfolio_df['date'] = pd.to_datetime(portfolio_df['date'])
portfolio_df.set_index('date', inplace=True)

# è®¡ç®—æ¯æ—¥æ”¶ç›Šç‡
portfolio_returns = portfolio_df['portfolio_value'].pct_change().dropna()

# ä½¿ç”¨quantstatsç”Ÿæˆå®Œæ•´çš„æŠ•èµ„ç»„åˆåˆ†ææŠ¥è¡¨
print("\nğŸ“Š ç”ŸæˆQuantStatsåˆ†ææŠ¥è¡¨...")

# è®¾ç½®quantstatsçš„è¾“å‡ºæ¨¡å¼
qs.extend_pandas()

# åœ¨notebookä¸­æ˜¾ç¤ºå…³é”®æŒ‡æ ‡
print("\n=== æŠ•èµ„ç»„åˆç»©æ•ˆåˆ†æ ===")
print(f"æ€»æ”¶ç›Šç‡: {qs.stats.comp(portfolio_returns):.2%}")
print(f"å¹´åŒ–æ”¶ç›Šç‡: {qs.stats.cagr(portfolio_returns):.2%}")
print(f"å¹´åŒ–æ³¢åŠ¨ç‡: {qs.stats.volatility(portfolio_returns):.2%}")
print(f"å¤æ™®æ¯”ç‡: {qs.stats.sharpe(portfolio_returns):.3f}")
print(f"æœ€å¤§å›æ’¤: {qs.stats.max_drawdown(portfolio_returns):.2%}")
print(f"å¡å°”é©¬æ¯”ç‡: {qs.stats.calmar(portfolio_returns):.3f}")
print(f"èƒœç‡: {qs.stats.win_rate(portfolio_returns):.2%}")
```




æ€»è€Œè¨€ä¹‹ï¼Œå¼ºåŒ–å­¦ä¹ ä¸ºé‡åŒ–äº¤æ˜“æ‰“å¼€äº†ä¸€æ‰‡é€šå¾€æ›´é«˜ç»´åº¦æ™ºèƒ½çš„å¤§é—¨ã€‚å®ƒä¸å†æ˜¯è®©æœºå™¨æ¨¡ä»¿äººç±»ï¼Œè€Œæ˜¯è®©æœºå™¨åœ¨æ¨¡æ‹Ÿçš„å¸‚åœºä¸­è‡ªæˆ‘è¿›åŒ–ã€è‡ªæˆ‘åšå¼ˆï¼Œæœ€ç»ˆä¹ å¾—è¶…è¶Šäººç±»ç›´è§‰çš„äº¤æ˜“æ™ºæ…§ã€‚è¿™æ¡è·¯å……æ»¡æŒ‘æˆ˜ï¼Œä½†ä¹ŸåŒæ ·å……æ»¡æœºé‡ã€‚é‚£ä¹ˆï¼Œä½ å‡†å¤‡å¥½ï¼Œè®©ä½ çš„ç¬¬ä¸€ä¸ªäº¤æ˜“Agentï¼Œå¼€å§‹å®ƒçš„"è¿›åŒ–ä¹‹æ—…"äº†å—ï¼Ÿ

---
1. LOXM: https://www.businessinsider.com/jpmorgan-takes-ai-use-to-the-next-level-2017-8
2. é‡åŒ–äº¤æ˜“ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼šhttps://dl.acm.org/doi/10.1145/3582560
3. Alphastockï¼Œä¸€ä¸ªè¿½æ¶¨æ€è·Œæ¨¡å‹: https://arxiv.org/abs/1908.02646


---
**æ³¨æ„äº‹é¡¹ï¼š**
1. åœ¨è®­ç»ƒæ—¶ï¼Œç»„åˆä½¿ç”¨å¤šå°‘ä¸ªèµ„äº§ï¼Œåœ¨é¢„æµ‹æ—¶ï¼Œå°±åªèƒ½ä½¿ç”¨å¤šå°‘ä¸ªèµ„äº§ã€‚
2. è¿™é‡Œéœ€è¦quantstatsï¼Œæ³¨æ„å®ƒåœ¨python 3.12ä¸‹å®Œå…¨ä¸èƒ½è¿è¡Œï¼Œä½ éœ€è¦å®‰è£…quantideç»´æŠ¤å‘å¸ƒçš„quanstats-reloadedç‰ˆæœ¬ã€‚
3. æ•°æ®é›†å·²æŒ‰8:2æ¯”ä¾‹åˆ’åˆ†ä¸ºtrain/testä¸¤éƒ¨åˆ†ï¼ŒPPOç®—æ³•é€šè¿‡è®­ç»ƒè¿‡ç¨‹ä¸­çš„å¥–åŠ±æ›²çº¿æ¥ç›‘æ§å­¦ä¹ è¿›åº¦ã€‚
